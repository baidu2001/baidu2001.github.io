<!DOCTYPE html>
<html lang="zh-CN">
<head>

  <!--pjax：防止跳转页面音乐暂停-->
  <script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":300,"display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ELK搜索高级课程1． 课程简介1.1 课程内容ELK是包含但不限于Elasticsearch（简称es）、Logstash、Kibana 三个开源软件的组成的一个整体。这三个软件合成ELK。是用于数据抽取（Logstash）、搜索分析（Elasticsearch）、数据展现（Kibana）的一整套解决方案，所以也称作ELK stack。 本课程从分别对三个组件经行详细介绍，尤其是Elastics">
<meta property="og:type" content="article">
<meta property="og:title" content="白都">
<meta property="og:url" content="http://example.com/2022/11/10/%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="白都">
<meta property="og:description" content="ELK搜索高级课程1． 课程简介1.1 课程内容ELK是包含但不限于Elasticsearch（简称es）、Logstash、Kibana 三个开源软件的组成的一个整体。这三个软件合成ELK。是用于数据抽取（Logstash）、搜索分析（Elasticsearch）、数据展现（Kibana）的一整套解决方案，所以也称作ELK stack。 本课程从分别对三个组件经行详细介绍，尤其是Elastics">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/1567691051440.png">
<meta property="og:image" content="http://example.com/img/1567691098941.png">
<meta property="og:image" content="http://example.com/img/1567691213668.png">
<meta property="og:image" content="http://example.com/img/1567696557762.png">
<meta property="og:image" content="http://example.com/img/1567696574236.png">
<meta property="og:image" content="http://example.com/img/1567696692347.png">
<meta property="og:image" content="http://example.com/img/1567696700718.png">
<meta property="og:image" content="http://example.com/img/1567696712256.png">
<meta property="og:image" content="http://example.com/img/1567696843304.png">
<meta property="og:image" content="http://example.com/img/1568622526251.png">
<meta property="og:image" content="http://example.com/img/1568622589010.png">
<meta property="og:image" content="http://example.com/img/1568622607418.png">
<meta property="og:image" content="http://example.com/img/1568622619503.png">
<meta property="og:image" content="http://example.com/img/1568622671957.png">
<meta property="og:image" content="http://example.com/img/1568622683707.png">
<meta property="og:image" content="http://example.com/img/1568627572838.png">
<meta property="og:image" content="http://example.com/img/1568627617789.png">
<meta property="og:image" content="http://example.com/img/1568632608676.png">
<meta property="og:image" content="http://example.com/img/1568632860925.png">
<meta property="og:image" content="http://example.com/img/1568632872820.png">
<meta property="og:image" content="http://example.com/img/1568632881931.png">
<meta property="og:image" content="http://example.com/img/1568632895254.png">
<meta property="og:image" content="http://example.com/img/1568978200919.png">
<meta property="og:image" content="http://example.com/img/1568989192034.png">
<meta property="og:image" content="http://example.com/img/1568990520717.png">
<meta property="og:image" content="http://example.com/img/1569123478530.png">
<meta property="og:image" content="http://example.com/img/1571494142950.png">
<meta property="og:image" content="http://example.com/img/1571494159465.png">
<meta property="og:image" content="http://example.com/img/1571494176760.png">
<meta property="og:image" content="http://example.com/img/1573212830146.png">
<meta property="og:image" content="http://example.com/img/1573291947262.png">
<meta property="article:published_time" content="2022-11-10T08:08:40.446Z">
<meta property="article:modified_time" content="2022-11-10T08:08:41.155Z">
<meta property="article:author" content="白都">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/1567691051440.png">

<link rel="canonical" href="http://example.com/2022/11/10/%E7%AC%94%E8%AE%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title> | 白都</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">白都</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">linBaiDu</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>

  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/yourname" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/10/%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="白都">
      <meta itemprop="description" content="这是我的个人知识技术总结博客，欢迎大家的到来，博客会慢慢更新。 ------------有问题请通过邮箱2653751429@qq.com联系，评论功能是不会开启的。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="白都">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-10 16:08:40 / 修改时间：16:08:41" itemprop="dateCreated datePublished" datetime="2022-11-10T16:08:40+08:00">2022-11-10</time>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="ELK搜索高级课程"><a href="#ELK搜索高级课程" class="headerlink" title="ELK搜索高级课程"></a>ELK搜索高级课程</h1><h1 id="1．-课程简介"><a href="#1．-课程简介" class="headerlink" title="1． 课程简介"></a>1． 课程简介</h1><h2 id="1-1-课程内容"><a href="#1-1-课程内容" class="headerlink" title="1.1 课程内容"></a>1.1 课程内容</h2><p>ELK是包含但不限于Elasticsearch（简称es）、Logstash、Kibana 三个开源软件的组成的一个整体。这三个软件合成ELK。是用于数据抽取（Logstash）、搜索分析（Elasticsearch）、数据展现（Kibana）的一整套解决方案，所以也称作ELK stack。</p>
<p>本课程从分别对三个组件经行详细介绍，尤其是Elasticsearch，因为它是elk的核心。本课程从es底层对文档、索引、搜索、聚合、集群经行介绍，从搜索和聚合分析实例来展现es的魅力。Logstash从内部如何采集数据到指定地方来展现它数据采集的功能。Kibana则从数据绘图展现数据可视化的功能。</p>
<h2 id="1-2-面向人员"><a href="#1-2-面向人员" class="headerlink" title="1.2 面向人员"></a>1.2 面向人员</h2><ul>
<li>java工程师：深入研究es,使得java工程师向搜索工程师迈进。</li>
<li>运维工程师：搭建整体elk集群。不需写代码，仅需配置，即可收集服务器指标、日志文件、数据库数据，并在前端华丽展现。</li>
<li>数据分析人员：不需写代码，仅需配置kibana图表，即可完成数据可视化工作，得到想要的数据图表。</li>
<li>大厂架构师：完成数据中台的搭建。对公司数据流的处理得心应手，对接本公司大数据业务。</li>
</ul>
<h2 id="1-3-课程优势"><a href="#1-3-课程优势" class="headerlink" title="1.3 课程优势"></a>1.3 课程优势</h2><ul>
<li><p>基于最新的elk7.3版本讲解。最新api。包含sql功能。</p>
</li>
<li><p>理论和实际代码相辅相成。理论结合画图讲解。代码与spring boot结合。</p>
</li>
<li><p>包含实际运维部署理论与实践。</p>
</li>
<li><p>Elk整体流程项目，包含数据采集。</p>
</li>
</ul>
<h2 id="1-4-学习路径"><a href="#1-4-学习路径" class="headerlink" title="1.4 学习路径"></a>1.4 学习路径</h2><p>参照目录，按照介绍，es入门，文档、映射、索引、分词器、搜索、聚合。logstash、kibana。集群部署。项目实战。</p>
<p>每个知识点先学概念，在学rest api,最后java代码上手。</p>
<h1 id="2．-Elastic-Stack简介"><a href="#2．-Elastic-Stack简介" class="headerlink" title="2． Elastic Stack简介"></a>2． Elastic Stack简介</h1><h2 id="2-1简介"><a href="#2-1简介" class="headerlink" title="2.1简介"></a>2.1简介</h2><p>ELK是一个免费开源的日志分析架构技术栈总称，官网<a target="_blank" rel="noopener" href="https://www.elastic.co/cn。包含三大基础组件，分别是Elasticsearch、Logstash、Kibana。但实际上ELK不仅仅适用于日志分析，它还可以支持其它任何数据搜索、分析和收集的场景，日志分析和收集只是更具有代表性。并非唯一性。下面是ELK架构：">https://www.elastic.co/cn。包含三大基础组件，分别是Elasticsearch、Logstash、Kibana。但实际上ELK不仅仅适用于日志分析，它还可以支持其它任何数据搜索、分析和收集的场景，日志分析和收集只是更具有代表性。并非唯一性。下面是ELK架构：</a></p>
<p><img src="/img/1567691051440.png" alt="1567691051440"></p>
<p>随着elk的发展，又有新成员Beats、elastic cloud的加入，所以就形成了Elastic Stack。所以说，ELK是旧的称呼，Elastic Stack是新的名字。</p>
<p><img src="/img/1567691098941.png" alt="1567691098941"></p>
<h2 id="2-2特色"><a href="#2-2特色" class="headerlink" title="2.2特色"></a>2.2特色</h2><ul>
<li><p>处理方式灵活：elasticsearch是目前最流行的准实时全文检索引擎，具有高速检索大数据的能力。</p>
</li>
<li><p>配置简单：安装elk的每个组件，仅需配置每个组件的一个配置文件即可。修改处不多，因为大量参数已经默认配在系统中，修改想要修改的选项即可。</p>
</li>
<li><p>接口简单：采用json形式RESTFUL API接受数据并响应，无关语言。</p>
</li>
<li><p>性能高效：elasticsearch基于优秀的全文搜索技术Lucene，采用倒排索引，可以轻易地在百亿级别数据量下，搜索出想要的内容，并且是秒级响应。</p>
</li>
<li><p>灵活扩展：elasticsearch和logstash都可以根据集群规模线性拓展，elasticsearch内部自动实现集群协作。</p>
</li>
<li><p>数据展现华丽：kibana作为前端展现工具，图表华丽，配置简单。</p>
</li>
</ul>
<h2 id="2-3组件介绍"><a href="#2-3组件介绍" class="headerlink" title="2.3组件介绍"></a>2.3组件介绍</h2><p><strong>Elasticsearch</strong></p>
<p>Elasticsearch 是使用java开发，基于Lucene、分布式、通过Restful方式进行交互的近实时搜索平台框架。它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p>
<p><strong>Logstash</strong></p>
<p>Logstash 基于java开发，是一个数据抽取转化工具。一般工作方式为c/s架构，client端安装在需要收集信息的主机上，server端负责将收到的各节点日志进行过滤、修改等操作在一并发往elasticsearch或其他组件上去。 </p>
<p><strong>Kibana</strong></p>
<p>Kibana 基于nodejs，也是一个开源和免费的可视化工具。Kibana可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以汇总、分析和搜索重要数据日志。</p>
<p><strong>Beats</strong></p>
<p>Beats 平台集合了多种单一用途数据采集器。它们从成百上千或成千上万台机器和系统向 Logstash 或 Elasticsearch 发送数据。</p>
<p>Beats由如下组成:</p>
<p>​    Packetbeat：轻量型网络数据采集器，用于深挖网线上传输的数据，了解应用程序动态。Packetbeat 是一款轻量型网络数据包分析器，能够将数据发送至 Logstash 或 Elasticsearch。其支 持ICMP (v4 and v6)、DNS、HTTP、Mysql、PostgreSQL、Redis、MongoDB、Memcache等协议。</p>
<p>​    Filebeat：轻量型日志采集器。当您要面对成百上千、甚至成千上万的服务器、虚拟机和容器生成的日志时，请告别 SSH 吧。Filebeat 将为您提供一种轻量型方法，用于转发和汇总日志与文件，让简单的事情不再繁杂。</p>
<p>​    Metricbeat ：轻量型指标采集器。Metricbeat 能够以一种轻量型的方式，输送各种系统和服务统计数据，从 CPU 到内存，从 Redis 到 Nginx，不一而足。可定期获取外部系统的监控指标信息，其可以监控、收集 Apache http、HAProxy、MongoDB、MySQL、Nginx、PostgreSQL、Redis、System、Zookeeper等服务。</p>
<p>​    Winlogbeat：轻量型 Windows 事件日志采集器。用于密切监控基于 Windows 的基础设施上发生的事件。Winlogbeat 能够以一种轻量型的方式，将 Windows 事件日志实时地流式传输至 Elasticsearch 和 Logstash。</p>
<p>​    Auditbeat：轻量型审计日志采集器。收集您 Linux 审计框架的数据，监控文件完整性。Auditbeat 实时采集这些事件，然后发送到 Elastic Stack 其他部分做进一步分析。</p>
<p>​    Heartbeat：面向运行状态监测的轻量型采集器。通过主动探测来监测服务的可用性。通过给定 URL 列表，Heartbeat 仅仅询问：网站运行正常吗？Heartbeat 会将此信息和响应时间发送至 Elastic 的其他部分，以进行进一步分析。</p>
<p>​    Functionbeat：面向云端数据的无服务器采集器。在作为一项功能部署在云服务提供商的功能即服务 (FaaS) 平台上后，Functionbeat 即能收集、传送并监测来自您的云服务的相关数据。</p>
<p><strong>Elastic cloud</strong></p>
<p>基于 Elasticsearch 的软件即服务(SaaS)解决方案。通过 Elastic 的官方合作伙伴使用托管的 Elasticsearch 服务。</p>
<p><img src="/img/1567691213668.png" alt="1567691213668"></p>
<h1 id="3．-Elasticsearch是什么"><a href="#3．-Elasticsearch是什么" class="headerlink" title="3． Elasticsearch是什么"></a>3． Elasticsearch是什么</h1><h2 id="3-1搜索是什么"><a href="#3-1搜索是什么" class="headerlink" title="3.1搜索是什么"></a>3.1搜索是什么</h2><p>概念：用户输入想要的关键词，返回含有该关键词的所有信息。</p>
<p>场景：</p>
<p>​    1互联网搜索：谷歌、百度、各种新闻首页</p>
<p>​    2 站内搜索（垂直搜索）：企业OA查询订单、人员、部门，电商网站内部搜索商品（淘宝、京东）场景。</p>
<h2 id="3-2-数据库做搜索弊端"><a href="#3-2-数据库做搜索弊端" class="headerlink" title="3.2 数据库做搜索弊端"></a>3.2 数据库做搜索弊端</h2><h3 id="3-2-1站内搜索（垂直搜索）：数据量小，简单搜索，可以使用数据库。"><a href="#3-2-1站内搜索（垂直搜索）：数据量小，简单搜索，可以使用数据库。" class="headerlink" title="3.2.1站内搜索（垂直搜索）：数据量小，简单搜索，可以使用数据库。"></a>3.2.1站内搜索（垂直搜索）：数据量小，简单搜索，可以使用数据库。</h3><p>问题出现：</p>
<p>l  存储问题。电商网站商品上亿条时，涉及到单表数据过大必须拆分表，数据库磁盘占用过大必须分库（mycat）。</p>
<p>l  性能问题：解决上面问题后，查询“笔记本电脑”等关键词时，上亿条数据的商品名字段逐行扫描，性能跟不上。</p>
<p>l  不能分词。如搜索“笔记本电脑”，只能搜索完全和关键词一样的数据，那么数据量小时，搜索“笔记电脑”，“电脑”数据要不要给用户。</p>
<h3 id="3-2-2互联网搜索，肯定不会使用数据库搜索。数据量太大。PB级。"><a href="#3-2-2互联网搜索，肯定不会使用数据库搜索。数据量太大。PB级。" class="headerlink" title="3.2.2互联网搜索，肯定不会使用数据库搜索。数据量太大。PB级。"></a>3.2.2互联网搜索，肯定不会使用数据库搜索。数据量太大。PB级。</h3><h2 id="3-3全文检索、倒排索引和Lucene"><a href="#3-3全文检索、倒排索引和Lucene" class="headerlink" title="3.3全文检索、倒排索引和Lucene"></a>3.3全文检索、倒排索引和Lucene</h2><h4 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a><strong>全文检索</strong></h4><p>倒排索引。数据存储时，经行分词建立term索引库。见画图。</p>
<p>倒排索引源于实际应用中需要根据属性的值来查找记录。这种索引表中的每一项都包括一个属性值和具有该属性值的各记录的地址。由于不是由记录来确定属性值，而是由属性值来确定记录的位置，因而称为倒排索引(inverted index)。带有倒排索引的文件我们称为倒排<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/索引文件">索引文件</a>，简称<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/倒排文件/4137688">倒排文件</a>(inverted file)。</p>
<h4 id="Lucene"><a href="#Lucene" class="headerlink" title="Lucene"></a>Lucene</h4><p>就是一个jar包，里面封装了全文检索的引擎、搜索的算法代码。开发时，引入lucen的jar包，通过api开发搜索相关业务。底层会在磁盘建立索引库。</p>
<h2 id="3-4-什么是Elasticsearch"><a href="#3-4-什么是Elasticsearch" class="headerlink" title="3.4 什么是Elasticsearch"></a>3.4 什么是Elasticsearch</h2><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p><img src="/img/1567696557762.png" alt="1567696557762"></p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/products/elasticsearch">https://www.elastic.co/cn/products/elasticsearch</a></p>
<p><img src="/img/1567696574236.png" alt="1567696574236"></p>
<h4 id="Elasticsearch的功能"><a href="#Elasticsearch的功能" class="headerlink" title="Elasticsearch的功能"></a>Elasticsearch的功能</h4><ul>
<li>分布式的搜索引擎和数据分析引擎</li>
</ul>
<p>搜索：互联网搜索、电商网站站内搜索、OA系统查询</p>
<p>数据分析：电商网站查询近一周哪些品类的图书销售前十；新闻网站，最近3天阅读量最高的十个关键词，舆情分析。</p>
<ul>
<li>全文检索，结构化检索，数据分析</li>
</ul>
<p>全文检索：搜索商品名称包含java的图书select * from books where book_name like “%java%”。</p>
<p>结构化检索：搜索商品分类为spring的图书都有哪些，select * from books where category_id=’spring’</p>
<p>数据分析：分析每一个分类下有多少种图书，select category_id,count(*) from books group by category_id</p>
<ul>
<li>对海量数据进行近实时的处理</li>
</ul>
<p>分布式：ES自动可以将海量数据分散到多台服务器上去存储和检索,经行并行查询，提高搜索效率。相对的，Lucene是单机应用。</p>
<p>近实时：数据库上亿条数据查询，搜索一次耗时几个小时，是批处理（batch-processing）。而es只需秒级即可查询海量数据，所以叫近实时。秒级。</p>
<h4 id="Elasticsearch的使用场景"><a href="#Elasticsearch的使用场景" class="headerlink" title="Elasticsearch的使用场景"></a>Elasticsearch的使用场景</h4><p>国外：</p>
<ul>
<li><p>维基百科，类似百度百科，“网络七层协议”的维基百科，全文检索，高亮，搜索推荐</p>
</li>
<li><p>Stack Overflow（国外的程序讨论论坛），相当于程序员的贴吧。遇到it问题去上面发帖，热心网友下面回帖解答。</p>
</li>
<li><p>GitHub（开源代码管理），搜索上千亿行代码。</p>
</li>
<li><p>电商网站，检索商品</p>
</li>
<li><p>日志数据分析，logstash采集日志，ES进行复杂的数据分析（ELK技术，elasticsearch+logstash+kibana）</p>
</li>
<li><p>商品价格监控网站，用户设定某商品的价格阈值，当低于该阈值的时候，发送通知消息给用户，比如说订阅《java编程思想》的监控，如果价格低于27块钱，就通知我，我就去买。</p>
</li>
<li><p>BI系统，商业智能（Business Intelligence）。大型连锁超市，分析全国网点传回的数据，分析各个商品在什么季节的销售量最好、利润最高。成本管理，店面租金、员工工资、负债等信息进行分析。从而部署下一个阶段的战略目标。</p>
</li>
</ul>
<p>国内：</p>
<ul>
<li><p>百度搜索，第一次查询，使用es。</p>
</li>
<li><p>OA、ERP系统站内搜索。</p>
</li>
</ul>
<h4 id="Elasticsearch的特点"><a href="#Elasticsearch的特点" class="headerlink" title="Elasticsearch的特点"></a>Elasticsearch的特点</h4><ul>
<li><p>可拓展性：大型分布式集群（数百台服务器）技术，处理PB级数据，大公司可以使用。小公司数据量小，也可以部署在单机。大数据领域使用广泛。</p>
</li>
<li><p>技术整合：将全文检索、数据分析、分布式相关技术整合在一起：lucene（全文检索），商用的数据分析软件（BI软件），分布式数据库（mycat）</p>
</li>
<li><p>部署简单：开箱即用，很多默认配置不需关心，解压完成直接运行即可。拓展时，只需多部署几个实例即可，负载均衡、分片迁移集群内部自己实施。</p>
</li>
<li><p>接口简单：使用restful api经行交互，跨语言。</p>
</li>
<li><p>功能强大：Elasticsearch作为传统数据库的一个补充，提供了数据库所不不能提供的很多功能，如全文检索，同义词处理，相关度排名。</p>
</li>
</ul>
<p><img src="/img/1567696692347.png" alt="1567696692347"></p>
<p><img src="/img/1567696700718.png" alt="1567696700718"></p>
<p><img src="/img/1567696712256.png" alt="1567696712256"></p>
<h2 id="3-5-elasticsearch核心概念"><a href="#3-5-elasticsearch核心概念" class="headerlink" title="3.5 elasticsearch核心概念"></a>3.5 elasticsearch核心概念</h2><h3 id="3-5-1-lucene和elasticsearch的关系"><a href="#3-5-1-lucene和elasticsearch的关系" class="headerlink" title="3.5.1 lucene和elasticsearch的关系"></a>3.5.1 lucene和elasticsearch的关系</h3><p>Lucene：最先进、功能最强大的搜索库，直接基于lucene开发，非常复杂，api复杂</p>
<p>Elasticsearch：基于lucene，封装了许多lucene底层功能，提供简单易用的restful api接口和许多语言的客户端，如java的高级客户端（<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.3/java-rest-low.html">Java High Level REST Client</a>）和底层客户端（<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.3/java-rest-low.html">Java Low Level REST Client</a>）</p>
<p><img src="/img/1567696843304.png" alt="1567696843304"></p>
<p>起源：Shay Banon。2004年失业，陪老婆去伦敦学习厨师。失业在家帮老婆写一个菜谱搜索引擎。封装了lucene的开源项目，compass。找到工作后，做分布式高性能项目，再封装compass，写出了elasticsearch，使得lucene支持分布式。现在是Elasticsearch创始人兼Elastic首席执行官。</p>
<h3 id="3-5-2-elasticsearch的核心概念"><a href="#3-5-2-elasticsearch的核心概念" class="headerlink" title="3.5.2 elasticsearch的核心概念"></a>3.5.2 elasticsearch的核心概念</h3><h4 id="1-NRT（Near-Realtime）：近实时"><a href="#1-NRT（Near-Realtime）：近实时" class="headerlink" title="1 NRT（Near Realtime）：近实时"></a>1 NRT（Near Realtime）：近实时</h4><p>两方面：</p>
<ul>
<li><p>写入数据时，过1秒才会被搜索到，因为内部在分词、录入索引。</p>
</li>
<li><p>es搜索时：搜索和分析数据需要秒级出结果。</p>
</li>
</ul>
<h4 id="2-Cluster：集群"><a href="#2-Cluster：集群" class="headerlink" title="2 Cluster：集群"></a>2 Cluster：集群</h4><p>包含一个或多个启动着es实例的机器群。通常一台机器起一个es实例。同一网络下，集名一样的多个es实例自动组成集群，自动均衡分片等行为。默认集群名为“elasticsearch”。</p>
<h4 id="3-Node：节点"><a href="#3-Node：节点" class="headerlink" title="3 Node：节点"></a>3 Node：节点</h4><p>每个es实例称为一个节点。节点名自动分配，也可以手动配置。</p>
<h4 id="4-Index：索引"><a href="#4-Index：索引" class="headerlink" title="4 Index：索引"></a>4 Index：索引</h4><p>包含一堆有相似结构的文档数据。</p>
<p>索引创建规则：</p>
<ul>
<li><p>仅限小写字母</p>
</li>
<li><p>不能包含\、/、 *、?、”、&lt;、&gt;、|、#以及空格符等特殊符号</p>
</li>
<li><p>从7.0版本开始不再包含冒号</p>
</li>
<li><p>不能以-、_或+开头</p>
</li>
<li><p>不能超过255个字节（注意它是字节，因此多字节字符将计入255个限制）</p>
</li>
</ul>
<h4 id="5-Document：文档"><a href="#5-Document：文档" class="headerlink" title="5  Document：文档"></a>5  Document：文档</h4><p>es中的最小数据单元。一个document就像数据库中的一条记录。通常以json格式显示。多个document存储于一个索引（Index）中。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">book document</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;book_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;book_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java编程思想&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;book_desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;从Java的基础语法到最高级特性（深入的[面向对象](https://baike.baidu.com/item/面向对象)概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="6-Field-字段"><a href="#6-Field-字段" class="headerlink" title="6 Field:字段"></a>6 Field:字段</h4><p>就像数据库中的列（Columns），定义每个document应该有的字段。</p>
<h4 id="7-Type：类型"><a href="#7-Type：类型" class="headerlink" title="7 Type：类型"></a>7 Type：类型</h4><p>每个索引里都可以有一个或多个type，type是index中的一个逻辑数据分类，一个type下的document，都有相同的field。</p>
<p><strong>注意</strong>：6.0之前的版本有type（类型）概念，type相当于关系数据库的表，ES官方将在ES9.0版本中彻底删除type。本教程typy都为_doc。</p>
<h4 id="8-shard：分片"><a href="#8-shard：分片" class="headerlink" title="8 shard：分片"></a>8 shard：分片</h4><p>index数据过大时，将index里面的数据，分为多个shard，分布式的存储在各个服务器上面。可以支持海量数据和高并发，提升性能和吞吐量，充分利用多台机器的cpu。</p>
<h4 id="9-replica：副本"><a href="#9-replica：副本" class="headerlink" title="9 replica：副本"></a>9 replica：副本</h4><p>在分布式环境下，任何一台机器都会随时宕机，如果宕机，index的一个分片没有，导致此index不能搜索。所以，为了保证数据的安全，我们会将每个index的分片经行备份，存储在另外的机器上。保证少数机器宕机es集群仍可以搜索。</p>
<p>能正常提供查询和插入的分片我们叫做主分片（primary shard），其余的我们就管他们叫做备份的分片（replica shard）。</p>
<p>es6默认新建索引时，5分片，2副本，也就是一主一备，共10个分片。所以，es集群最小规模为两台。</p>
<h3 id="3-5-3-elasticsearch核心概念-vs-数据库核心概念"><a href="#3-5-3-elasticsearch核心概念-vs-数据库核心概念" class="headerlink" title="3.5.3 elasticsearch核心概念 vs. 数据库核心概念"></a>3.5.3 elasticsearch核心概念 vs. 数据库核心概念</h3><div class="table-container">
<table>
<thead>
<tr>
<th><strong>关系型数据库（比如Mysql）</strong></th>
<th><strong>非关系型数据库（Elasticsearch）</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>数据库Database</td>
<td>索引Index</td>
</tr>
<tr>
<td>表Table</td>
<td>索引Index（原为Type）</td>
</tr>
<tr>
<td>数据行Row</td>
<td>文档Document</td>
</tr>
<tr>
<td>数据列Column</td>
<td>字段Field</td>
</tr>
<tr>
<td>约束 Schema</td>
<td>映射Mapping</td>
</tr>
</tbody>
</table>
</div>
<h1 id="4．-Elasticsearch相关软件安装"><a href="#4．-Elasticsearch相关软件安装" class="headerlink" title="4． Elasticsearch相关软件安装"></a>4． Elasticsearch相关软件安装</h1><h2 id="4-1-Windows安装elasticsearch"><a href="#4-1-Windows安装elasticsearch" class="headerlink" title="4.1.  Windows安装elasticsearch"></a>4.1.  Windows安装elasticsearch</h2><h3 id="1、安装JDK，至少1-8-0-73以上版本，验证：java-version。"><a href="#1、安装JDK，至少1-8-0-73以上版本，验证：java-version。" class="headerlink" title="1、安装JDK，至少1.8.0_73以上版本，验证：java -version。"></a>1、安装JDK，至少1.8.0_73以上版本，验证：java -version。</h3><h3 id="2、下载和解压缩Elasticsearch安装包，查看目录结构。"><a href="#2、下载和解压缩Elasticsearch安装包，查看目录结构。" class="headerlink" title="2、下载和解压缩Elasticsearch安装包，查看目录结构。"></a>2、下载和解压缩Elasticsearch安装包，查看目录结构。</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></p>
<p>bin：脚本目录，包括：启动、停止等可执行脚本</p>
<p>config：配置文件目录</p>
<p>data：索引目录，存放索引文件的地方</p>
<p>logs：日志目录</p>
<p>modules：模块目录，包括了es的功能模块</p>
<p>plugins :插件目录，es支持插件机制</p>
<h3 id="3、配置文件："><a href="#3、配置文件：" class="headerlink" title="3、配置文件："></a>3、配置文件：</h3><p>位置：</p>
<p>ES的配置文件的地址根据安装形式的不同而不同：</p>
<p>使用zip、tar安装，配置文件的地址在安装目录的config下。</p>
<p>使用RPM安装，配置文件在/etc/elasticsearch下。</p>
<p>使用MSI安装，配置文件的地址在安装目录的config下，并且会自动将config目录地址写入环境变量ES_PATH_CONF。</p>
<p><strong>elasticsearch.yml</strong></p>
<p>配置格式是YAML，可以采用如下两种方式：</p>
<p>方式1：层次方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path:</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">/var/lib/elasticsearch</span></span><br><span class="line">    <span class="attr">logs:</span> <span class="string">/var/log/elasticsearch</span></span><br></pre></td></tr></table></figure>
<p>方式2：属性方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path.data:</span> <span class="string">/var/lib/elasticsearch</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/var/log/elasticsearch</span></span><br></pre></td></tr></table></figure>
<p>常用的配置项如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> </span><br><span class="line">	<span class="string">配置elasticsearch的集群名称，默认是elasticsearch。建议修改成一个有意义的名称。</span></span><br><span class="line"><span class="attr">node.name:</span></span><br><span class="line">	<span class="string">节点名，通常一台物理服务器就是一个节点，es会默认随机指定一个名字，建议指定一个有意义的名称，方便管理</span></span><br><span class="line">	<span class="string">一个或多个节点组成一个cluster集群，集群是一个逻辑的概念，节点是物理概念，后边章节会详细介绍。</span></span><br><span class="line"><span class="attr">path.conf:</span> </span><br><span class="line">	<span class="string">设置配置文件的存储路径，tar或zip包安装默认在es根目录下的config文件夹，rpm安装默认在/etc/</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">path.data:</span></span><br><span class="line">	<span class="string">设置索引数据的存储路径，默认是es根目录下的data文件夹，可以设置多个存储路径，用逗号隔开。</span></span><br><span class="line"><span class="attr">path.logs:</span></span><br><span class="line">	<span class="string">设置日志文件的存储路径，默认是es根目录下的logs文件夹</span></span><br><span class="line"><span class="attr">path.plugins:</span> </span><br><span class="line">	<span class="string">设置插件的存放路径，默认是es根目录下的plugins文件夹</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line">	<span class="string">设置为true可以锁住ES使用的内存，避免内存与swap分区交换数据。</span></span><br><span class="line"><span class="attr">network.host:</span> </span><br><span class="line">	<span class="string">设置绑定主机的ip地址，设置为0.0.0.0表示绑定任何ip，允许外网访问，生产环境建议设置为具体的ip。</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line">	<span class="string">设置对外服务的http端口，默认为9200。</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span> <span class="number">9300</span>  <span class="string">集群结点之间通信端口</span></span><br><span class="line"><span class="attr">node.master:</span> </span><br><span class="line">	<span class="string">指定该节点是否有资格被选举成为master结点，默认是true，如果原来的master宕机会重新选举新的master。</span></span><br><span class="line"><span class="attr">node.data:</span> </span><br><span class="line">	<span class="string">指定该节点是否存储索引数据，默认为true。</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;host1:port&quot;</span>, <span class="string">&quot;host2:port&quot;</span>, <span class="string">&quot;...&quot;</span>]</span><br><span class="line">	<span class="string">设置集群中master节点的初始列表。</span></span><br><span class="line"><span class="attr">discovery.zen.ping.timeout:</span> <span class="string">3s</span></span><br><span class="line">	<span class="string">设置ES自动发现节点连接超时的时间，默认为3秒，如果网络延迟高可设置大些。</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span></span><br><span class="line">	<span class="string">主结点数量的最少值</span> <span class="string">,此值的公式为：(master_eligible_nodes</span> <span class="string">/</span> <span class="number">2</span><span class="string">)</span> <span class="string">+</span> <span class="number">1</span> <span class="string">，比如：有3个符合要求的主结点，那么这里要设置为2。</span></span><br><span class="line"><span class="attr">node.max_local_storage_nodes:</span> </span><br><span class="line">	<span class="string">单机允许的最大存储结点数，通常单机启动一个结点建议设置为1，开发环境如果单机启动多个节点可设置大于1。</span></span><br></pre></td></tr></table></figure>
<p><strong>jvm.options</strong></p>
<p>设置最小及最大的JVM堆内存大小：</p>
<p>在jvm.options中设置 -Xms和-Xmx：</p>
<p>1） 两个值设置为相等</p>
<p>2） 将Xmx 设置为不超过物理内存的一半。</p>
<p><strong>log4j2.properties</strong></p>
<p>日志文件设置，ES使用log4j，注意日志级别的配置。</p>
<h3 id="4、启动Elasticsearch：bin-elasticsearch-bat，es的特点就是开箱即，无需配置，启动即可。"><a href="#4、启动Elasticsearch：bin-elasticsearch-bat，es的特点就是开箱即，无需配置，启动即可。" class="headerlink" title="4、启动Elasticsearch：bin\elasticsearch.bat，es的特点就是开箱即，无需配置，启动即可。"></a>4、启动Elasticsearch：bin\elasticsearch.bat，es的特点就是开箱即，无需配置，启动即可。</h3><p>注意：es7 windows版本不支持机器学习，所以elasticsearch.yml中添加如下几个参数：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">node.name:</span> <span class="string">node-1</span>  </span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span> [<span class="string">&quot;node-1&quot;</span>]  </span><br><span class="line"><span class="attr">xpack.ml.enabled:</span> <span class="literal">false</span> </span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">/.*/</span></span><br></pre></td></tr></table></figure>
<h3 id="5、检查ES是否启动成功：浏览器访问http-localhost-9200-Pretty"><a href="#5、检查ES是否启动成功：浏览器访问http-localhost-9200-Pretty" class="headerlink" title="5、检查ES是否启动成功：浏览器访问http://localhost:9200/?Pretty"></a>5、检查ES是否启动成功：浏览器访问<a target="_blank" rel="noopener" href="http://localhost:9200/?Pretty">http://localhost:9200/?Pretty</a></h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node-1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HqAKQ_0tQOOm8b6qU-2Qug&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7.3.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_flavor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zip&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;de777fa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-07-24T18:30:11.767338Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_snapshot&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lucene_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_wire_compatibility_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6.8.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_index_compatibility_version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tagline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>解释：</p>
<p>name: node名称，取自机器的hostname</p>
<p>cluster_name: 集群名称（默认的集群名称就是elasticsearch）</p>
<p>version.number: 7.3.0，es版本号</p>
<p>version.lucene_version:封装的lucene版本号</p>
<h3 id="6、浏览器访问-http-localhost-9200-cluster-health-查询集群状态"><a href="#6、浏览器访问-http-localhost-9200-cluster-health-查询集群状态" class="headerlink" title="6、浏览器访问 http://localhost:9200/_cluster/health 查询集群状态"></a>6、浏览器访问 <a target="_blank" rel="noopener" href="http://localhost:9200/_cluster/health">http://localhost:9200/_cluster/health</a> 查询集群状态</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;elasticsearch&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_nodes&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_data_nodes&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_primary_shards&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_shards&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;relocating_shards&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;initializing_shards&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;unassigned_shards&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;delayed_unassigned_shards&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_pending_tasks&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number_of_in_flight_fetch&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;task_max_waiting_in_queue_millis&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;active_shards_percent_as_number&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>解释：</p>
<p>Status：集群状态。Green 所有分片可用。Yellow所有主分片可用。Red主分片不可用，集群不可用。</p>
<h2 id="4-2-Windows安装Kibana"><a href="#4-2-Windows安装Kibana" class="headerlink" title="4.2.  Windows安装Kibana"></a>4.2.  Windows安装Kibana</h2><p>1、kibana是es数据的前端展现，数据分析时，可以方便地看到数据。作为开发人员，可以方便访问es。</p>
<p>2、下载，解压kibana。</p>
<p>3、启动Kibana：bin\kibana.bat</p>
<p>4、浏览器访问 <a target="_blank" rel="noopener" href="http://localhost:5601">http://localhost:5601</a> 进入Dev Tools界面。像plsql一样支持代码提示。</p>
<p>5、发送get请求，查看集群状态GET _cluster/health。相当于浏览器访问。</p>
<p>​        <img src="/img/1568622526251.png" alt="1568622526251"></p>
<p>​                                                                    总览</p>
<p>   <img src="/img/1568622589010.png" alt="1568622589010"></p>
<p>​                                                            Dev Tools界面</p>
<p>   <img src="/img/1568622607418.png" alt="1568622607418"></p>
<p>​                                                                监控集群界面</p>
<p>   <img src="/img/1568622619503.png" alt="1568622619503"></p>
<p>​                                                    集群状态（搜索速率、索引速率等）</p>
<h2 id="4-3-Windows安装postman"><a href="#4-3-Windows安装postman" class="headerlink" title="4.3  Windows安装postman"></a>4.3  Windows安装postman</h2><p>是什么：postman是一个模拟http请求的工具。能够非常细致地定制化各种http请求。如get]\post\pu\delete,携带body参数等。</p>
<p>为什么：在没有kibana时，可以使用postman调试。</p>
<p>怎么用：</p>
<p>get <a target="_blank" rel="noopener" href="http://localhost:9200/">http://localhost:9200/</a></p>
<p>  <img src="/img/1568622671957.png" alt="1568622671957">                                                </p>
<p>测试一下get方式查询集群状态<a target="_blank" rel="noopener" href="http://localhost:9200/_cluster/health">http://localhost:9200/_cluster/health</a></p>
<p>   <img src="/img/1568622683707.png" alt="1568622683707"></p>
<h2 id="4-4-Windows安装head插件"><a href="#4-4-Windows安装head插件" class="headerlink" title="4.4 Windows安装head插件"></a>4.4 Windows安装head插件</h2><p>head插件是ES的一个可视化管理插件，用来监视ES的状态，并通过head客户端和ES服务进行交互，比如创建映射、创建索引等，head的项目地址在<a target="_blank" rel="noopener" href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a> 。</p>
<p>从ES6.0开始，head插件支持使得node.js运行。</p>
<h3 id="1安装node-js"><a href="#1安装node-js" class="headerlink" title="1安装node.js"></a>1安装node.js</h3><h3 id="2下载head并运行"><a href="#2下载head并运行" class="headerlink" title="2下载head并运行"></a>2下载head并运行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone git://github.com/mobz/elasticsearch-head.git </span><br><span class="line">cd elasticsearch-head </span><br><span class="line">npm install </span><br><span class="line">npm run start </span><br></pre></td></tr></table></figure>
<p>浏览器打开 <a target="_blank" rel="noopener" href="http://localhost:9100/">http://localhost:9100/</a></p>
<h3 id="3运行"><a href="#3运行" class="headerlink" title="3运行"></a>3运行</h3><p><img src="/img/1568627572838.png" alt="1568627572838"></p>
<p>打开浏览器调试工具发现报错：</p>
<p>Origin null is not allowed by Access-Control-Allow-Origin.</p>
<p>原因是：head插件作为客户端要连接ES服务（localhost:9200），此时存在跨域问题，elasticsearch默认不允许跨域访问。</p>
<p>解决方案：</p>
<p>设置elasticsearch允许跨域访问。</p>
<p>在config/elasticsearch.yml 后面增加以下参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#开启cors跨域访问支持，默认为false   </span><br><span class="line">http.cors.enabled: true   </span><br><span class="line">#跨域访问允许的域名地址，(允许所有域名)以上使用正则   </span><br><span class="line">http.cors.allow-origin: /.*/</span><br></pre></td></tr></table></figure>
<p>注意：将config/elasticsearch.yml另存为utf-8编码格式。</p>
<p>成功连接ES</p>
<p><img src="/img/1568627617789.png" alt="1568627617789"></p>
<p>注意：kibana\postman\head插件选择自己喜欢的一种使用即可。</p>
<p>本教程使用kibana的dev tool，因为地址栏省略了<a href="http://localhost:9200。">http://localhost:9200。</a></p>
<h1 id="5．-es快速入门"><a href="#5．-es快速入门" class="headerlink" title="5． es快速入门"></a>5． es快速入门</h1><h2 id="5-1．-文档（document）的数据格式"><a href="#5-1．-文档（document）的数据格式" class="headerlink" title="5.1． 文档（document）的数据格式"></a>5.1． 文档（document）的数据格式</h2><p>（1）应用系统的数据结构都是面向对象的，具有复杂的数据结构</p>
<p>（2）对象存储到数据库，需要将关联的复杂对象属性插到另一张表，查询时再拼接起来。</p>
<p>（3）es面向文档，文档中存储的数据结构，与对象一致。所以一个对象可以直接存成一个文档。</p>
<p>（4）es的document用json数据格式来表达。</p>
<p>例如：班级和学生关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String classInfoId;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ClassInfo</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="keyword">private</span> String className;</span><br><span class="line">。。。。。</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库中要设计所谓的一对多，多对一的两张表，外键等。查询出来时，还要关联，mybatis写映射文件，很繁琐。</p>
<p>而在es中，一个学生存成文档如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhang&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;classInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;className&quot;</span><span class="punctuation">:</span> <span class="string">&quot;三年二班&quot;</span><span class="punctuation">,</span>     </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="5-2图书网站商品管理案例：背景介绍"><a href="#5-2图书网站商品管理案例：背景介绍" class="headerlink" title="5.2图书网站商品管理案例：背景介绍"></a>5.2图书网站商品管理案例：背景介绍</h2><p>有一个售卖图书的网站，需要为其基于ES构建一个后台系统，提供以下功能：</p>
<p>（1）对商品信息进行CRUD（增删改查）操作</p>
<p>（2）执行简单的结构化查询</p>
<p>（3）可以执行简单的全文检索，以及复杂的phrase（短语）检索</p>
<p>（4）对于全文检索的结果，可以进行高亮显示</p>
<p>（5）对数据进行简单的聚合分析</p>
<h2 id="5-3．-简单的集群管理"><a href="#5-3．-简单的集群管理" class="headerlink" title="5.3． 简单的集群管理"></a>5.3． 简单的集群管理</h2><h3 id="5-3-1快速检查集群的健康状况"><a href="#5-3-1快速检查集群的健康状况" class="headerlink" title="5.3.1快速检查集群的健康状况"></a>5.3.1快速检查集群的健康状况</h3><p>es提供了一套api，叫做cat api，可以查看es中各种各样的数据</p>
<p>GET /_cat/health?v</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1568635460 12:04:20  elasticsearch green           1         1      4   4    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure>
<p>如何快速了解集群的健康状况？green、yellow、red？</p>
<p>green：每个索引的primary shard和replica shard都是active状态的</p>
<p>yellow：每个索引的primary shard都是active状态的，但是部分replica shard不是active状态，处于不可用的状态</p>
<p>red：不是所有索引的primary shard都是active状态的，部分索引有数据丢失了</p>
<h3 id="5-3-2-快速查看集群中有哪些索引"><a href="#5-3-2-快速查看集群中有哪些索引" class="headerlink" title="5.3.2 快速查看集群中有哪些索引"></a>5.3.2 快速查看集群中有哪些索引</h3><p>GET /_cat/indices?v</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">health status index                           uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   .kibana_task_manager            JBMgpucOSzenstLcjA_G4A   1   0          2            0     45.5kb         45.5kb</span><br><span class="line">green  open   .monitoring-kibana-7-2019.09.16 LIskf15DTcS70n4Q6t2bTA   1   0        433            0    218.2kb        218.2kb</span><br><span class="line">green  open   .monitoring-es-7-2019.09.16     RMeUN3tQRjqM8xBgw7Zong   1   0       3470         1724      1.9mb          1.9mb</span><br><span class="line">green  open   .kibana_1                       1cRiyIdATya5xS6qK5pGJw   1   0          4            0     18.2kb         18.2kb</span><br></pre></td></tr></table></figure>
<h3 id="5-3-3-简单的索引操作"><a href="#5-3-3-简单的索引操作" class="headerlink" title="5.3.3 简单的索引操作"></a>5.3.3 简单的索引操作</h3><p>创建索引：PUT /demo_index?pretty</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;shards_acknowledged&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;demo_index&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>删除索引：DELETE /demo_index?pretty</p>
<h2 id="5-4商品的CRUD操作（document-CRUD操作）"><a href="#5-4商品的CRUD操作（document-CRUD操作）" class="headerlink" title="5.4商品的CRUD操作（document CRUD操作）"></a>5.4商品的CRUD操作（document CRUD操作）</h2><h3 id="5-4-1-新建图书索引"><a href="#5-4-1-新建图书索引" class="headerlink" title="5.4.1 新建图书索引"></a>5.4.1 新建图书索引</h3><p>首先建立图书索引 book</p>
<p>语法：put /index</p>
<p>PUT /book</p>
<p><img src="/img/1568632608676.png" alt="1568632608676"></p>
<h3 id="5-4-2-新增图书-新增文档"><a href="#5-4-2-新增图书-新增文档" class="headerlink" title="5.4.2 新增图书 :新增文档"></a>5.4.2 新增图书 :新增文档</h3><p>语法：PUT /index/type/id</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_doc/<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bootstrap开发&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;studymodel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;201002&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">38.6</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span><span class="string">&quot;2019-08-25 19:11:35&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span><span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;bootstrap&quot;</span><span class="punctuation">,</span> <span class="string">&quot;dev&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_doc/<span class="number">2</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java编程思想&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;studymodel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;201001&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">68.6</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span><span class="string">&quot;2019-08-25 19:11:35&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span><span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;java&quot;</span><span class="punctuation">,</span> <span class="string">&quot;dev&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_doc/<span class="number">3</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;name&quot;</span>: <span class="string">&quot;spring开发基础&quot;</span>,</span><br><span class="line"><span class="string">&quot;description&quot;</span>: <span class="string">&quot;spring 在java领域非常流行，java程序员都在用。&quot;</span>,</span><br><span class="line"><span class="string">&quot;studymodel&quot;</span>: <span class="string">&quot;201001&quot;</span>,</span><br><span class="line"><span class="string">&quot;price&quot;</span>:<span class="number">88.6</span>,</span><br><span class="line"><span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2019-08-24 19:11:35&quot;</span>,</span><br><span class="line"><span class="string">&quot;pic&quot;</span>:<span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span>,</span><br><span class="line"><span class="string">&quot;tags&quot;</span>: [ <span class="string">&quot;spring&quot;</span>, <span class="string">&quot;java&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-4-3-查询图书：检索文档"><a href="#5-4-3-查询图书：检索文档" class="headerlink" title="5.4.3 查询图书：检索文档"></a>5.4.3 查询图书：检索文档</h3><p>语法：GET /index/type/id</p>
<p>查看图书:GET /book/_doc/1  就可看到json形式的文档。方便程序解析。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line"></span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line"></span><br><span class="line">  &quot;_version&quot; : 4,</span><br><span class="line"></span><br><span class="line">  &quot;_seq_no&quot; : 5,</span><br><span class="line"></span><br><span class="line">  &quot;_primary_term&quot; : 1,</span><br><span class="line"></span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line"></span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line"></span><br><span class="line">    &quot;name&quot; : &quot;Bootstrap开发&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;description&quot; : &quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;studymodel&quot; : &quot;201002&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;price&quot; : 38.6,</span><br><span class="line"></span><br><span class="line">    &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line"></span><br><span class="line">    &quot;tags&quot; : [</span><br><span class="line"></span><br><span class="line">      &quot;bootstrap&quot;,</span><br><span class="line"></span><br><span class="line">      &quot;开发&quot;</span><br><span class="line"></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为方便查看索引中的数据，kibana可以如下操作</p>
<p>Kibana-discover- Create index pattern- Index pattern填book</p>
<p><img src="/img/1568632860925.png" alt="1568632860925"></p>
<p>下一步，再点击discover就可看到数据。</p>
<p><img src="/img/1568632872820.png" alt="1568632872820"></p>
<p>点击json还可以看到原始数据</p>
<p><img src="/img/1568632881931.png" alt="1568632881931"></p>
<p>为方便查看索引中的数据，head可以如下操作</p>
<p>点击数据浏览，点击book索引。</p>
<p><img src="/img/1568632895254.png" alt="1568632895254"></p>
<h3 id="5-4-4-修改图书：替换操作"><a href="#5-4-4-修改图书：替换操作" class="headerlink" title="5.4.4 修改图书：替换操作"></a>5.4.4 修改图书：替换操作</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bootstrap开发教程1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;studymodel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;201002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">38.6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span><span class="string">&quot;2019-08-25 19:11:35&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span><span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;bootstrap&quot;</span><span class="punctuation">,</span> <span class="string">&quot;开发&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>替换操作是整体覆盖，要带上所有信息。</p>
<h3 id="5-4-5-修改图书：更新文档"><a href="#5-4-5-修改图书：更新文档" class="headerlink" title="5.4.5 修改图书：更新文档"></a>5.4.5 修改图书：更新文档</h3><p>语法：POST  /{index}/type /{id}/_update</p>
<p>或者POST  /{index}/_update/{id}</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /book/_update/<span class="number">1</span>/ </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot; Bootstrap开发教程高级&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-4-6-删除图书：删除文档"><a href="#5-4-6-删除图书：删除文档" class="headerlink" title="5.4.6 删除图书：删除文档"></a>5.4.6 删除图书：删除文档</h3><p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /book/_doc/1</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;deleted&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="6．-文档document入门"><a href="#6．-文档document入门" class="headerlink" title="6． 文档document入门"></a>6． 文档document入门</h1><h2 id="6-1．-默认自带字段解析"><a href="#6-1．-默认自带字段解析" class="headerlink" title="6.1． 默认自带字段解析"></a>6.1． 默认自带字段解析</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap开发教程1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;studymodel&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;201002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">38.6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2019-08-25 19:11:35&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pic&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;bootstrap&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;开发&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="6-1-1-index"><a href="#6-1-1-index" class="headerlink" title="6.1.1 _index"></a>6.1.1 _index</h3><ul>
<li>含义：此文档属于哪个索引</li>
<li>原则：类似数据放在一个索引中。数据库中表的定义规则。如图书信息放在book索引中，员工信息放在employee索引中。各个索引存储和搜索时互不影响。</li>
<li>定义规则：英文小写。尽量不要使用特殊字符。order user </li>
</ul>
<h3 id="6-1-2-type"><a href="#6-1-2-type" class="headerlink" title="6.1.2 _type"></a>6.1.2 _type</h3><ul>
<li>含义：类别。book java node</li>
<li>注意：以后的es9将彻底删除此字段，所以当前版本在不断弱化type。不需要关注。见到_type都为doc。</li>
</ul>
<h3 id="6-1-3-id"><a href="#6-1-3-id" class="headerlink" title="6.1.3 _id"></a>6.1.3 _id</h3><p>含义：文档的唯一标识。就像表的id主键。结合索引可以标识和定义一个文档。</p>
<p>生成：手动（put /index/_doc/id）、自动</p>
<h3 id="6-1-4-创建索引时，不同数据放到不同索引中"><a href="#6-1-4-创建索引时，不同数据放到不同索引中" class="headerlink" title="6.1.4 创建索引时，不同数据放到不同索引中"></a>6.1.4 创建索引时，不同数据放到不同索引中</h3><h2 id="6-2．-生成文档id"><a href="#6-2．-生成文档id" class="headerlink" title="6.2． 生成文档id"></a>6.2． 生成文档id</h2><h3 id="6-2-1-手动生成id"><a href="#6-2-1-手动生成id" class="headerlink" title="6.2.1 手动生成id"></a>6.2.1 手动生成id</h3><p>场景：数据从其他系统导入时，本身有唯一主键。如数据库中的图书、员工信息等。</p>
<p>用法：put /index/_doc/id</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="6-2-2-自动生成id"><a href="#6-2-2-自动生成id" class="headerlink" title="6.2.2 自动生成id"></a>6.2.2 自动生成id</h3><p>用法：POST /index/_doc</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;x29LOm0BPsY0gSJFYZAl&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>自动id特点：</p>
<p>长度为20个字符，URL安全，base64编码，GUID，分布式生成不冲突 </p>
<h2 id="6-3．-source-字段"><a href="#6-3．-source-字段" class="headerlink" title="6.3． _source 字段"></a>6.3． _source 字段</h2><h3 id="6-3-1-source"><a href="#6-3-1-source" class="headerlink" title="6.3.1 _source"></a>6.3.1 _source</h3><p>含义：插入数据时的所有字段和值。在get获取数据时，在_source字段中原样返回。</p>
<p>GET  /book/_doc/1</p>
<h3 id="6-3-2-定制返回字段"><a href="#6-3-2-定制返回字段" class="headerlink" title="6.3.2 定制返回字段"></a>6.3.2 定制返回字段</h3><p>就像sql不要select *,而要select name,price from book …一样。</p>
<p>GET  /book/_doc/1?__source_includes=name,price    </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;book&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">38.6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Bootstrap开发教程1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="6-4．-文档的替换与删除"><a href="#6-4．-文档的替换与删除" class="headerlink" title="6.4． 文档的替换与删除"></a>6.4． 文档的替换与删除</h2><h3 id="6-4-1全量替换"><a href="#6-4-1全量替换" class="headerlink" title="6.4.1全量替换"></a>6.4.1全量替换</h3><p>执行两次，返回结果中版本号（_version）在不断上升。此过程为全量替换。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>实质：旧文档的内容不会立即删除，只是标记为deleted。适当的时机，集群会将这些文档删除。</p>
<h3 id="6-4-2-强制创建"><a href="#6-4-2-强制创建" class="headerlink" title="6.4.2 强制创建"></a>6.4.2 强制创建</h3><p>为防止覆盖原有数据，我们在新增时，设置为强制创建，不会覆盖原有文档。</p>
<p>语法：PUT /index/ _doc/id/_create</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">1</span>/_create</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[2]: version conflict, document already exists (current version [1])&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lqzVqxZLQuCnd6LYtZsMkg&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[2]: version conflict, document already exists (current version [1])&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lqzVqxZLQuCnd6LYtZsMkg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">409</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="6-4-3-删除"><a href="#6-4-3-删除" class="headerlink" title="6.4.3 删除"></a>6.4.3 删除</h3><p>DELETE /index/_doc/id</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE  /test_index/_doc/1/</span><br></pre></td></tr></table></figure>
<p>实质：旧文档的内容不会立即删除，只是标记为deleted。适当的时机，集群会将这些文档删除。</p>
<p>lazy delete</p>
<h2 id="6-5．-局部替换-partial-update"><a href="#6-5．-局部替换-partial-update" class="headerlink" title="6.5． 局部替换 partial update"></a>6.5． 局部替换 partial update</h2><p>使用 PUT /index/type/id 为文档全量替换，需要将文档所有数据提交。</p>
<p>partial update局部替换则只修改变动字段。</p>
<p>用法：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">post /index/type/id/_update </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="string">&quot;field&quot;</span>：<span class="string">&quot;value&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="图解内部原理"><a href="#图解内部原理" class="headerlink" title="图解内部原理"></a>图解内部原理</h4><p>内部与全量替换是一样的，旧文档标记为删除，新建一个文档。</p>
<p>优点：</p>
<ul>
<li>大大减少网络传输次数和流量，提升性能</li>
<li>减少并发冲突发生的概率。</li>
</ul>
<h4 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h4><p>插入文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/5</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field1&quot;: &quot;itcst&quot;,</span><br><span class="line">  &quot;test_field2&quot;: &quot;itheima&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改字段1</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc/<span class="number">5</span>/_update</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test_field2&quot;</span><span class="punctuation">:</span> <span class="string">&quot; itheima 2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="6-6．-使用脚本更新"><a href="#6-6．-使用脚本更新" class="headerlink" title="6.6． 使用脚本更新"></a>6.6． 使用脚本更新</h2><p>es可以内置脚本执行复杂操作。例如painless脚本。</p>
<p>注意：groovy脚本在es6以后就不支持了。原因是耗内存，不安全远程注入漏洞。</p>
<h3 id="6-6-1内置脚本"><a href="#6-6-1内置脚本" class="headerlink" title="6.6.1内置脚本"></a>6.6.1内置脚本</h3><p>需求1：修改文档6的num字段，+1。</p>
<p>插入数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">6</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;num&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>执行脚本操作</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc/<span class="number">6</span>/_update</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;script&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ctx._source.num+=1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>查询数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_doc/6</span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;6&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;found&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;num&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>需求2：搜索所有文档，将num字段乘以2输出</p>
<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/7</span><br><span class="line">&#123;</span><br><span class="line">  &quot;num&quot;: 5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;script_fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_doubled_field&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;expression&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;doc[&#x27;num&#x27;] * multiplier&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;multiplier&quot;</span><span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;7&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;fields&quot; : &#123;</span><br><span class="line">          &quot;my_doubled_field&quot; : [</span><br><span class="line">            10.0</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-6-2-外部脚本"><a href="#6-6-2-外部脚本" class="headerlink" title="6.6.2 外部脚本"></a>6.6.2 外部脚本</h3><p>Painless是内置支持的。脚本内容可以通过多种途径传给 es，包括 rest 接口，或者放到 config/scripts目录等，默认开启。</p>
<p>注意：脚本性能低下，且容易发生注入，本教程忽略。</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html</a></p>
<h2 id="6-7．-图解es的并发问题"><a href="#6-7．-图解es的并发问题" class="headerlink" title="6.7． 图解es的并发问题"></a>6.7． 图解es的并发问题</h2><p>如同秒杀，多线程情况下，es同样会出现并发冲突问题。</p>
<h2 id="6-8．-图解悲观锁与乐观锁机制"><a href="#6-8．-图解悲观锁与乐观锁机制" class="headerlink" title="6.8． 图解悲观锁与乐观锁机制"></a>6.8． 图解悲观锁与乐观锁机制</h2><p>为控制并发问题，我们通常采用锁机制。分为悲观锁和乐观锁两种机制。</p>
<p>悲观锁：很悲观，所有情况都上锁。此时只有一个线程可以操作数据。具体例子为数据库中的行级锁、表级锁、读锁、写锁等。</p>
<p>特点：优点是方便，直接加锁，对程序透明。缺点是效率低。</p>
<p>乐观锁：很乐观，对数据本身不加锁。提交数据时，通过一种机制验证是否存在冲突，如es中通过版本号验证。</p>
<p>特点：优点是并发能力高。缺点是操作繁琐，在提交数据时，可能反复重试多次。</p>
<h2 id="6-9．-图解es内部基于-version乐观锁控制"><a href="#6-9．-图解es内部基于-version乐观锁控制" class="headerlink" title="6.9． 图解es内部基于_version乐观锁控制"></a>6.9． 图解es内部基于_version乐观锁控制</h2><h4 id="实验基于-version的版本控制"><a href="#实验基于-version的版本控制" class="headerlink" title="实验基于_version的版本控制"></a>实验基于_version的版本控制</h4><p>es对于文档的增删改都是基于版本号。</p>
<p>1新增多次文档：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;test&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回版本号递增</p>
<p>2删除此文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /test_index/_doc/3</span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELETE /test_index/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot; : 6,</span><br><span class="line">  &quot;result&quot; : &quot;deleted&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot; : 7,</span><br><span class="line">  &quot;_primary_term&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3再新增</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;test&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到版本号依然递增，验证延迟删除策略。</p>
<p>如果删除一条数据立马删除的话，所有分片和副本都要立马删除，对es集群压力太大。</p>
<h4 id="图解es内部并发控制"><a href="#图解es内部并发控制" class="headerlink" title="图解es内部并发控制"></a>图解es内部并发控制</h4><p>es内部主从同步时，是多线程异步。乐观锁机制。</p>
<h2 id="6-10．-演示客户端程序基于-version并发操作流程"><a href="#6-10．-演示客户端程序基于-version并发操作流程" class="headerlink" title="6.10． 演示客户端程序基于_version并发操作流程"></a>6.10． 演示客户端程序基于_version并发操作流程</h2><p>java python客户端更新的机制。</p>
<h4 id="新建文档"><a href="#新建文档" class="headerlink" title="新建文档"></a>新建文档</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/<span class="number">5</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;itcast&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>返回： </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="客户端1修改。带版本号1。"><a href="#客户端1修改。带版本号1。" class="headerlink" title="客户端1修改。带版本号1。"></a>客户端1修改。带版本号1。</h4><p>首先获取数据的当前版本号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_doc/5</span><br></pre></td></tr></table></figure>
<p>更新文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/5?version=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">&#125;</span><br><span class="line">PUT /test_index/_doc/5?if_seq_no=21&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="客户端2并发修改。带版本号1。"><a href="#客户端2并发修改。带版本号1。" class="headerlink" title="客户端2并发修改。带版本号1。"></a>客户端2并发修改。带版本号1。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/5?version=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast2&quot;</span><br><span class="line">&#125;</span><br><span class="line">PUT /test_index/_doc/5?if_seq_no=21&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>报错。</p>
<h4 id="客户端2重新查询。得到最新版本为2。seq-no-22"><a href="#客户端2重新查询。得到最新版本为2。seq-no-22" class="headerlink" title="客户端2重新查询。得到最新版本为2。seq_no=22"></a>客户端2重新查询。得到最新版本为2。seq_no=22</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_doc/4</span><br></pre></td></tr></table></figure>
<h4 id="客户端2并发修改。带版本号2。"><a href="#客户端2并发修改。带版本号2。" class="headerlink" title="客户端2并发修改。带版本号2。"></a>客户端2并发修改。带版本号2。</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/4?version=2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast2&quot;</span><br><span class="line">&#125;</span><br><span class="line">es7</span><br><span class="line">PUT /test_index/_doc/5?if_seq_no=22&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改成功。</p>
<h2 id="6-11．-演示自己手动控制版本号-external-version"><a href="#6-11．-演示自己手动控制版本号-external-version" class="headerlink" title="6.11． 演示自己手动控制版本号 external version"></a>6.11． 演示自己手动控制版本号 external version</h2><p>背景：已有数据是在数据库中，有自己手动维护的版本号的情况下，可以使用external version控制。hbase。</p>
<p>要求：修改时external version要大于当前文档的_version</p>
<p>对比：基于_version时，修改的文档version等于当前文档的版本号。</p>
<p>使用?version=1&amp;version_type=external</p>
<h4 id="新建文档-1"><a href="#新建文档-1" class="headerlink" title="新建文档"></a>新建文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新文档：</p>
<h4 id="客户端1修改文档"><a href="#客户端1修改文档" class="headerlink" title="客户端1修改文档"></a>客户端1修改文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/4?version=2&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="客户端2同时修改"><a href="#客户端2同时修改" class="headerlink" title="客户端2同时修改"></a>客户端2同时修改</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/4?version=2&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;version_conflict_engine_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;[4]: version conflict, current version [2] is higher or equal to the one provided [2]&quot;,</span><br><span class="line">        &quot;index_uuid&quot;: &quot;-rqYZ2EcSPqL6pu8Gi35jw&quot;,</span><br><span class="line">        &quot;shard&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;index&quot;: &quot;test_index&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;version_conflict_engine_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;[4]: version conflict, current version [2] is higher or equal to the one provided [2]&quot;,</span><br><span class="line">    &quot;index_uuid&quot;: &quot;-rqYZ2EcSPqL6pu8Gi35jw&quot;,</span><br><span class="line">    &quot;shard&quot;: &quot;1&quot;,</span><br><span class="line">    &quot;index&quot;: &quot;test_index&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 409</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="客户端2重新查询数据"><a href="#客户端2重新查询数据" class="headerlink" title="客户端2重新查询数据"></a>客户端2重新查询数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_doc/4</span><br></pre></td></tr></table></figure>
<h4 id="客户端2重新修改数据"><a href="#客户端2重新修改数据" class="headerlink" title="客户端2重新修改数据"></a>客户端2重新修改数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/4?version=3&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test_field&quot;: &quot;itcast2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-12．更新时-retry-on-conflict-参数"><a href="#6-12．更新时-retry-on-conflict-参数" class="headerlink" title="6.12．更新时 retry_on_conflict 参数"></a>6.12．更新时 retry_on_conflict 参数</h2><h4 id="retry-on-conflict"><a href="#retry-on-conflict" class="headerlink" title="retry_on_conflict"></a>retry_on_conflict</h4><p>指定重试次数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc/5/_update?retry_on_conflict=3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">    &quot;test_field&quot;: &quot;itcast1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="与-version结合使用"><a href="#与-version结合使用" class="headerlink" title="与 _version结合使用"></a>与 _version结合使用</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /test_index/_doc/<span class="number">5</span>/_update?retry_on_conflict=<span class="number">3</span>&amp;version=<span class="number">22</span>&amp;version_type=external</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test_field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;itcast1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="6-13．-批量查询-mget"><a href="#6-13．-批量查询-mget" class="headerlink" title="6.13． 批量查询 mget"></a>6.13． 批量查询 mget</h2><p>单条查询 GET  /test_index/_doc/1，如果查询多个id的文档一条一条查询，网络开销太大。</p>
<h4 id="mget-批量查询："><a href="#mget-批量查询：" class="headerlink" title="mget 批量查询："></a>mget 批量查询：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;docs&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">         &quot;_type&quot; :  &quot;_doc&quot;,</span><br><span class="line">         &quot;_id&quot; :    1</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">         &quot;_type&quot; :  &quot;_doc&quot;,</span><br><span class="line">         &quot;_id&quot; :    7</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">      &quot;_version&quot; : 6,</span><br><span class="line">      &quot;_seq_no&quot; : 12,</span><br><span class="line">      &quot;_primary_term&quot; : 1,</span><br><span class="line">      &quot;found&quot; : true,</span><br><span class="line">      &quot;_source&quot; : &#123;</span><br><span class="line">        &quot;test_field&quot; : &quot;test12333123321321&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">      &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">      &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">      &quot;_version&quot; : 6,</span><br><span class="line">      &quot;_seq_no&quot; : 18,</span><br><span class="line">      &quot;_primary_term&quot; : 1,</span><br><span class="line">      &quot;found&quot; : true,</span><br><span class="line">      &quot;_source&quot; : &#123;</span><br><span class="line">        &quot;test_field&quot; : &quot;test3213&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>提示去掉type</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;docs&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">         &quot;_id&quot; :    2</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_index&quot; : &quot;test_index&quot;,</span><br><span class="line">         &quot;_id&quot; :    3</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="同一索引下批量查询："><a href="#同一索引下批量查询：" class="headerlink" title="同一索引下批量查询："></a>同一索引下批量查询：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_mget</span><br><span class="line">&#123;</span><br><span class="line">   &quot;docs&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_id&quot; :    2</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         &quot;_id&quot; :    3</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第三种写法：搜索写法"><a href="#第三种写法：搜索写法" class="headerlink" title="第三种写法：搜索写法"></a>第三种写法：搜索写法</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">post /test_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;ids&quot; : &#123;</span><br><span class="line">            &quot;values&quot; : [&quot;1&quot;, &quot;7&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-14．-批量增删改-bulk"><a href="#6-14．-批量增删改-bulk" class="headerlink" title="6.14． 批量增删改 bulk"></a>6.14． 批量增删改 bulk</h2><p>Bulk 操作解释将文档的增删改查一些列操作，通过一次请求全都做完。减少网络传输次数。</p>
<p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;&quot;action&quot;: &#123;&quot;metadata&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;data&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>如下操作，删除5，新增14，修改2。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; &quot;delete&quot;: &#123; &quot;_index&quot;: &quot;test_index&quot;,  &quot;_id&quot;: &quot;5&quot; &#125;&#125; </span><br><span class="line">&#123; &quot;create&quot;: &#123; &quot;_index&quot;: &quot;test_index&quot;,  &quot;_id&quot;: &quot;14&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;test_field&quot;: &quot;test14&quot; &#125;</span><br><span class="line">&#123; &quot;update&quot;: &#123; &quot;_index&quot;: &quot;test_index&quot;,  &quot;_id&quot;: &quot;2&quot;&#125; &#125;</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;test_field&quot; : &quot;bulk test&quot;&#125; &#125;</span><br></pre></td></tr></table></figure>
<p>总结：</p>
<p>1功能：</p>
<ul>
<li>delete：删除一个文档，只要1个json串就可以了</li>
<li>create：相当于强制创建  PUT /index/type/id/_create </li>
<li>index：普通的put操作，可以是创建文档，也可以是全量替换文档</li>
<li>update：执行的是局部更新partial update操作</li>
</ul>
<p>2格式：每个json不能换行。相邻json必须换行。</p>
<p>3隔离：每个操作互不影响。操作失败的行会返回其失败信息。</p>
<p>4实际用法：bulk请求一次不要太大，否则一下积压到内存中，性能会下降。所以，一次请求几千个操作、大小在几M正好。</p>
<h2 id="6-15．-文档概念学习总结"><a href="#6-15．-文档概念学习总结" class="headerlink" title="6.15． 文档概念学习总结"></a>6.15． 文档概念学习总结</h2><p><strong>章节回顾</strong></p>
<p>1文档的增删改查</p>
<p>2文档字段解析</p>
<p>3内部锁机制</p>
<p>4批量查询修改</p>
<p><strong>es是什么</strong></p>
<p>一个分布式的文档数据存储系统distributed document store。es看做一个分布式nosql数据库。如redis\mongoDB\hbase。</p>
<p>文档数据：es可以存储和操作json文档类型的数据，而且这也是es的核心数据结构。<br>        存储系统：es可以对json文档类型的数据进行存储，查询，创建，更新，删除，等等操作。</p>
<p><strong>应用场景</strong></p>
<ul>
<li>大数据。es的分布式特点，水平扩容承载大数据。</li>
<li>数据结构灵活。列随时变化。使用关系型数据库将会建立大量的关联表，增加系统复杂度。</li>
<li>数据操作简单。就是查询，不涉及事务。</li>
</ul>
<p><strong>举例</strong></p>
<p>电商页面、传统论坛页面等。面向的对象比较复杂，但是作为终端，没有太复杂的功能（事务），只涉及简单的增删改查crud。</p>
<p>这个时候选用ES这种NoSQL型的数据存储，比传统的复杂的事务强大的关系型数据库，更加合适一些。无论是性能，还是吞吐量，可能都会更好。</p>
<h1 id="7．-Java-api-实现文档管理"><a href="#7．-Java-api-实现文档管理" class="headerlink" title="7． Java api 实现文档管理"></a>7． Java api 实现文档管理</h1><h2 id="7-1-es技术特点"><a href="#7-1-es技术特点" class="headerlink" title="7.1 es技术特点"></a>7.1 es技术特点</h2><p>1es技术比较特殊，不像其他分布式、大数据课程，haddop、spark、hbase。es代码层面很好写，难的是概念的理解。</p>
<p>2es最重要的是他的rest api。跨语言的。在真实生产中，探查数据、分析数据，使用rest更方便。</p>
<p>3本课程将会大量讲解内部原理及rest api。java代码会在重要的api后学习。</p>
<h2 id="7-2-java-客户端简单获取数据"><a href="#7-2-java-客户端简单获取数据" class="headerlink" title="7.2 java 客户端简单获取数据"></a>7.2 java 客户端简单获取数据</h2><p>java api 文档 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.3/java-rest-overview.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.3/java-rest-overview.html</a></p>
<p>low : 偏向底层。</p>
<p>high：高级封装。足够。</p>
<p>1导包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2代码</p>
<p>步骤 </p>
<p>​    1 获取连接客户端</p>
<p>​    2构建请求</p>
<p>​    3执行</p>
<p>​    4获取结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取连接客户端</span></span><br><span class="line"><span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">        RestClient.builder(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)));</span><br><span class="line"><span class="comment">//构建请求</span></span><br><span class="line"><span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(<span class="string">&quot;book&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="comment">// 执行</span></span><br><span class="line"><span class="type">GetResponse</span> <span class="variable">getResponse</span> <span class="operator">=</span> client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line"><span class="comment">// 获取结果</span></span><br><span class="line"><span class="keyword">if</span> (getResponse.isExists()) &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">version</span> <span class="operator">=</span> getResponse.getVersion();</span><br><span class="line">    <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> getResponse.getSourceAsString();<span class="comment">//检索文档(String形式)</span></span><br><span class="line">    System.out.println(sourceAsString);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-3-结合spring-boot-test测试文档查询"><a href="#7-3-结合spring-boot-test测试文档查询" class="headerlink" title="7.3 结合spring-boot-test测试文档查询"></a>7.3 结合spring-boot-test测试文档查询</h2><p>0为什么使用spring boot test</p>
<ul>
<li>​    当今趋势</li>
<li>​    方便开发</li>
<li>​    创建连接交由spring容器，避免每次请求的网络开销。</li>
</ul>
<p>1导包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2配置 application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-search</span></span><br><span class="line"><span class="attr">heima:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">hostlist:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9200</span> <span class="comment">#多个结点中间用逗号分隔</span></span><br></pre></td></tr></table></figure>
<p>3代码</p>
<p>主类</p>
<p>配置类</p>
<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="comment">//查询文档</span></span><br><span class="line">       <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGet</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//构建请求</span></span><br><span class="line">        <span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(<span class="string">&quot;test_post&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//========================可选参数 start======================</span></span><br><span class="line">        <span class="comment">//为特定字段配置_source_include</span></span><br><span class="line"><span class="comment">//        String[] includes = new String[]&#123;&quot;user&quot;, &quot;message&quot;&#125;;</span></span><br><span class="line"><span class="comment">//        String[] excludes = Strings.EMPTY_ARRAY;</span></span><br><span class="line"><span class="comment">//        FetchSourceContext fetchSourceContext = new FetchSourceContext(true, includes, excludes);</span></span><br><span class="line"><span class="comment">//        getRequest.fetchSourceContext(fetchSourceContext);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//为特定字段配置_source_excludes</span></span><br><span class="line"><span class="comment">//        String[] includes1 = new String[]&#123;&quot;user&quot;, &quot;message&quot;&#125;;</span></span><br><span class="line"><span class="comment">//        String[] excludes1 = Strings.EMPTY_ARRAY;</span></span><br><span class="line"><span class="comment">//        FetchSourceContext fetchSourceContext1 = new FetchSourceContext(true, includes1, excludes1);</span></span><br><span class="line"><span class="comment">//        getRequest.fetchSourceContext(fetchSourceContext1);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置路由</span></span><br><span class="line"><span class="comment">//        getRequest.routing(&quot;routing&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ========================可选参数 end=====================</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询 同步查询</span></span><br><span class="line">      <span class="type">GetResponse</span> <span class="variable">getResponse</span> <span class="operator">=</span> client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//异步查询</span></span><br><span class="line"><span class="comment">//        ActionListener&lt;GetResponse&gt; listener = new ActionListener&lt;GetResponse&gt;() &#123;</span></span><br><span class="line"><span class="comment">//            //查询成功时的立马执行的方法</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void onResponse(GetResponse getResponse) &#123;</span></span><br><span class="line"><span class="comment">//                long version = getResponse.getVersion();</span></span><br><span class="line"><span class="comment">//                String sourceAsString = getResponse.getSourceAsString();//检索文档(String形式)</span></span><br><span class="line"><span class="comment">//                System.out.println(sourceAsString);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            //查询失败时的立马执行的方法</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public void onFailure(Exception e) &#123;</span></span><br><span class="line"><span class="comment">//                e.printStackTrace();</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;;</span></span><br><span class="line"><span class="comment">//        //执行异步请求</span></span><br><span class="line"><span class="comment">//        client.getAsync(getRequest, RequestOptions.DEFAULT, listener);</span></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            Thread.sleep(5000);</span></span><br><span class="line"><span class="comment">//        &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取结果</span></span><br><span class="line">        <span class="keyword">if</span> (getResponse.isExists()) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">version</span> <span class="operator">=</span> getResponse.getVersion();</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> getResponse.getSourceAsString();<span class="comment">//检索文档(String形式)</span></span><br><span class="line">            System.out.println(sourceAsString);</span><br><span class="line">            <span class="type">byte</span>[] sourceAsBytes = getResponse.getSourceAsBytes();<span class="comment">//以字节接受</span></span><br><span class="line">            Map&lt;String, Object&gt; sourceAsMap = getResponse.getSourceAsMap();</span><br><span class="line">            System.out.println(sourceAsMap);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-4-结合spring-boot-test测试文档新增"><a href="#7-4-结合spring-boot-test测试文档新增" class="headerlink" title="7.4 结合spring-boot-test测试文档新增"></a>7.4 结合spring-boot-test测试文档新增</h2><p>rest api</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT test_post/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;user&quot;:&quot;tomas&quot;,</span><br><span class="line">  &quot;postDate&quot;:&quot;2019-07-18&quot;,</span><br><span class="line">  &quot;message&quot;:&quot;trying out es1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">    public void testAdd() throws IOException &#123;</span><br><span class="line">//        1构建请求</span><br><span class="line">        IndexRequest request=new IndexRequest(&quot;test_posts&quot;);</span><br><span class="line">        request.id(&quot;3&quot;);</span><br><span class="line">//        =======================构建文档============================</span><br><span class="line">//        构建方法1</span><br><span class="line">        String jsonString=&quot;&#123;\n&quot; +</span><br><span class="line">                &quot;  \&quot;user\&quot;:\&quot;tomas J\&quot;,\n&quot; +</span><br><span class="line">                &quot;  \&quot;postDate\&quot;:\&quot;2019-07-18\&quot;,\n&quot; +</span><br><span class="line">                &quot;  \&quot;message\&quot;:\&quot;trying out es3\&quot;\n&quot; +</span><br><span class="line">                &quot;&#125;&quot;;</span><br><span class="line">        request.source(jsonString, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">//        构建方法2</span><br><span class="line">//        Map&lt;String,Object&gt; jsonMap=new HashMap&lt;&gt;();</span><br><span class="line">//        jsonMap.put(&quot;user&quot;, &quot;tomas&quot;);</span><br><span class="line">//        jsonMap.put(&quot;postDate&quot;, &quot;2019-07-18&quot;);</span><br><span class="line">//        jsonMap.put(&quot;message&quot;, &quot;trying out es2&quot;);</span><br><span class="line">//        request.source(jsonMap);</span><br><span class="line"></span><br><span class="line">//        构建方法3</span><br><span class="line">//        XContentBuilder builder= XContentFactory.jsonBuilder();</span><br><span class="line">//        builder.startObject();</span><br><span class="line">//        &#123;</span><br><span class="line">//            builder.field(&quot;user&quot;, &quot;tomas&quot;);</span><br><span class="line">//            builder.timeField(&quot;postDate&quot;, new Date());</span><br><span class="line">//            builder.field(&quot;message&quot;, &quot;trying out es2&quot;);</span><br><span class="line">//        &#125;</span><br><span class="line">//        builder.endObject();</span><br><span class="line">//        request.source(builder);</span><br><span class="line">//        构建方法4</span><br><span class="line">//        request.source(&quot;user&quot;,&quot;tomas&quot;,</span><br><span class="line">//                    &quot;postDate&quot;,new Date(),</span><br><span class="line">//                &quot;message&quot;,&quot;trying out es2&quot;);</span><br><span class="line">//</span><br><span class="line">//        ========================可选参数===================================</span><br><span class="line">        //设置超时时间</span><br><span class="line">        request.timeout(TimeValue.timeValueSeconds(1));</span><br><span class="line">        request.timeout(&quot;1s&quot;);</span><br><span class="line"></span><br><span class="line">        //自己维护版本号</span><br><span class="line">//        request.version(2);</span><br><span class="line">//        request.versionType(VersionType.EXTERNAL);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        2执行</span><br><span class="line">        //同步</span><br><span class="line">        IndexResponse indexResponse = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">        //异步</span><br><span class="line">//        ActionListener&lt;IndexResponse&gt; listener=new ActionListener&lt;IndexResponse&gt;() &#123;</span><br><span class="line">//            @Override</span><br><span class="line">//            public void onResponse(IndexResponse indexResponse) &#123;</span><br><span class="line">//</span><br><span class="line">//            &#125;</span><br><span class="line">//</span><br><span class="line">//            @Override</span><br><span class="line">//            public void onFailure(Exception e) &#123;</span><br><span class="line">//</span><br><span class="line">//            &#125;</span><br><span class="line">//        &#125;;</span><br><span class="line">//        client.indexAsync(request,RequestOptions.DEFAULT, listener );</span><br><span class="line">//        try &#123;</span><br><span class="line">//            Thread.sleep(5000);</span><br><span class="line">//        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">//            e.printStackTrace();</span><br><span class="line">//        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        3获取结果</span><br><span class="line">        String index = indexResponse.getIndex();</span><br><span class="line">        String id = indexResponse.getId();</span><br><span class="line">        //获取插入的类型</span><br><span class="line">        if(indexResponse.getResult()== DocWriteResponse.Result.CREATED)&#123;</span><br><span class="line">            DocWriteResponse.Result result=indexResponse.getResult();</span><br><span class="line">            System.out.println(&quot;CREATED:&quot;+result);</span><br><span class="line">        &#125;else if(indexResponse.getResult()== DocWriteResponse.Result.UPDATED)&#123;</span><br><span class="line">            DocWriteResponse.Result result=indexResponse.getResult();</span><br><span class="line">            System.out.println(&quot;UPDATED:&quot;+result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ReplicationResponse.ShardInfo shardInfo = indexResponse.getShardInfo();</span><br><span class="line">        if(shardInfo.getTotal()!=shardInfo.getSuccessful())&#123;</span><br><span class="line">            System.out.println(&quot;处理成功的分片数少于总分片！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if(shardInfo.getFailed()&gt;0)&#123;</span><br><span class="line">           for (ReplicationResponse.ShardInfo.Failure failure:shardInfo.getFailures()) &#123;</span><br><span class="line">               String reason = failure.reason();//处理潜在的失败原因</span><br><span class="line">               System.out.println(reason);</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-5结合spring-boot-test测试文档修改"><a href="#7-5结合spring-boot-test测试文档修改" class="headerlink" title="7.5结合spring-boot-test测试文档修改"></a>7.5结合spring-boot-test测试文档修改</h2><p>rest api</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">post /test_posts/_doc/3/_update </span><br><span class="line">&#123;</span><br><span class="line">   &quot;doc&quot;: &#123;</span><br><span class="line">      &quot;user&quot;：&quot;tomas J&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">  @Test</span><br><span class="line">    public void testUpdate() throws IOException &#123;</span><br><span class="line">//        1构建请求</span><br><span class="line">        UpdateRequest request = new UpdateRequest(&quot;test_posts&quot;, &quot;3&quot;);</span><br><span class="line">        Map&lt;String, Object&gt; jsonMap = new HashMap&lt;&gt;();</span><br><span class="line">        jsonMap.put(&quot;user&quot;, &quot;tomas JJ&quot;);</span><br><span class="line">        request.doc(jsonMap);</span><br><span class="line">//===============================可选参数==========================================</span><br><span class="line">        request.timeout(&quot;1s&quot;);//超时时间</span><br><span class="line"></span><br><span class="line">        //重试次数</span><br><span class="line">        request.retryOnConflict(3);</span><br><span class="line"></span><br><span class="line">        //设置在继续更新之前，必须激活的分片数</span><br><span class="line">//        request.waitForActiveShards(2);</span><br><span class="line">        //所有分片都是active状态，才更新</span><br><span class="line">//        request.waitForActiveShards(ActiveShardCount.ALL);</span><br><span class="line"></span><br><span class="line">//        2执行</span><br><span class="line">//        同步</span><br><span class="line">        UpdateResponse updateResponse = client.update(request, RequestOptions.DEFAULT);</span><br><span class="line">//        异步</span><br><span class="line"></span><br><span class="line">//        3获取数据</span><br><span class="line">        updateResponse.getId();</span><br><span class="line">        updateResponse.getIndex();</span><br><span class="line"></span><br><span class="line">        //判断结果</span><br><span class="line">        if (updateResponse.getResult() == DocWriteResponse.Result.CREATED) &#123;</span><br><span class="line">            DocWriteResponse.Result result = updateResponse.getResult();</span><br><span class="line">            System.out.println(&quot;CREATED:&quot; + result);</span><br><span class="line">        &#125; else if (updateResponse.getResult() == DocWriteResponse.Result.UPDATED) &#123;</span><br><span class="line">            DocWriteResponse.Result result = updateResponse.getResult();</span><br><span class="line">            System.out.println(&quot;UPDATED:&quot; + result);</span><br><span class="line">        &#125;else if(updateResponse.getResult() == DocWriteResponse.Result.DELETED)&#123;</span><br><span class="line">            DocWriteResponse.Result result = updateResponse.getResult();</span><br><span class="line">            System.out.println(&quot;DELETED:&quot; + result);</span><br><span class="line">        &#125;else if (updateResponse.getResult() == DocWriteResponse.Result.NOOP)&#123;</span><br><span class="line">            //没有操作</span><br><span class="line">            DocWriteResponse.Result result = updateResponse.getResult();</span><br><span class="line">            System.out.println(&quot;NOOP:&quot; + result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-6结合spring-boot-test测试文档删除"><a href="#7-6结合spring-boot-test测试文档删除" class="headerlink" title="7.6结合spring-boot-test测试文档删除"></a>7.6结合spring-boot-test测试文档删除</h2><p>rest api</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /test_posts/_doc/3</span><br></pre></td></tr></table></figure>
<p>代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> @Test</span><br><span class="line">    public void testDelete() throws IOException &#123;</span><br><span class="line">//        1构建请求</span><br><span class="line">        DeleteRequest request =new DeleteRequest(&quot;test_posts&quot;,&quot;3&quot;);</span><br><span class="line">        //可选参数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        2执行</span><br><span class="line">        DeleteResponse deleteResponse = client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        3获取数据</span><br><span class="line">        deleteResponse.getId();</span><br><span class="line">        deleteResponse.getIndex();</span><br><span class="line"></span><br><span class="line">        DocWriteResponse.Result result = deleteResponse.getResult();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-7结合spring-boot-test测试文档bulk"><a href="#7-7结合spring-boot-test测试文档bulk" class="headerlink" title="7.7结合spring-boot-test测试文档bulk"></a>7.7结合spring-boot-test测试文档bulk</h2><p>rest api</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;&quot;action&quot;: &#123;&quot;metadata&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;data&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">    public void testBulk() throws IOException &#123;</span><br><span class="line">//        1创建请求</span><br><span class="line">        BulkRequest request = new BulkRequest();</span><br><span class="line">//        request.add(new IndexRequest(&quot;post&quot;).id(&quot;1&quot;).source(XContentType.JSON, &quot;field&quot;, &quot;1&quot;));</span><br><span class="line">//        request.add(new IndexRequest(&quot;post&quot;).id(&quot;2&quot;).source(XContentType.JSON, &quot;field&quot;, &quot;2&quot;));</span><br><span class="line"></span><br><span class="line">        request.add(new UpdateRequest(&quot;post&quot;,&quot;2&quot;).doc(XContentType.JSON, &quot;field&quot;, &quot;3&quot;));</span><br><span class="line">        request.add(new DeleteRequest(&quot;post&quot;).id(&quot;1&quot;));</span><br><span class="line"></span><br><span class="line">//        2执行</span><br><span class="line">        BulkResponse bulkResponse = client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        for (BulkItemResponse itemResponse : bulkResponse) &#123;</span><br><span class="line">            DocWriteResponse itemResponseResponse = itemResponse.getResponse();</span><br><span class="line"></span><br><span class="line">            switch (itemResponse.getOpType()) &#123;</span><br><span class="line">                case INDEX:</span><br><span class="line">                case CREATE:</span><br><span class="line">                    IndexResponse indexResponse = (IndexResponse) itemResponseResponse;</span><br><span class="line">                    indexResponse.getId();</span><br><span class="line">                    System.out.println(indexResponse.getResult());</span><br><span class="line">                    break;</span><br><span class="line">                case UPDATE:</span><br><span class="line">                    UpdateResponse updateResponse = (UpdateResponse) itemResponseResponse;</span><br><span class="line">                    updateResponse.getIndex();</span><br><span class="line">                    System.out.println(updateResponse.getResult());</span><br><span class="line">                    break;</span><br><span class="line">                case DELETE:</span><br><span class="line">                    DeleteResponse deleteResponse = (DeleteResponse) itemResponseResponse;</span><br><span class="line">                    System.out.println(deleteResponse.getResult());</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="8．-图解es内部机制"><a href="#8．-图解es内部机制" class="headerlink" title="8． 图解es内部机制"></a>8． 图解es内部机制</h1><h2 id="8-1．-图解es分布式基础"><a href="#8-1．-图解es分布式基础" class="headerlink" title="8.1． 图解es分布式基础"></a>8.1． 图解es分布式基础</h2><h3 id="8-1-1es对复杂分布式机制的透明隐藏特性"><a href="#8-1-1es对复杂分布式机制的透明隐藏特性" class="headerlink" title="8.1.1es对复杂分布式机制的透明隐藏特性"></a>8.1.1es对复杂分布式机制的透明隐藏特性</h3><ul>
<li>分布式机制：分布式数据存储及共享。</li>
<li>分片机制：数据存储到哪个分片，副本数据写入。</li>
<li>集群发现机制：cluster discovery。新启动es实例，自动加入集群。</li>
<li>shard负载均衡：大量数据写入及查询，es会将数据平均分配。</li>
<li>shard副本：新增副本数，分片重分配。</li>
</ul>
<h3 id="8-1-2Elasticsearch的垂直扩容与水平扩容"><a href="#8-1-2Elasticsearch的垂直扩容与水平扩容" class="headerlink" title="8.1.2Elasticsearch的垂直扩容与水平扩容"></a>8.1.2Elasticsearch的垂直扩容与水平扩容</h3><p>垂直扩容：使用更加强大的服务器替代老服务器。但单机存储及运算能力有上线。且成本直线上升。如10t服务器1万。单个10T服务器可能20万。</p>
<p>水平扩容：采购更多服务器，加入集群。大数据。</p>
<h3 id="8-1-3增减或减少节点时的数据rebalance"><a href="#8-1-3增减或减少节点时的数据rebalance" class="headerlink" title="8.1.3增减或减少节点时的数据rebalance"></a>8.1.3增减或减少节点时的数据rebalance</h3><p>新增或减少es实例时，es集群会将数据重新分配。</p>
<h3 id="8-1-4master节点"><a href="#8-1-4master节点" class="headerlink" title="8.1.4master节点"></a>8.1.4master节点</h3><p>功能：</p>
<ul>
<li>创建删除节点</li>
<li>创建删除索引</li>
</ul>
<h3 id="8-1-5节点对等的分布式架构"><a href="#8-1-5节点对等的分布式架构" class="headerlink" title="8.1.5节点对等的分布式架构"></a>8.1.5节点对等的分布式架构</h3><ul>
<li>节点对等，每个节点都能接收所有的请求</li>
<li>自动请求路由</li>
<li>响应收集</li>
</ul>
<h2 id="8-2．-图解分片shard、副本replica机制"><a href="#8-2．-图解分片shard、副本replica机制" class="headerlink" title="8.2． 图解分片shard、副本replica机制"></a>8.2． 图解分片shard、副本replica机制</h2><h3 id="8-2-1shard-amp-replica机制"><a href="#8-2-1shard-amp-replica机制" class="headerlink" title="8.2.1shard&amp;replica机制"></a>8.2.1shard&amp;replica机制</h3><p>（1）每个index包含一个或多个shard</p>
<p>（2）每个shard都是一个最小工作单元，承载部分数据，lucene实例，完整的建立索引和处理请求的能力</p>
<p>（3）增减节点时，shard会自动在nodes中负载均衡</p>
<p>（4）primary shard和replica shard，每个document肯定只存在于某一个primary shard以及其对应的replica shard中，不可能存在于多个primary shard</p>
<p>（5）replica shard是primary shard的副本，负责容错，以及承担读请求负载</p>
<p>（6）primary shard的数量在创建索引的时候就固定了，replica shard的数量可以随时修改</p>
<p>（7）primary shard的默认数量是1，replica默认是1，默认共有2个shard，1个primary shard，1个replica shard</p>
<p>注意：es7以前primary shard的默认数量是5，replica默认是1，默认有10个shard，5个primary shard，5个replica shard</p>
<p>（8）primary shard不能和自己的replica shard放在同一个节点上（否则节点宕机，primary shard和副本都丢失，起不到容错的作用），但是可以和其他primary shard的replica shard放在同一个节点上</p>
<h2 id="8-3图解单node环境下创建index是什么样子的"><a href="#8-3图解单node环境下创建index是什么样子的" class="headerlink" title="8.3图解单node环境下创建index是什么样子的"></a>8.3图解单node环境下创建index是什么样子的</h2><p>（1）单node环境下，创建一个index，有3个primary shard，3个replica shard<br>        （2）集群status是yellow<br>        （3）这个时候，只会将3个primary shard分配到仅有的一个node上去，另外3个replica shard是无法分配的<br>        （4）集群可以正常工作，但是一旦出现节点宕机，数据全部丢失，而且集群不可用，无法承接任何请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index1</span><br><span class="line">&#123;</span><br><span class="line">   &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;number_of_shards&quot; : 3,</span><br><span class="line">      &quot;number_of_replicas&quot; : 1</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-4图解2个node环境下replica-shard是如何分配的"><a href="#8-4图解2个node环境下replica-shard是如何分配的" class="headerlink" title="8.4图解2个node环境下replica shard是如何分配的"></a>8.4图解2个node环境下replica shard是如何分配的</h2><p>（1）replica shard分配：3个primary shard，3个replica shard，1 node<br>        （2）primary —-&gt; replica同步<br>        （3）读请求：primary/replica</p>
<h2 id="8-5图解横向扩容"><a href="#8-5图解横向扩容" class="headerlink" title="8.5图解横向扩容"></a>8.5图解横向扩容</h2><ul>
<li>分片自动负载均衡，分片向空闲机器转移。</li>
<li>每个节点存储更少分片，系统资源给与每个分片的资源更多，整体集群性能提高。</li>
<li>扩容极限：节点数大于整体分片数，则必有空闲机器。</li>
<li>超出扩容极限时，可以增加副本数，如设置副本数为2，总共3*3=9个分片。9台机器同时运行，存储和搜索性能更强。容错性更好。</li>
<li>容错性：只要一个索引的所有主分片在，集群就就可以运行。</li>
</ul>
<h2 id="8-6-图解es容错机制-master选举，replica容错，数据恢复"><a href="#8-6-图解es容错机制-master选举，replica容错，数据恢复" class="headerlink" title="8.6 图解es容错机制 master选举，replica容错，数据恢复"></a>8.6 图解es容错机制 master选举，replica容错，数据恢复</h2><p>以3分片，2副本数，3节点为例介绍。</p>
<ul>
<li>master node宕机，自动master选举，集群为red</li>
<li>replica容错：新master将replica提升为primary shard，yellow</li>
<li>重启宕机node，master copy replica到该node，使用原有的shard并同步宕机后的修改，green</li>
</ul>
<h1 id="9．-图解文档存储机制"><a href="#9．-图解文档存储机制" class="headerlink" title="9． 图解文档存储机制"></a>9． 图解文档存储机制</h1><h2 id="9-1．-数据路由"><a href="#9-1．-数据路由" class="headerlink" title="9.1． 数据路由"></a>9.1． 数据路由</h2><h3 id="9-1-1文档存储如何路由到相应分片"><a href="#9-1-1文档存储如何路由到相应分片" class="headerlink" title="9.1.1文档存储如何路由到相应分片"></a>9.1.1文档存储如何路由到相应分片</h3><p>一个文档，最终会落在主分片的一个分片上，到底应该在哪一个分片？这就是数据路由。</p>
<h3 id="9-1-2路由算法"><a href="#9-1-2路由算法" class="headerlink" title="9.1.2路由算法"></a>9.1.2路由算法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure>
<p>哈希值对主分片数取模。</p>
<p>举例：</p>
<p>对一个文档经行crud时，都会带一个路由值 routing number。默认为文档_id（可能是手动指定，也可能是自动生成）。</p>
<p>存储1号文档，经过哈希计算，哈希值为2,此索引有3个主分片，那么计算2%3=2，就算出此文档在P2分片上。</p>
<p>决定一个document在哪个shard上，最重要的一个值就是routing值，默认是_id，也可以手动指定，相同的routing值，每次过来，从hash函数中，产出的hash值一定是相同的</p>
<p>无论hash值是几，无论是什么数字，对number_of_primary_shards求余数，结果一定是在0~number_of_primary_shards-1之间这个范围内的。0,1,2。</p>
<h3 id="9-1-3手动指定-routing-number"><a href="#9-1-3手动指定-routing-number" class="headerlink" title="9.1.3手动指定 routing number"></a>9.1.3手动指定 routing number</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_doc/15?routing=num</span><br><span class="line">&#123;</span><br><span class="line">  &quot;num&quot;: 0,</span><br><span class="line">  &quot;tags&quot;: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>场景：在程序中，架构师可以手动指定已有数据的一个属性为路由值，好处是可以定制一类文档数据存储到一个分片中。缺点是设计不好，会造成数据倾斜。</p>
<p>所以，不同文档尽量放到不同的索引中。剩下的事情交给es集群自己处理。</p>
<h3 id="9-1-4主分片数量不可变"><a href="#9-1-4主分片数量不可变" class="headerlink" title="9.1.4主分片数量不可变"></a>9.1.4主分片数量不可变</h3><p>涉及到以往数据的查询搜索，所以一旦建立索引，主分片数不可变。</p>
<h2 id="9-2．-图解文档的增删改内部机制"><a href="#9-2．-图解文档的增删改内部机制" class="headerlink" title="9.2． 图解文档的增删改内部机制"></a>9.2． 图解文档的增删改内部机制</h2><p>增删改可以看做update,都是对数据的改动。一个改动请求发送到es集群，经历以下四个步骤：</p>
<p>（1）客户端选择一个node发送请求过去，这个node就是coordinating node（协调节点）</p>
<p>（2）coordinating node，对document进行路由，将请求转发给对应的node（有primary shard）</p>
<p>（3）实际的node上的primary shard处理请求，然后将数据同步到replica node。</p>
<p>（4）coordinating node，如果发现primary node和所有replica node都搞定之后，就返回响应结果给客户端。</p>
<h2 id="9-3．图解文档的查询内部机制"><a href="#9-3．图解文档的查询内部机制" class="headerlink" title="9.3．图解文档的查询内部机制"></a>9.3．图解文档的查询内部机制</h2><p>1、客户端发送请求到任意一个node，成为coordinate node</p>
<p>2、coordinate node对document进行路由，将请求转发到对应的node，此时会使用round-robin随机轮询算法，在primary shard以及其所有replica中随机选择一个，让读请求负载均衡</p>
<p>3、接收请求的node返回document给coordinate node</p>
<p>4、coordinate node返回document给客户端</p>
<p>5、特殊情况：document如果还在建立索引过程中，可能只有primary shard有，任何一个replica shard都没有，此时可能会导致无法读取到document，但是document完成索引建立之后，primary shard和replica shard就都有了。</p>
<h2 id="9-4．bulk-api奇特的json格式"><a href="#9-4．bulk-api奇特的json格式" class="headerlink" title="9.4．bulk api奇特的json格式"></a>9.4．bulk api奇特的json格式</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="string">&quot;meta&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>\n</span><br><span class="line"><span class="punctuation">&#123;</span><span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span>\n</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="string">&quot;meta&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>\n</span><br><span class="line"><span class="punctuation">&#123;</span><span class="string">&quot;data&quot;</span><span class="punctuation">&#125;</span>\n</span><br><span class="line"></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;create&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;field1&quot;</span><span class="punctuation">:</span><span class="string">&quot;java&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;field1&quot;</span><span class="punctuation">:</span><span class="string">&quot;spring&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;create&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;field1&quot;</span><span class="punctuation">:</span><span class="string">&quot;java&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;field1&quot;</span><span class="punctuation">:</span><span class="string">&quot;spring&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span>       </span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>1、bulk中的每个操作都可能要转发到不同的node的shard去执行</p>
<p>2、如果采用比较良好的json数组格式</p>
<p>允许任意的换行，整个可读性非常棒，读起来很爽，es拿到那种标准格式的json串以后，要按照下述流程去进行处理</p>
<p>（1）将json数组解析为JSONArray对象，这个时候，整个数据，就会在内存中出现一份一模一样的拷贝，一份数据是json文本，一份数据是JSONArray对象</p>
<p>（2）解析json数组里的每个json，对每个请求中的document进行路由</p>
<p>（3）为路由到同一个shard上的多个请求，创建一个请求数组。100请求中有10个是到P1.</p>
<p>（4）将这个请求数组序列化</p>
<p>（5）将序列化后的请求数组发送到对应的节点上去</p>
<p>3、耗费更多内存，更多的jvm gc开销</p>
<p>我们之前提到过bulk size最佳大小的那个问题，一般建议说在几千条那样，然后大小在10MB左右，所以说，可怕的事情来了。假设说现在100个bulk请求发送到了一个节点上去，然后每个请求是10MB，100个请求，就是1000MB = 1GB，然后每个请求的json都copy一份为jsonarray对象，此时内存中的占用就会翻倍，就会占用2GB的内存，甚至还不止。因为弄成jsonarray之后，还可能会多搞一些其他的数据结构，2GB+的内存占用。</p>
<p>占用更多的内存可能就会积压其他请求的内存使用量，比如说最重要的搜索请求，分析请求，等等，此时就可能会导致其他请求的性能急速下降。</p>
<p>另外的话，占用内存更多，就会导致java虚拟机的垃圾回收次数更多，跟频繁，每次要回收的垃圾对象更多，耗费的时间更多，导致es的java虚拟机停止工作线程的时间更多。</p>
<p>4、现在的奇特格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; &quot;delete&quot;: &#123; &quot;_index&quot;: &quot;test_index&quot;,  &quot;_id&quot;: &quot;5&quot; &#125;&#125; \n</span><br><span class="line">&#123; &quot;create&quot;: &#123; &quot;_index&quot;: &quot;test_index&quot;,  &quot;_id&quot;: &quot;14&quot; &#125;&#125;\n</span><br><span class="line">&#123; &quot;test_field&quot;: &quot;test14&quot; &#125;\n</span><br><span class="line">&#123; &quot;update&quot;: &#123; &quot;_index&quot;: &quot;test_index&quot;,  &quot;_id&quot;: &quot;2&quot;&#125; &#125;\n</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;test_field&quot; : &quot;bulk test&quot;&#125; &#125;\n</span><br></pre></td></tr></table></figure>
<p>（1）不用将其转换为json对象，不会出现内存中的相同数据的拷贝，直接按照换行符切割json</p>
<p>（2）对每两个一组的json，读取meta，进行document路由</p>
<p>（3）直接将对应的json发送到node上去</p>
<p>5、最大的优势在于，不需要将json数组解析为一个JSONArray对象，形成一份大数据的拷贝，浪费内存空间，尽可能地保证性能。</p>
<h1 id="10．-Mapping映射入门"><a href="#10．-Mapping映射入门" class="headerlink" title="10． Mapping映射入门"></a>10． Mapping映射入门</h1><h2 id="10-1．-什么是mapping映射"><a href="#10-1．-什么是mapping映射" class="headerlink" title="10.1． 什么是mapping映射"></a>10.1． 什么是mapping映射</h2><p>概念：自动或手动为index中的_doc建立的一种数据结构和相关配置，简称为mapping映射。</p>
<p>插入几条数据，让es自动为我们建立一个索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;post_date&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;my first article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my first article in this website&quot;,</span><br><span class="line">  &quot;author_id&quot;: 11400</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /website/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;post_date&quot;: &quot;2019-01-02&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;my second article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my second article in this website&quot;,</span><br><span class="line">  &quot;author_id&quot;: 11400</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">PUT /website/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;post_date&quot;: &quot;2019-01-03&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;my third article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my third article in this website&quot;,</span><br><span class="line">  &quot;author_id&quot;: 11400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对比数据库建表语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table website(</span><br><span class="line">     post_date date,</span><br><span class="line">     title varchar(50),     </span><br><span class="line">     content varchar(100),</span><br><span class="line">     author_id int(11) </span><br><span class="line"> );</span><br></pre></td></tr></table></figure>
<p>动态映射：dynamic mapping，自动为我们建立index，以及对应的mapping，mapping中包含了每个field对应的数据类型，以及如何分词等设置。</p>
<p>重点：我们当然，后面会讲解，也可以手动在创建数据之前，先创建index，以及对应的mapping</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">GET  /website/_mapping/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;website&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;author_id&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;content&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;post_date&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;date&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;title&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试各种搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /website/_search?q=2019        0条结果             </span><br><span class="line">GET /website/_search?q=2019-01-01           1条结果</span><br><span class="line">GET /website/_search?q=post_date:2019-01-01     1条结果</span><br><span class="line">GET /website/_search?q=post_date:2019          0 条结果</span><br></pre></td></tr></table></figure>
<p>搜索结果为什么不一致，因为es自动建立mapping的时候，设置了不同的field不同的data type。不同的data type的分词、搜索等行为是不一样的。所以出现了_all field和post_date field的搜索表现完全不一样。</p>
<h2 id="10-2．-精确匹配与全文搜索的对比分析"><a href="#10-2．-精确匹配与全文搜索的对比分析" class="headerlink" title="10.2． 精确匹配与全文搜索的对比分析"></a>10.2． 精确匹配与全文搜索的对比分析</h2><h3 id="10-2-1-exact-value-精确匹配"><a href="#10-2-1-exact-value-精确匹配" class="headerlink" title="10.2.1 exact value 精确匹配"></a>10.2.1 exact value 精确匹配</h3><p>2019-01-01，exact value，搜索的时候，必须输入2019-01-01，才能搜索出来</p>
<p>如果你输入一个01，是搜索不出来的</p>
<p>select * from book where name= ‘java’</p>
<h3 id="10-2-2-full-text-全文检索"><a href="#10-2-2-full-text-全文检索" class="headerlink" title="10.2.2 full text 全文检索"></a>10.2.2 full text 全文检索</h3><p> 搜“笔记电脑”，笔记本电脑词条会不会出现。</p>
<p>select * from book where name like ‘%java%’</p>
<p>（1）缩写 vs. 全称：cn vs. china</p>
<p>（2）格式转化：like liked likes</p>
<p>（3）大小写：Tom vs tom</p>
<p>（4）同义词：like vs love</p>
<p>2019-01-01，2019 01 01，搜索2019，或者01，都可以搜索出来</p>
<p>china，搜索cn，也可以将china搜索出来</p>
<p>likes，搜索like，也可以将likes搜索出来</p>
<p>Tom，搜索tom，也可以将Tom搜索出来</p>
<p>like，搜索love，同义词，也可以将like搜索出来</p>
<p>就不是说单纯的只是匹配完整的一个值，而是可以对值进行拆分词语后（分词）进行匹配，也可以通过缩写、时态、大小写、同义词等进行匹配。深入 NPL,自然语义处理。</p>
<h2 id="10-3．-全文检索下倒排索引核心原理快速揭秘"><a href="#10-3．-全文检索下倒排索引核心原理快速揭秘" class="headerlink" title="10.3． 全文检索下倒排索引核心原理快速揭秘"></a>10.3． 全文检索下倒排索引核心原理快速揭秘</h2><p>doc1：I really liked my small dogs, and I think my mom also liked them.</p>
<p>doc2：He never liked any dogs, so I hope that my mom will not expect me to liked him.</p>
<h4 id="分词，初步的倒排索引的建立"><a href="#分词，初步的倒排索引的建立" class="headerlink" title="分词，初步的倒排索引的建立"></a>分词，初步的倒排索引的建立</h4><div class="table-container">
<table>
<thead>
<tr>
<th>term</th>
<th><strong>doc1</strong></th>
<th><strong>doc2</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>I</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>really</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>liked</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>my</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>small</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>dogs</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>and</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>think</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>mom</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>also</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>them</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>He</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>never</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>any</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>so</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>hope</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>that</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>will</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>not</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>expect</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>me</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>to</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>him</strong></td>
<td></td>
<td>*</td>
</tr>
</tbody>
</table>
</div>
<p>演示了一下倒排索引最简单的建立的一个过程</p>
<h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><p>mother like little dog，不可能有任何结果</p>
<p>mother</p>
<p>like</p>
<p>little</p>
<p>dog</p>
<p>这不是我们想要的结果。同义词mom\mother在我们人类看来是一样。想进行标准化操作。</p>
<h4 id="重建倒排索引"><a href="#重建倒排索引" class="headerlink" title="重建倒排索引"></a>重建倒排索引</h4><p>normalization正规化，建立倒排索引的时候，会执行一个操作，也就是说对拆分出的各个单词进行相应的处理，以提升后面搜索的时候能够搜索到相关联的文档的概率</p>
<p>时态的转换，单复数的转换，同义词的转换，大小写的转换</p>
<p>mom ―&gt; mother</p>
<p>liked ―&gt; like</p>
<p>small ―&gt; little</p>
<p>dogs ―&gt; dog</p>
<p>重新建立倒排索引，加入normalization，再次用mother liked little dog搜索，就可以搜索到了</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>word</strong></th>
<th><strong>doc1</strong></th>
<th><strong>doc2</strong></th>
<th><strong>normalization</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>I</strong></td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>really</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>like</strong></td>
<td>*</td>
<td>*</td>
<td>liked ―&gt; like</td>
</tr>
<tr>
<td><strong>my</strong></td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>little</strong></td>
<td>*</td>
<td></td>
<td>small ―&gt; little</td>
</tr>
<tr>
<td><strong>dog</strong></td>
<td>*</td>
<td></td>
<td>dogs ―&gt; dog</td>
</tr>
<tr>
<td><strong>and</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>think</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>mother</strong></td>
<td>*</td>
<td>*</td>
<td>mom ―&gt; mother</td>
</tr>
<tr>
<td><strong>also</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>them</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>He</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>never</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>any</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>so</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>hope</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>that</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>will</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>not</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>expect</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>me</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>to</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>him</strong></td>
<td></td>
<td>*</td>
</tr>
</tbody>
</table>
</div>
<h4 id="重新搜索"><a href="#重新搜索" class="headerlink" title="重新搜索"></a>重新搜索</h4><p>搜索：mother liked  little dog，</p>
<p> 对搜索条件经行分词 normalization</p>
<p>mother </p>
<p>liked  -》like</p>
<p> little </p>
<p>dog</p>
<p>doc1和doc2都会搜索出来</p>
<h2 id="10-4-分词器-analyzer"><a href="#10-4-分词器-analyzer" class="headerlink" title="10.4. 分词器 analyzer"></a>10.4. 分词器 analyzer</h2><h3 id="10-4-1什么是分词器-analyzer"><a href="#10-4-1什么是分词器-analyzer" class="headerlink" title="10.4.1什么是分词器 analyzer"></a>10.4.1什么是分词器 analyzer</h3><p>作用：切分词语，normalization（提升recall召回率）</p>
<p>给你一段句子，然后将这段句子拆分成一个一个的单个的单词，同时对每个单词进行normalization（时态转换，单复数转换）</p>
<p>recall，召回率：搜索的时候，增加能够搜索到的结果的数量</p>
<p>analyzer 组成部分：</p>
<p>1、character filter：在一段文本进行分词之前，先进行预处理，比如说最常见的就是，过滤html标签（<span>hello<span> —&gt; hello），&amp; —&gt; and（I&amp;you —&gt; I and you）</span></span></p>
<p>2、tokenizer：分词，hello you and me —&gt; hello, you, and, me</p>
<p>3、token filter：lowercase，stop word，synonymom，dogs —&gt; dog，liked —&gt; like，Tom —&gt; tom，a/the/an —&gt; 干掉，mother —&gt; mom，small —&gt; little</p>
<p>stop word 停用词： 了 的 呢。</p>
<p>一个分词器，很重要，将一段文本进行各种处理，最后处理好的结果才会拿去建立倒排索引。</p>
<h3 id="10-4-2内置分词器的介绍"><a href="#10-4-2内置分词器的介绍" class="headerlink" title="10.4.2内置分词器的介绍"></a>10.4.2内置分词器的介绍</h3><p>例句：Set the shape to semi-transparent by calling set_trans(5)</p>
<p>standard analyzer标准分词器：set, the, shape, to, semi, transparent, by, calling, set_trans, 5（默认的是standard）</p>
<p>simple analyzer简单分词器：set, the, shape, to, semi, transparent, by, calling, set, trans</p>
<p>whitespace analyzer：Set, the, shape, to, semi-transparent, by, calling, set_trans(5)</p>
<p>language analyzer（特定的语言的分词器，比如说，english，英语分词器）：set, shape, semi, transpar, call, set_tran, 5</p>
<p>官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.4/analysis-analyzers.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.4/analysis-analyzers.html</a></p>
<p><img src="/img/1568978200919.png" alt="1568978200919"></p>
<h2 id="10-5-query-string根据字段分词策略"><a href="#10-5-query-string根据字段分词策略" class="headerlink" title="10.5. query string根据字段分词策略"></a>10.5. query string根据字段分词策略</h2><h3 id="10-5-1query-string分词"><a href="#10-5-1query-string分词" class="headerlink" title="10.5.1query string分词"></a>10.5.1query string分词</h3><p>query string必须以和index建立时相同的analyzer进行分词</p>
<p>query string对exact value和full text的区别对待</p>
<p>如： date：exact value 精确匹配</p>
<p>​         text: full text 全文检索</p>
<h3 id="10-5-2测试分词器"><a href="#10-5-2测试分词器" class="headerlink" title="10.5.2测试分词器"></a>10.5.2测试分词器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Text to analyze 80&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;text&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;to&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 5,</span><br><span class="line">      &quot;end_offset&quot; : 7,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;analyze&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 8,</span><br><span class="line">      &quot;end_offset&quot; : 15,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;80&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 16,</span><br><span class="line">      &quot;end_offset&quot; : 18,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;NUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>token 实际存储的term 关键字</p>
<p>position 在此词条在原文本中的位置</p>
<p>start_offset/end_offset字符在原始字符串中的位置</p>
<h2 id="10-6．-mapping回顾总结"><a href="#10-6．-mapping回顾总结" class="headerlink" title="10.6． mapping回顾总结"></a>10.6． mapping回顾总结</h2><p>（1）往es里面直接插入数据，es会自动建立索引，同时建立对应的mapping。(dynamic mapping)</p>
<p>（2）mapping中就自动定义了每个field的数据类型</p>
<p>（3）不同的数据类型（比如说text和date），可能有的是exact value，有的是full text</p>
<p>（4）exact value，在建立倒排索引的时候，分词的时候，是将整个值一起作为一个关键词建立到倒排索引中的；full text，会经历各种各样的处理，分词，normaliztion（时态转换，同义词转换，大小写转换），才会建立到倒排索引中。</p>
<p>（5）同时呢，exact value和full text类型的field就决定了，在一个搜索过来的时候，对exact value field或者是full text field进行搜索的行为也是不一样的，会跟建立倒排索引的行为保持一致；比如说exact value搜索的时候，就是直接按照整个值进行匹配，full text query string，也会进行分词和normalization再去倒排索引中去搜索</p>
<p>（6）可以用es的dynamic mapping，让其自动建立mapping，包括自动设置数据类型；也可以提前手动创建index和tmapping，自己对各个field进行设置，包括数据类型，包括索引行为，包括分词器，等。</p>
<h2 id="10-7．-mapping的核心数据类型以及dynamic-mapping"><a href="#10-7．-mapping的核心数据类型以及dynamic-mapping" class="headerlink" title="10.7． mapping的核心数据类型以及dynamic mapping"></a>10.7． mapping的核心数据类型以及dynamic mapping</h2><h3 id="10-7-1-核心的数据类型"><a href="#10-7-1-核心的数据类型" class="headerlink" title="10.7.1 核心的数据类型"></a>10.7.1 核心的数据类型</h3><p>string :text and keyword</p>
<p>byte，short，integer，long,float，double</p>
<p>boolean</p>
<p>date</p>
<p>详见：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.3/mapping-types.html</a></p>
<p>下图是ES7.3核心的字段类型如下：</p>
<p><img src="/img/1568989192034.png" alt="1568989192034"></p>
<h3 id="10-7-2-dynamic-mapping-推测规则"><a href="#10-7-2-dynamic-mapping-推测规则" class="headerlink" title="10.7.2 dynamic mapping 推测规则"></a>10.7.2 dynamic mapping 推测规则</h3><p>true or false   —&gt; boolean</p>
<p>123     —&gt; long</p>
<p>123.45      —&gt; double</p>
<p>2019-01-01  —&gt; date</p>
<p>“hello world”   —&gt; text/keywod</p>
<h3 id="10-7-3-查看mapping"><a href="#10-7-3-查看mapping" class="headerlink" title="10.7.3 查看mapping"></a>10.7.3 查看mapping</h3><p>GET /index/_mapping/</p>
<h2 id="10-8-手动管理mapping"><a href="#10-8-手动管理mapping" class="headerlink" title="10.8 手动管理mapping"></a>10.8 手动管理mapping</h2><h3 id="10-8-1查询所有索引的映射"><a href="#10-8-1查询所有索引的映射" class="headerlink" title="10.8.1查询所有索引的映射"></a>10.8.1查询所有索引的映射</h3><p>GET /_mapping</p>
<h3 id="10-8-2-创建映射-！！"><a href="#10-8-2-创建映射-！！" class="headerlink" title="10.8.2 创建映射 ！！"></a>10.8.2 创建映射 ！！</h3><p>创建索引后，应该立即手动创建映射</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT book/_mapping</span><br><span class="line">&#123;</span><br><span class="line">	&quot;properties&quot;: &#123;</span><br><span class="line">           &quot;name&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">           &quot;description&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">              &quot;analyzer&quot;:&quot;english&quot;,</span><br><span class="line">              &quot;search_analyzer&quot;:&quot;english&quot;</span><br><span class="line">           &#125;,</span><br><span class="line">           &quot;pic&quot;:&#123;</span><br><span class="line">             &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">             &quot;index&quot;:false</span><br><span class="line">           &#125;,</span><br><span class="line">           &quot;studymodel&quot;:&#123;</span><br><span class="line">             &quot;type&quot;:&quot;text&quot;</span><br><span class="line">           &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Text-文本类型"><a href="#Text-文本类型" class="headerlink" title="Text 文本类型"></a>Text 文本类型</h4><p>1）analyzer</p>
<p>通过analyzer属性指定分词器。</p>
<p>上边指定了analyzer是指在索引和搜索都使用english，如果单独想定义搜索时使用的分词器则可以通过search_analyzer属性。</p>
<p>2）index</p>
<p>index属性指定是否索引。</p>
<p>默认为index=true，即要进行索引，只有进行索引才可以从索引库搜索到。</p>
<p>但是也有一些内容不需要索引，比如：商品图片地址只被用来展示图片，不进行搜索图片，此时可以将index设置为false。</p>
<p>删除索引，重新创建映射，将pic的index设置为false，尝试根据pic去搜索，结果搜索不到数据。</p>
<p>3）store</p>
<p>是否在source之外存储，每个文档索引后会在 ES中保存一份原始文档，存放在”_source”中，一般情况下不需要设置store为true，因为在_source中已经有一份原始文档了。</p>
<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT book/_mapping</span><br><span class="line">&#123;</span><br><span class="line">		&quot;properties&quot;: &#123;</span><br><span class="line">           &quot;name&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">           &quot;description&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">              &quot;analyzer&quot;:&quot;english&quot;,</span><br><span class="line">              &quot;search_analyzer&quot;:&quot;english&quot;</span><br><span class="line">           &#125;,</span><br><span class="line">           &quot;pic&quot;:&#123;</span><br><span class="line">             &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">             &quot;index&quot;:false</span><br><span class="line">           &#125;,</span><br><span class="line">           &quot;studymodel&quot;:&#123;</span><br><span class="line">             &quot;type&quot;:&quot;text&quot;</span><br><span class="line">           &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入文档：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;Bootstrap开发框架&quot;,</span><br><span class="line">  &quot;description&quot;:&quot;Bootstrap是由Twitter推出的一个前台页面开发框架，在行业之中使用较为广泛。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长页面开发的程序人员）轻松的实现一个不受浏览器限制的精美界面效果。&quot;,</span><br><span class="line">  &quot;pic&quot;:&quot;group1/M00/00/01/wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg&quot;,</span><br><span class="line">  &quot;studymodel&quot;:&quot;201002&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Get /book/_search?q=name:开发</p>
<p>Get  /book/_search?q=description:开发</p>
<p>Get /book/_search?q=pic:group1/M00/00/01/wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg</p>
<p>Get /book/_search?q=studymodel:201002</p>
<p>通过测试发现：name和description都支持全文检索，pic不可作为查询条件。</p>
<h4 id="keyword关键字字段"><a href="#keyword关键字字段" class="headerlink" title="keyword关键字字段"></a>keyword关键字字段</h4><p> 目前已经取代了”index”: false。上边介绍的text文本字段在映射时要设置分词器，keyword字段为关键字字段，通常搜索keyword是按照整体搜索，所以创建keyword字段的索引时是不进行分词的，比如：邮政编码、手机号码、身份证等。keyword字段通常用于过虑、排序、聚合等。</p>
<h4 id="date日期类型"><a href="#date日期类型" class="headerlink" title="date日期类型"></a>date日期类型</h4><p>日期类型不用设置分词器。</p>
<p>通常日期类型的字段用于排序。</p>
<p>format</p>
<p>通过format设置日期格式</p>
<p>例子：</p>
<p>下边的设置允许date字段存储年月日时分秒、年月日及毫秒三种格式。</p>
<p>{</p>
<p>​    “properties”: {</p>
<p>​        “timestamp”: {</p>
<p>​          “type”:   “date”,</p>
<p>​          “format”: “yyyy-MM-dd HH:mm:ss||yyyy-MM-dd”</p>
<p>​        }</p>
<p>​      }</p>
<p>}</p>
<p>插入文档：</p>
<p>Post book/doc/3 </p>
<p>{</p>
<p>“name”: “spring开发基础”,</p>
<p>“description”: “spring 在java领域非常流行，java程序员都在用。”,</p>
<p>“studymodel”: “201001”,</p>
<p> “pic”:”group1/M00/00/01/wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg”,</p>
<p> “timestamp”:”2018-07-04 18:28:58”</p>
<p>}</p>
<h4 id="数值类型"><a href="#数值类型" class="headerlink" title="数值类型"></a>数值类型</h4><p>下边是ES支持的数值类型</p>
<p><img src="/img/1568990520717.png" alt="1568990520717"></p>
<p>1、尽量选择范围小的类型，提高搜索效率</p>
<p>2、对于浮点数尽量用比例因子，比如一个价格字段，单位为元，我们将比例因子设置为100这在ES中会按 分 存储，映射如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;price&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;scaled_float&quot;,</span><br><span class="line">        &quot;scaling_factor&quot;: 100</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p>由于比例因子为100，如果我们输入的价格是23.45则ES中会将23.45乘以100存储在ES中。</p>
<p>如果输入的价格是23.456，ES会将23.456乘以100再取一个接近原始值的数，得出2346。</p>
<p>使用比例因子的好处是整型比浮点型更易压缩，节省磁盘空间。</p>
<p>如果比例因子不适合，则从下表选择范围小的去用：</p>
<p>更新已有映射，并插入文档：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT book/doc/3</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;spring开发基础&quot;,</span><br><span class="line">&quot;description&quot;: &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line"> &quot;pic&quot;:&quot;group1/M00/00/01/wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg&quot;,</span><br><span class="line"> &quot;timestamp&quot;:&quot;2018-07-04 18:28:58&quot;,</span><br><span class="line"> &quot;price&quot;:38.6</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="10-8-3修改映射"><a href="#10-8-3修改映射" class="headerlink" title="10.8.3修改映射"></a>10.8.3修改映射</h3><p>只能创建index时手动建立mapping，或者新增field mapping，但是不能update field mapping。</p>
<p>因为已有数据按照映射早已分词存储好。如果修改，那这些存量数据怎么办。</p>
<p>新增一个字段mapping</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_mapping/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot; : &#123;</span><br><span class="line">    &quot;new_field&quot; : &#123;</span><br><span class="line">      &quot;type&quot; :    &quot;text&quot;,</span><br><span class="line">     &quot;index&quot;:    &quot;false&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果修改mapping,会报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_mapping/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot; : &#123;</span><br><span class="line">    &quot;studymodel&quot; : &#123;</span><br><span class="line">     &quot;type&quot; :    &quot;keyword&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;illegal_argument_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;mapper [studymodel] of different type, current_type [text], merged_type [keyword]&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;illegal_argument_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;mapper [studymodel] of different type, current_type [text], merged_type [keyword]&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="10-8-4删除映射"><a href="#10-8-4删除映射" class="headerlink" title="10.8.4删除映射"></a>10.8.4删除映射</h3><p>通过删除索引来删除映射。</p>
<h2 id="10-9-复杂数据类型"><a href="#10-9-复杂数据类型" class="headerlink" title="10.9 复杂数据类型"></a>10.9 复杂数据类型</h2><h3 id="10-9-1-multivalue-field"><a href="#10-9-1-multivalue-field" class="headerlink" title="10.9 .1 multivalue field"></a>10.9 .1 multivalue field</h3><p>{ “tags”: [ “tag1”, “tag2” ]}</p>
<p>建立索引时与string是一样的，数据类型不能混</p>
<h3 id="10-9-2-empty-field"><a href="#10-9-2-empty-field" class="headerlink" title="10.9 .2. empty field"></a>10.9 .2. empty field</h3><p>null，[]，[null]</p>
<h3 id="10-9-3-object-field"><a href="#10-9-3-object-field" class="headerlink" title="10.9 .3. object field"></a>10.9 .3. object field</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT /company/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;address&quot;: &#123;</span><br><span class="line">    &quot;country&quot;: &quot;china&quot;,</span><br><span class="line">    &quot;province&quot;: &quot;guangdong&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;guangzhou&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;name&quot;: &quot;jack&quot;,</span><br><span class="line">  &quot;age&quot;: 27,</span><br><span class="line">  &quot;join_date&quot;: &quot;2019-01-01&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>address：object类型</p>
<p>查询映射</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">GET /company/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;company&quot; : &#123;</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;address&quot; : &#123;</span><br><span class="line">          &quot;properties&quot; : &#123;</span><br><span class="line">            &quot;city&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">              &quot;fields&quot; : &#123;</span><br><span class="line">                &quot;keyword&quot; : &#123;</span><br><span class="line">                  &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                  &quot;ignore_above&quot; : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;country&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">              &quot;fields&quot; : &#123;</span><br><span class="line">                &quot;keyword&quot; : &#123;</span><br><span class="line">                  &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                  &quot;ignore_above&quot; : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;province&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">              &quot;fields&quot; : &#123;</span><br><span class="line">                &quot;keyword&quot; : &#123;</span><br><span class="line">                  &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                  &quot;ignore_above&quot; : 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;join_date&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;date&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>object</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;address&quot;: &#123;</span><br><span class="line">    &quot;country&quot;: &quot;china&quot;,</span><br><span class="line">    &quot;province&quot;: &quot;guangdong&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;guangzhou&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;name&quot;: &quot;jack&quot;,</span><br><span class="line">  &quot;age&quot;: 27,</span><br><span class="line">  &quot;join_date&quot;: &quot;2017-01-01&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>底层存储格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:            [jack],</span><br><span class="line">    &quot;age&quot;:          [27],</span><br><span class="line">    &quot;join_date&quot;:      [2017-01-01],</span><br><span class="line">    &quot;address.country&quot;:         [china],</span><br><span class="line">    &quot;address.province&quot;:   [guangdong],</span><br><span class="line">    &quot;address.city&quot;:  [guangzhou]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对象数组：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;authors&quot;: [</span><br><span class="line">        &#123; &quot;age&quot;: 26, &quot;name&quot;: &quot;Jack White&quot;&#125;,</span><br><span class="line">        &#123; &quot;age&quot;: 55, &quot;name&quot;: &quot;Tom Jones&quot;&#125;,</span><br><span class="line">        &#123; &quot;age&quot;: 39, &quot;name&quot;: &quot;Kitty Smith&quot;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>存储格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;authors.age&quot;:    [26, 55, 39],</span><br><span class="line">    &quot;authors.name&quot;:   [jack, white, tom, jones, kitty, smith]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="11．-索引Index入门"><a href="#11．-索引Index入门" class="headerlink" title="11． 索引Index入门"></a>11． 索引Index入门</h1><h2 id="11-1．-索引管理"><a href="#11-1．-索引管理" class="headerlink" title="11.1． 索引管理"></a>11.1． 索引管理</h2><h3 id="11-1-1-为什么我们要手动创建索引"><a href="#11-1-1-为什么我们要手动创建索引" class="headerlink" title="11.1.1. 为什么我们要手动创建索引"></a>11.1.1. 为什么我们要手动创建索引</h3><p>直接put数据 PUT index/_doc/1,es会自动生成索引，并建立动态映射dynamic mapping。</p>
<p>在生产上，我们需要自己手动建立索引和映射，为了更好地管理索引。就像数据库的建表语句一样。</p>
<h3 id="11-1-2-索引管理"><a href="#11-1-2-索引管理" class="headerlink" title="11.1.2. 索引管理"></a>11.1.2. 索引管理</h3><h4 id="11-1-2-1-创建索引"><a href="#11-1-2-1-创建索引" class="headerlink" title="11.1.2.1 创建索引"></a>11.1.2.1 创建索引</h4><p>创建索引的语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT /index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123; ... any settings ... &#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">       &quot;properties&quot; : &#123;</span><br><span class="line">            &quot;field1&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;aliases&quot;: &#123;</span><br><span class="line">    	&quot;default_index&quot;: &#123;&#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1,</span><br><span class="line">    &quot;number_of_replicas&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;field1&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;field2&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;default_index&quot;: &#123;&#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>索引别名</strong></p>
<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">	&quot;field1&quot;:&quot;java&quot;,</span><br><span class="line">	&quot;field2&quot;:&quot;js&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询数据 都可以查到</p>
<p>GET /my_index/_doc/1</p>
<p>GET /default_index/_doc/1</p>
<h4 id="11-1-2-2查询索引"><a href="#11-1-2-2查询索引" class="headerlink" title="11.1.2.2查询索引"></a>11.1.2.2查询索引</h4><p>GET /my_index/_mapping</p>
<p>GET /my_index/_setting</p>
<h4 id="11-1-2-3修改索引"><a href="#11-1-2-3修改索引" class="headerlink" title="11.1.2.3修改索引"></a>11.1.2.3修改索引</h4><p>修改副本数</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index&quot; : &#123;</span><br><span class="line">        &quot;number_of_replicas&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11-1-2-4删除索引"><a href="#11-1-2-4删除索引" class="headerlink" title="11.1.2.4删除索引"></a>11.1.2.4删除索引</h4><p>DELETE /my_index</p>
<p>DELETE /index_one,index_two</p>
<p>DELETE /index_*</p>
<p>DELETE /_all</p>
<p>为了安全起见，防止恶意删除索引，删除时必须指定索引名：</p>
<p>elasticsearch.yml</p>
<p>action.destructive_requires_name: true</p>
<h2 id="11-2．-定制分词器"><a href="#11-2．-定制分词器" class="headerlink" title="11.2． 定制分词器"></a>11.2． 定制分词器</h2><h3 id="11-2-1-默认的分词器"><a href="#11-2-1-默认的分词器" class="headerlink" title="11.2.1 默认的分词器"></a>11.2.1 默认的分词器</h3><p>standard</p>
<p>分词三个组件，character filter，tokenizer，token filter</p>
<p>standard tokenizer：以单词边界进行切分</p>
<p>standard token filter：什么都不做</p>
<p>lowercase token filter：将所有字母转换为小写</p>
<p>stop token filer（默认被禁用）：移除停用词，比如a the it等等</p>
<h3 id="11-2-2-修改分词器的设置"><a href="#11-2-2-修改分词器的设置" class="headerlink" title="11.2.2 修改分词器的设置"></a>11.2.2 修改分词器的设置</h3><p>启用english停用词token filter</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;es_std&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;stopwords&quot;: &quot;_english_&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试分词</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;, </span><br><span class="line">  &quot;text&quot;: &quot;a dog is in the house&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;es_std&quot;,</span><br><span class="line">  &quot;text&quot;:&quot;a dog is in the house&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="11-2-3-定制化自己的分词器"><a href="#11-2-3-定制化自己的分词器" class="headerlink" title="11.2.3 定制化自己的分词器"></a>11.2.3 定制化自己的分词器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;char_filter&quot;: &#123;</span><br><span class="line">        &quot;&amp;_to_and&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;mapping&quot;,</span><br><span class="line">          &quot;mappings&quot;: [&quot;&amp;=&gt; and&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;my_stopwords&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;stop&quot;,</span><br><span class="line">          &quot;stopwords&quot;: [&quot;the&quot;, &quot;a&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_analyzer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [&quot;html_strip&quot;, &quot;&amp;_to_and&quot;],</span><br><span class="line">          &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;filter&quot;: [&quot;lowercase&quot;, &quot;my_stopwords&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;tom&amp;jerry are a friend in the house, &lt;a&gt;, HAHA!!&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置字段使用自定义分词器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_mapping/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;content&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;my_analyzer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="11-3-type底层结构及弃用原因"><a href="#11-3-type底层结构及弃用原因" class="headerlink" title="11.3 type底层结构及弃用原因"></a>11.3 type底层结构及弃用原因</h2><h3 id="11-3-1type是什么"><a href="#11-3-1type是什么" class="headerlink" title="11.3.1type是什么"></a>11.3.1type是什么</h3><p>type，是一个index中用来区分类似的数据的，类似的数据，但是可能有不同的fields，而且有不同的属性来控制索引建立、分词器.<br>        field的value，在底层的lucene中建立索引的时候，全部是opaque bytes类型，不区分类型的。<br>        lucene是没有type的概念的，在document中，实际上将type作为一个document的field来存储，即_type，es通过_type来进行type的过滤和筛选。</p>
<h3 id="11-3-2es中不同type存储机制"><a href="#11-3-2es中不同type存储机制" class="headerlink" title="11.3.2es中不同type存储机制"></a>11.3.2es中不同type存储机制</h3><p>一个index中的多个type，实际上是放在一起存储的，因此一个index下，不能有多个type重名，而类型或者其他设置不同的，因为那样是无法处理的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;goods&quot;: &#123;</span><br><span class="line">      &quot;mappings&quot;: &#123;</span><br><span class="line">         &quot;electronic_goods&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">               &quot;name&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">               &#125;,</span><br><span class="line">               &quot;price&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;double&quot;</span><br><span class="line">               &#125;,</span><br><span class="line">               &quot;service_period&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;string&quot;</span><br><span class="line">                   &#125;			</span><br><span class="line">                &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;fresh_goods&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">               &quot;name&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">               &#125;,</span><br><span class="line">               &quot;price&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;double&quot;</span><br><span class="line">               &#125;,</span><br><span class="line">               &quot;eat_period&quot;: &#123;</span><br><span class="line">              		&quot;type&quot;: &quot;string&quot;</span><br><span class="line">               &#125;</span><br><span class="line">                &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /goods/electronic_goods/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;小米空调&quot;,</span><br><span class="line">  &quot;price&quot;: 1999.0,</span><br><span class="line">  &quot;service_period&quot;: &quot;one year&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /goods/fresh_goods/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;澳洲龙虾&quot;,</span><br><span class="line">  &quot;price&quot;: 199.0,</span><br><span class="line">  &quot;eat_period&quot;: &quot;one week&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>es文档在底层的存储是这样子的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;goods&quot;: &#123;</span><br><span class="line">      &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;_type&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;index&quot;: &quot;false&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        &quot;price&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;double&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        &quot;service_period&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;eat_period&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>底层数据存储格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_type&quot;: &quot;electronic_goods&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;小米空调&quot;,</span><br><span class="line">  &quot;price&quot;: 1999.0,</span><br><span class="line">  &quot;service_period&quot;: &quot;one year&quot;,</span><br><span class="line">  &quot;eat_period&quot;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_type&quot;: &quot;fresh_goods&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;澳洲龙虾&quot;,</span><br><span class="line">  &quot;price&quot;: 199.0,</span><br><span class="line">  &quot;service_period&quot;: &quot;&quot;,</span><br><span class="line">  &quot;eat_period&quot;: &quot;one week&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="11-3-3-type弃用"><a href="#11-3-3-type弃用" class="headerlink" title="11.3.3 type弃用"></a>11.3.3 type弃用</h3><p>同一索引下，不同type的数据存储其他type的field 大量空值，造成资源浪费。</p>
<p>所以，不同类型数据，要放到不同的索引中。</p>
<p>es9中，将会彻底删除type。</p>
<h2 id="11-4-定制dynamic-mapping"><a href="#11-4-定制dynamic-mapping" class="headerlink" title="11.4.定制dynamic mapping"></a>11.4.定制dynamic mapping</h2><h3 id="11-4-1定制dynamic策略"><a href="#11-4-1定制dynamic策略" class="headerlink" title="11.4.1定制dynamic策略"></a>11.4.1定制dynamic策略</h3><p>true：遇到陌生字段，就进行dynamic mapping</p>
<p>false：新检测到的字段将被忽略。这些字段将不会被索引，因此将无法搜索，但仍将出现在返回点击的源字段中。这些字段不会添加到映射中，必须显式添加新字段。</p>
<p>strict：遇到陌生字段，就报错</p>
<p>创建mapping</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;dynamic&quot;: &quot;strict&quot;,</span><br><span class="line">       &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;address&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">          &quot;dynamic&quot;: &quot;true&quot;</span><br><span class="line">        &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;my article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my article&quot;,</span><br><span class="line">  &quot;address&quot;: &#123;</span><br><span class="line">    &quot;province&quot;: &quot;guangdong&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;guangzhou&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;strict_dynamic_mapping_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;mapping set to strict, dynamic introduction of [content] within [_doc] is not allowed&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;strict_dynamic_mapping_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;mapping set to strict, dynamic introduction of [content] within [_doc] is not allowed&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="11-4-2自定义-dynamic-mapping策略"><a href="#11-4-2自定义-dynamic-mapping策略" class="headerlink" title="11.4.2自定义 dynamic mapping策略"></a>11.4.2自定义 dynamic mapping策略</h3><p>es会根据传入的值，推断类型。</p>
<p><img src="/img/1569123478530.png" alt="1569123478530"></p>
<h4 id="date-detection-日期探测"><a href="#date-detection-日期探测" class="headerlink" title="date_detection 日期探测"></a>date_detection 日期探测</h4><p>默认会按照一定格式识别date，比如yyyy-MM-dd。但是如果某个field先过来一个2017-01-01的值，就会被自动dynamic mapping成date，后面如果再来一个”hello world”之类的值，就会报错。可以手动关闭某个type的date_detection，如果有需要，自己手动指定某个field为date类型。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;date_detection&quot;: false,</span><br><span class="line">       &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;address&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">          &quot;dynamic&quot;: &quot;true&quot;</span><br><span class="line">        &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;my article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my article&quot;,</span><br><span class="line">  &quot;address&quot;: &#123;</span><br><span class="line">    &quot;province&quot;: &quot;guangdong&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;guangzhou&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;post_date&quot;:&quot;2019-09-10&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看映射</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_mapping</span><br></pre></td></tr></table></figure>
<h4 id="自定义日期格式"><a href="#自定义日期格式" class="headerlink" title="自定义日期格式"></a>自定义日期格式</h4><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_date_formats&quot;: [&quot;MM/dd/yyyy&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入数据</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;create_date&quot;: &quot;09/25/2019&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="numeric-detection-数字探测"><a href="#numeric-detection-数字探测" class="headerlink" title="numeric_detection 数字探测"></a>numeric_detection 数字探测</h4><p>虽然json支持本机浮点和整数数据类型，但某些应用程序或语言有时可能将数字呈现为字符串。通常正确的解决方案是显式地映射这些字段，但是可以启用数字检测（默认情况下禁用）来自动完成这些操作。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;numeric_detection&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;my_float&quot;:   &quot;1.0&quot;, </span><br><span class="line">  &quot;my_integer&quot;: &quot;1&quot; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="11-4-3定制自己的dynamic-mapping-template"><a href="#11-4-3定制自己的dynamic-mapping-template" class="headerlink" title="11.4.3定制自己的dynamic mapping template"></a>11.4.3定制自己的dynamic mapping template</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">            &quot;dynamic_templates&quot;: [</span><br><span class="line">                &#123; </span><br><span class="line">                  &quot;en&quot;: &#123;</span><br><span class="line">                      &quot;match&quot;:              &quot;*_en&quot;, </span><br><span class="line">                      &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">                      &quot;mapping&quot;: &#123;</span><br><span class="line">                          &quot;type&quot;:           &quot;text&quot;,</span><br><span class="line">                          &quot;analyzer&quot;:       &quot;english&quot;</span><br><span class="line">                      &#125;</span><br><span class="line">                &#125;                  </span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;this is my first article&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title_en&quot;: &quot;this is my first article&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_search?q=first</span><br><span class="line">GET my_index/_search?q=is</span><br></pre></td></tr></table></figure>
<p>title没有匹配到任何的dynamic模板，默认就是standard分词器，不会过滤停用词，is会进入倒排索引，用is来搜索是可以搜索到的</p>
<p>title_en匹配到了dynamic模板，就是english分词器，会过滤停用词，is这种停用词就会被过滤掉，用is来搜索就搜索不到了</p>
<h4 id="模板写法"><a href="#模板写法" class="headerlink" title="模板写法"></a>模板写法</h4><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic_templates&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;integers&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;long&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;strings&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;raw&quot;: &#123;</span><br><span class="line">                &quot;type&quot;:  &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>模板参数</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;match&quot;:   &quot;long_*&quot;,</span><br><span class="line">&quot;unmatch&quot;: &quot;*_text&quot;,</span><br><span class="line">&quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">&quot;path_match&quot;:   &quot;name.*&quot;,</span><br><span class="line">&quot;path_unmatch&quot;: &quot;*.middle&quot;,</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;match_pattern&quot;</span>: <span class="string">&quot;regex&quot;</span>,</span><br><span class="line"><span class="string">&quot;match&quot;</span>: <span class="string">&quot;^profit_\d+$&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>1结构化搜索</p>
<p>默认情况下，elasticsearch将字符串字段映射为带有子关键字字段的文本字段。但是，如果只对结构化内容进行索引，而对全文搜索不感兴趣，则可以仅将“字段”映射为“关键字”。请注意，这意味着为了搜索这些字段，必须搜索索引所用的完全相同的值。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">       &quot;strings_as_keywords&quot;: &#123;</span><br><span class="line">         &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">         &quot;mapping&quot;: &#123;</span><br><span class="line">           &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>2仅搜索</p>
<p>与前面的示例相反，如果您只关心字符串字段的全文搜索，并且不打算对字符串字段运行聚合、排序或精确搜索，您可以告诉弹性搜索将其仅映射为文本字段（这是5之前的默认行为）</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">       &quot;strings_as_text&quot;: &#123;</span><br><span class="line">         &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">         &quot;mapping&quot;: &#123;</span><br><span class="line">           &quot;type&quot;: &quot;text&quot;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>3norms 不关心评分</p>
<p>norms是指标时间的评分因素。如果您不关心评分，例如，如果您从不按评分对文档进行排序，则可以在索引中禁用这些评分因子的存储并节省一些空间。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;strings_as_keywords&quot;: &#123;</span><br><span class="line">          &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;mapping&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;norms&quot;: false,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h2 id="11-5．-零停机重建索引"><a href="#11-5．-零停机重建索引" class="headerlink" title="11.5． 零停机重建索引"></a>11.5． 零停机重建索引</h2><h3 id="11-5-1零停机重建索引"><a href="#11-5-1零停机重建索引" class="headerlink" title="11.5.1零停机重建索引"></a>11.5.1零停机重建索引</h3><p>场景：</p>
<p>一个field的设置是不能被修改的，如果要修改一个Field，那么应该重新按照新的mapping，建立一个index，然后将数据批量查询出来，重新用bulk api写入index中。</p>
<p>批量查询的时候，建议采用scroll api，并且采用多线程并发的方式来reindex数据，每次scoll就查询指定日期的一段数据，交给一个线程即可。</p>
<p>(1)一开始，依靠dynamic mapping，插入数据，但是不小心有些数据是2019-09-10这种日期格式的，所以title这种field被自动映射为了date类型，实际上它应该是string类型的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;2019-09-10&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;2019-09-11&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）当后期向索引中加入string类型的title值的时候，就会报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;my first article&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;mapper_parsing_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;failed to parse [title]&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;mapper_parsing_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;failed to parse [title]&quot;,</span><br><span class="line">    &quot;caused_by&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;illegal_argument_exception&quot;,</span><br><span class="line">      &quot;reason&quot;: &quot;Invalid format: \&quot;my first article\&quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）如果此时想修改title的类型，是不可能的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;title&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;</span><br><span class="line">   	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;illegal_argument_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;mapper [title] of different type, current_type [date], merged_type [text]&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;illegal_argument_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;mapper [title] of different type, current_type [date], merged_type [text]&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）此时，唯一的办法，就是进行reindex，也就是说，重新建立一个索引，将旧索引的数据查询出来，再导入新索引。</p>
<p>（5）如果说旧索引的名字，是old_index，新索引的名字是new_index，终端java应用，已经在使用old_index在操作了，难道还要去停止java应用，修改使用的index为new_index，才重新启动java应用吗？这个过程中，就会导致java应用停机，可用性降低。</p>
<p>（6）所以说，给java应用一个别名，这个别名是指向旧索引的，java应用先用着，java应用先用prod_index alias来操作，此时实际指向的是旧的my_index</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_alias/prod_index</span><br></pre></td></tr></table></figure>
<p>（7）新建一个index，调整其title的类型为string</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index_new</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">		&quot;title&quot;: &#123;</span><br><span class="line">         &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（8）使用scroll api将数据批量查询出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;,    </span><br><span class="line">    &quot;size&quot;:  1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_scroll_id&quot;: &quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAADpAFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAA6QRY0b25zVFlWWlRqR3ZJajlfc3BXejJ3AAAAAAAAOkIWNG9uc1RZVlpUakd2SWo5X3NwV3oydwAAAAAAADpDFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAA6RBY0b25zVFlWWlRqR3ZJajlfc3BXejJ3&quot;,</span><br><span class="line">  &quot;took&quot;: 1,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 3,</span><br><span class="line">    &quot;max_score&quot;: null,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;my_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;my_type&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: null,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;2019-01-02&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sort&quot;: [</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（9）采用bulk api将scoll查出来的一批数据，批量写入新索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; &quot;index&quot;:  &#123; &quot;_index&quot;: &quot;my_index_new&quot;, &quot;_id&quot;: &quot;1&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;:    &quot;2019-09-10&quot; &#125;</span><br></pre></td></tr></table></figure>
<p>（10）反复循环8~9，查询一批又一批的数据出来，采取bulk api将每一批数据批量写入新索引</p>
<p>（11）将prod_index alias切换到my_index_new上去，java应用会直接通过index别名使用新的索引中的数据，java应用程序不需要停机，零提交，高可用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot;: [</span><br><span class="line">        &#123; &quot;remove&quot;: &#123; &quot;index&quot;: &quot;my_index&quot;, &quot;alias&quot;: &quot;prod_index&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;add&quot;:    &#123; &quot;index&quot;: &quot;my_index_new&quot;, &quot;alias&quot;: &quot;prod_index&quot; &#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（12）直接通过prod_index别名来查询，是否ok</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /prod_index/_search</span><br></pre></td></tr></table></figure>
<h3 id="11-5-2-生产实践：基于alias对client透明切换index"><a href="#11-5-2-生产实践：基于alias对client透明切换index" class="headerlink" title="11.5.2 生产实践：基于alias对client透明切换index"></a>11.5.2 生产实践：基于alias对client透明切换index</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index_v1/_alias/my_index</span><br></pre></td></tr></table></figure>
<p>client对my_index进行操作</p>
<p>reindex操作，完成之后，切换v1到v2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot;: [</span><br><span class="line">        &#123; &quot;remove&quot;: &#123; &quot;index&quot;: &quot;my_index_v1&quot;, &quot;alias&quot;: &quot;my_index&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;add&quot;:    &#123; &quot;index&quot;: &quot;my_index_v2&quot;, &quot;alias&quot;: &quot;my_index&quot; &#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="12．-中文分词器-IK分词器"><a href="#12．-中文分词器-IK分词器" class="headerlink" title="12． 中文分词器 IK分词器"></a>12． 中文分词器 IK分词器</h1><h2 id="12-1．-Ik分词器安装使用"><a href="#12-1．-Ik分词器安装使用" class="headerlink" title="12.1． Ik分词器安装使用"></a>12.1． Ik分词器安装使用</h2><h3 id="12-1-1-中文分词器"><a href="#12-1-1-中文分词器" class="headerlink" title="12.1.1 中文分词器"></a>12.1.1 中文分词器</h3><p>standard 分词器，仅适用于英文。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;中华人民共和国人民大会堂&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们想要的效果是什么：中华人民共和国，人民大会堂</p>
<p>IK分词器就是目前最流行的es中文分词器</p>
<h3 id="12-1-2-安装"><a href="#12-1-2-安装" class="headerlink" title="12.1.2 安装"></a>12.1.2 安装</h3><p>官网：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>
<p>根据es版本下载相应版本包。</p>
<p>解压到 es/plugins/ik中。</p>
<p>重启es</p>
<h3 id="12-1-3-ik分词器基础知识"><a href="#12-1-3-ik分词器基础知识" class="headerlink" title="12.1.3 ik分词器基础知识"></a>12.1.3 ik分词器基础知识</h3><p>ik_max_word: 会将文本做最细粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民共和国，中华人民，中华，华人，人民共和国，人民大会堂，人民大会，大会堂”，会穷尽各种可能的组合；</p>
<p>ik_smart: 会做最粗粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民共和国，人民大会堂”。</p>
<h3 id="12-1-4-ik分词器的使用"><a href="#12-1-4-ik分词器的使用" class="headerlink" title="12.1.4 ik分词器的使用"></a>12.1.4 ik分词器的使用</h3><p>存储时，使用ik_max_word，搜索时，使用ik_smart</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index </span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;text&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search?q=中华人民共和国人民大会堂</span><br></pre></td></tr></table></figure>
<h2 id="12-2-ik配置文件"><a href="#12-2-ik配置文件" class="headerlink" title="12.2. ik配置文件"></a>12.2. ik配置文件</h2><h3 id="12-2-1-ik配置文件"><a href="#12-2-1-ik配置文件" class="headerlink" title="12.2.1 ik配置文件"></a>12.2.1 ik配置文件</h3><p>ik配置文件地址：es/plugins/ik/config目录</p>
<p>IKAnalyzer.cfg.xml：用来配置自定义词库</p>
<p>main.dic：ik原生内置的中文词库，总共有27万多条，只要是这些单词，都会被分在一起</p>
<p>preposition.dic: 介词</p>
<p>quantifier.dic：放了一些单位相关的词，量词</p>
<p>suffix.dic：放了一些后缀</p>
<p>surname.dic：中国的姓氏</p>
<p>stopword.dic：英文停用词</p>
<p>ik原生最重要的两个配置文件</p>
<p>main.dic：包含了原生的中文词语，会按照这个里面的词语去分词</p>
<p>stopword.dic：包含了英文的停用词</p>
<p>停用词，stopword</p>
<p>a the and at but</p>
<p>一般，像停用词，会在分词的时候，直接被干掉，不会建立在倒排索引中</p>
<h3 id="12-2-1-自定义词库"><a href="#12-2-1-自定义词库" class="headerlink" title="12.2.1 自定义词库"></a>12.2.1 自定义词库</h3><p>（1）自己建立词库：每年都会涌现一些特殊的流行词，网红，蓝瘦香菇，喊麦，鬼畜，一般不会在ik的原生词典里</p>
<p>自己补充自己的最新的词语，到ik的词库里面</p>
<p>IKAnalyzer.cfg.xml：ext_dict，创建mydict.dic。</p>
<p>补充自己的词语，然后需要重启es，才能生效</p>
<p>（2）自己建立停用词库：比如了，的，啥，么，我们可能并不想去建立索引，让人家搜索</p>
<p>custom/ext_stopword.dic，已经有了常用的中文停用词，可以补充自己的停用词，然后重启es</p>
<h2 id="12-3．-使用mysql热更新-词库"><a href="#12-3．-使用mysql热更新-词库" class="headerlink" title="12.3． 使用mysql热更新 词库"></a>12.3． 使用mysql热更新 词库</h2><h3 id="12-3-1热更新"><a href="#12-3-1热更新" class="headerlink" title="12.3.1热更新"></a>12.3.1热更新</h3><p>每次都是在es的扩展词典中，手动添加新词语，很坑</p>
<p>（1）每次添加完，都要重启es才能生效，非常麻烦</p>
<p>（2）es是分布式的，可能有数百个节点，你不能每次都一个一个节点上面去修改</p>
<p>es不停机，直接我们在外部某个地方添加新的词语，es中立即热加载到这些新词语</p>
<p>热更新的方案</p>
<p>（1）基于ik分词器原生支持的热更新方案，部署一个web服务器，提供一个http接口，通过modified和tag两个http响应头，来提供词语的热更新</p>
<p>（2）修改ik分词器源码，然后手动支持从mysql中每隔一定时间，自动加载新的词库</p>
<p>用第二种方案，第一种，ik git社区官方都不建议采用，觉得不太稳定</p>
<h3 id="12-3-2步骤"><a href="#12-3-2步骤" class="headerlink" title="12.3.2步骤"></a>12.3.2步骤</h3><p>1、下载源码</p>
<p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>
<p>ik分词器，是个标准的java maven工程，直接导入eclipse就可以看到源码</p>
<p>2、修改源</p>
<p>org.wltea.analyzer.dic.Dictionary类，160行Dictionary单例类的初始化方法，在这里需要创建一个我们自定义的线程，并且启动它</p>
<p>org.wltea.analyzer.dic.HotDictReloadThread类：就是死循环，不断调用Dictionary.getSingleton().reLoadMainDict()，去重新加载词典</p>
<p>Dictionary类，399行：this.loadMySQLExtDict(); 加载mymsql字典。</p>
<p>Dictionary类，609行：this.loadMySQLStopwordDict();加载mysql停用词</p>
<p>config下jdbc-reload.properties。mysql配置文件</p>
<p>3、mvn package打包代码</p>
<p>target\releases\elasticsearch-analysis-ik-7.3.0.zip</p>
<p>4、解压缩ik压缩包</p>
<p>将mysql驱动jar，放入ik的目录下</p>
<p>5、修改jdbc相关配置</p>
<p>6、重启es</p>
<p>观察日志，日志中就会显示我们打印的那些东西，比如加载了什么配置，加载了什么词语，什么停用词</p>
<p>7、在mysql中添加词库与停用词</p>
<p>8、分词实验，验证热更新生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;传智播客&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="13．-java-api-实现索引管理"><a href="#13．-java-api-实现索引管理" class="headerlink" title="13． java api 实现索引管理"></a>13． java api 实现索引管理</h1><p>代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line">package com.itheima.es;</span><br><span class="line"></span><br><span class="line">import org.elasticsearch.action.ActionListener;</span><br><span class="line">import org.elasticsearch.action.admin.indices.alias.Alias;</span><br><span class="line">import org.elasticsearch.action.admin.indices.close.CloseIndexRequest;</span><br><span class="line">import org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;</span><br><span class="line">import org.elasticsearch.action.admin.indices.open.OpenIndexRequest;</span><br><span class="line">import org.elasticsearch.action.admin.indices.open.OpenIndexResponse;</span><br><span class="line">import org.elasticsearch.action.support.ActiveShardCount;</span><br><span class="line">import org.elasticsearch.action.support.master.AcknowledgedResponse;</span><br><span class="line">import org.elasticsearch.client.IndicesClient;</span><br><span class="line">import org.elasticsearch.client.RequestOptions;</span><br><span class="line">import org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">import org.elasticsearch.client.indices.CreateIndexRequest;</span><br><span class="line">import org.elasticsearch.client.indices.CreateIndexResponse;</span><br><span class="line">import org.elasticsearch.client.indices.GetIndexRequest;</span><br><span class="line">import org.elasticsearch.common.settings.Settings;</span><br><span class="line">import org.elasticsearch.common.unit.TimeValue;</span><br><span class="line">import org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.junit.runner.RunWith;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line">import org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"></span><br><span class="line">- @author Administrator</span><br><span class="line"></span><br><span class="line">- @version 1.0</span><br><span class="line">  **/</span><br><span class="line">  @SpringBootTest</span><br><span class="line">  @RunWith(SpringRunner.class)</span><br><span class="line">  public class TestIndex &#123;</span><br><span class="line"></span><br><span class="line">  @Autowired</span><br><span class="line">  RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">//    @Autowired</span><br><span class="line">//    RestClient restClient;</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line">//创建索引</span><br><span class="line">@Test</span><br><span class="line">public void testCreateIndex() throws IOException &#123;</span><br><span class="line">    //创建索引对象</span><br><span class="line">    CreateIndexRequest createIndexRequest = new CreateIndexRequest(&quot;itheima_book&quot;);</span><br><span class="line">    //设置参数</span><br><span class="line">    createIndexRequest.settings(Settings.builder().put(&quot;number_of_shards&quot;, &quot;1&quot;).put(&quot;number_of_replicas&quot;, &quot;0&quot;));</span><br><span class="line">    //指定映射1</span><br><span class="line">    createIndexRequest.mapping(&quot; &#123;\n&quot; +</span><br><span class="line">            &quot; \t\&quot;properties\&quot;: &#123;\n&quot; +</span><br><span class="line">            &quot;            \&quot;name\&quot;:&#123;\n&quot; +</span><br><span class="line">            &quot;             \&quot;type\&quot;:\&quot;keyword\&quot;\n&quot; +</span><br><span class="line">            &quot;           &#125;,\n&quot; +</span><br><span class="line">            &quot;           \&quot;description\&quot;: &#123;\n&quot; +</span><br><span class="line">            &quot;              \&quot;type\&quot;: \&quot;text\&quot;\n&quot; +</span><br><span class="line">            &quot;           &#125;,\n&quot; +</span><br><span class="line">            &quot;            \&quot;price\&quot;:&#123;\n&quot; +</span><br><span class="line">            &quot;             \&quot;type\&quot;:\&quot;long\&quot;\n&quot; +</span><br><span class="line">            &quot;           &#125;,\n&quot; +</span><br><span class="line">            &quot;           \&quot;pic\&quot;:&#123;\n&quot; +</span><br><span class="line">            &quot;             \&quot;type\&quot;:\&quot;text\&quot;,\n&quot; +</span><br><span class="line">            &quot;             \&quot;index\&quot;:false\n&quot; +</span><br><span class="line">            &quot;           &#125;\n&quot; +</span><br><span class="line">            &quot; \t&#125;\n&quot; +</span><br><span class="line">            &quot;&#125;&quot;, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">    //指定映射2</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">//        Map&lt;String, Object&gt; message = new HashMap&lt;&gt;();</span><br><span class="line">//        message.put(&quot;type&quot;, &quot;text&quot;);</span><br><span class="line">//        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span><br><span class="line">//        properties.put(&quot;message&quot;, message);</span><br><span class="line">//        Map&lt;String, Object&gt; mapping = new HashMap&lt;&gt;();</span><br><span class="line">//        mapping.put(&quot;properties&quot;, properties);</span><br><span class="line">//        createIndexRequest.mapping(mapping);</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line">    //指定映射3</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">//        XContentBuilder builder = XContentFactory.jsonBuilder();</span><br><span class="line">//        builder.startObject();</span><br><span class="line">//        &#123;</span><br><span class="line">//            builder.startObject(&quot;properties&quot;);</span><br><span class="line">//            &#123;</span><br><span class="line">//                builder.startObject(&quot;message&quot;);</span><br><span class="line">//                &#123;</span><br><span class="line">//                    builder.field(&quot;type&quot;, &quot;text&quot;);</span><br><span class="line">//                &#125;</span><br><span class="line">//                builder.endObject();</span><br><span class="line">//            &#125;</span><br><span class="line">//            builder.endObject();</span><br><span class="line">//        &#125;</span><br><span class="line">//        builder.endObject();</span><br><span class="line">//        createIndexRequest.mapping(builder);</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line">    //设置别名</span><br><span class="line">    createIndexRequest.alias(new Alias(&quot;itheima_index_new&quot;));</span><br><span class="line"></span><br><span class="line">    // 额外参数</span><br><span class="line">    //设置超时时间</span><br><span class="line">    createIndexRequest.setTimeout(TimeValue.timeValueMinutes(2));</span><br><span class="line">    //设置主节点超时时间</span><br><span class="line">    createIndexRequest.setMasterTimeout(TimeValue.timeValueMinutes(1));</span><br><span class="line">    //在创建索引API返回响应之前等待的活动分片副本的数量，以int形式表示</span><br><span class="line">    createIndexRequest.waitForActiveShards(ActiveShardCount.from(2));</span><br><span class="line">    createIndexRequest.waitForActiveShards(ActiveShardCount.DEFAULT);</span><br><span class="line"></span><br><span class="line">    //操作索引的客户端</span><br><span class="line">    IndicesClient indices = client.indices();</span><br><span class="line">    //执行创建索引库</span><br><span class="line">    CreateIndexResponse createIndexResponse = indices.create(createIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    //得到响应（全部）</span><br><span class="line">    boolean acknowledged = createIndexResponse.isAcknowledged();</span><br><span class="line">    //得到响应 指示是否在超时前为索引中的每个分片启动了所需数量的碎片副本</span><br><span class="line">    boolean shardsAcknowledged = createIndexResponse.isShardsAcknowledged();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot; + acknowledged);</span><br><span class="line">    System.out.println(shardsAcknowledged);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//异步新增索引</span><br><span class="line">@Test</span><br><span class="line">public void testCreateIndexAsync() throws IOException &#123;</span><br><span class="line">    //创建索引对象</span><br><span class="line">    CreateIndexRequest createIndexRequest = new CreateIndexRequest(&quot;itheima_book2&quot;);</span><br><span class="line">    //设置参数</span><br><span class="line">    createIndexRequest.settings(Settings.builder().put(&quot;number_of_shards&quot;, &quot;1&quot;).put(&quot;number_of_replicas&quot;, &quot;0&quot;));</span><br><span class="line">    //指定映射1</span><br><span class="line">    createIndexRequest.mapping(&quot; &#123;\n&quot; +</span><br><span class="line">            &quot; \t\&quot;properties\&quot;: &#123;\n&quot; +</span><br><span class="line">            &quot;            \&quot;name\&quot;:&#123;\n&quot; +</span><br><span class="line">            &quot;             \&quot;type\&quot;:\&quot;keyword\&quot;\n&quot; +</span><br><span class="line">            &quot;           &#125;,\n&quot; +</span><br><span class="line">            &quot;           \&quot;description\&quot;: &#123;\n&quot; +</span><br><span class="line">            &quot;              \&quot;type\&quot;: \&quot;text\&quot;\n&quot; +</span><br><span class="line">            &quot;           &#125;,\n&quot; +</span><br><span class="line">            &quot;            \&quot;price\&quot;:&#123;\n&quot; +</span><br><span class="line">            &quot;             \&quot;type\&quot;:\&quot;long\&quot;\n&quot; +</span><br><span class="line">            &quot;           &#125;,\n&quot; +</span><br><span class="line">            &quot;           \&quot;pic\&quot;:&#123;\n&quot; +</span><br><span class="line">            &quot;             \&quot;type\&quot;:\&quot;text\&quot;,\n&quot; +</span><br><span class="line">            &quot;             \&quot;index\&quot;:false\n&quot; +</span><br><span class="line">            &quot;           &#125;\n&quot; +</span><br><span class="line">            &quot; \t&#125;\n&quot; +</span><br><span class="line">            &quot;&#125;&quot;, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">    //监听方法</span><br><span class="line">    ActionListener&lt;CreateIndexResponse&gt; listener =</span><br><span class="line">            new ActionListener&lt;CreateIndexResponse&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void onResponse(CreateIndexResponse createIndexResponse) &#123;</span><br><span class="line">                    System.out.println(&quot;!!!!!!!!创建索引成功&quot;);</span><br><span class="line">                    System.out.println(createIndexResponse.toString());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void onFailure(Exception e) &#123;</span><br><span class="line">                    System.out.println(&quot;!!!!!!!!创建索引失败&quot;);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">    //操作索引的客户端</span><br><span class="line">    IndicesClient indices = client.indices();</span><br><span class="line">    //执行创建索引库</span><br><span class="line">    indices.createAsync(createIndexRequest, RequestOptions.DEFAULT, listener);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line">&#125;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line">//删除索引库</span><br><span class="line">@Test</span><br><span class="line">public void testDeleteIndex() throws IOException &#123;</span><br><span class="line">    //删除索引对象</span><br><span class="line">    DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest(&quot;itheima_book2&quot;);</span><br><span class="line">    //操作索引的客户端</span><br><span class="line">    IndicesClient indices = client.indices();</span><br><span class="line">    //执行删除索引</span><br><span class="line">    AcknowledgedResponse delete = indices.delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    //得到响应</span><br><span class="line">    boolean acknowledged = delete.isAcknowledged();</span><br><span class="line">    System.out.println(acknowledged);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//异步删除索引库</span><br><span class="line">@Test</span><br><span class="line">public void testDeleteIndexAsync() throws IOException &#123;</span><br><span class="line">    //删除索引对象</span><br><span class="line">    DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest(&quot;itheima_book2&quot;);</span><br><span class="line">    //操作索引的客户端</span><br><span class="line">    IndicesClient indices = client.indices();</span><br><span class="line"></span><br><span class="line">    //监听方法</span><br><span class="line">    ActionListener&lt;AcknowledgedResponse&gt; listener =</span><br><span class="line">            new ActionListener&lt;AcknowledgedResponse&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void onResponse(AcknowledgedResponse deleteIndexResponse) &#123;</span><br><span class="line">                    System.out.println(&quot;!!!!!!!!删除索引成功&quot;);</span><br><span class="line">                    System.out.println(deleteIndexResponse.toString());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void onFailure(Exception e) &#123;</span><br><span class="line">                    System.out.println(&quot;!!!!!!!!删除索引失败&quot;);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">    //执行删除索引</span><br><span class="line">    indices.deleteAsync(deleteIndexRequest, RequestOptions.DEFAULT, listener);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Indices Exists API</span><br><span class="line">@Test</span><br><span class="line">public void testExistIndex() throws IOException &#123;</span><br><span class="line">    GetIndexRequest request = new GetIndexRequest(&quot;itheima_book&quot;);</span><br><span class="line">    request.local(false);//从主节点返回本地信息或检索状态</span><br><span class="line">    request.humanReadable(true);//以适合人类的格式返回结果</span><br><span class="line">    request.includeDefaults(false);//是否返回每个索引的所有默认设置</span><br><span class="line"></span><br><span class="line">    boolean exists = client.indices().exists(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(exists);</span><br><span class="line">&#125;</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">​```</span><br><span class="line">// Indices Open API</span><br><span class="line">@Test</span><br><span class="line">public void testOpenIndex() throws IOException &#123;</span><br><span class="line">    OpenIndexRequest request = new OpenIndexRequest(&quot;itheima_book&quot;);</span><br><span class="line"></span><br><span class="line">    OpenIndexResponse openIndexResponse = client.indices().open(request, RequestOptions.DEFAULT);</span><br><span class="line">    boolean acknowledged = openIndexResponse.isAcknowledged();</span><br><span class="line">    System.out.println(&quot;!!!!!!!!!&quot;+acknowledged);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Indices Close API</span><br><span class="line">@Test</span><br><span class="line">public void testCloseIndex() throws IOException &#123;</span><br><span class="line">    CloseIndexRequest request = new CloseIndexRequest(&quot;index&quot;);</span><br><span class="line">    AcknowledgedResponse closeIndexResponse = client.indices().close(request, RequestOptions.DEFAULT);</span><br><span class="line">    boolean acknowledged = closeIndexResponse.isAcknowledged();</span><br><span class="line">    System.out.println(&quot;!!!!!!!!!&quot;+acknowledged);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="14．-search搜索入门"><a href="#14．-search搜索入门" class="headerlink" title="14． search搜索入门"></a>14． search搜索入门</h1><h2 id="14-1．-搜索语法入门"><a href="#14-1．-搜索语法入门" class="headerlink" title="14.1． 搜索语法入门"></a>14.1． 搜索语法入门</h2><h3 id="14-1-1query-string-search"><a href="#14-1-1query-string-search" class="headerlink" title="14.1.1query string search"></a>14.1.1query string search</h3><p>无条件搜索所有 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 969,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 3,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;Bootstrap开发&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201002&quot;,</span><br><span class="line">          &quot;price&quot; : 38.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;bootstrap&quot;,</span><br><span class="line">            &quot;dev&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;java编程思想&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 68.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;java&quot;,</span><br><span class="line">            &quot;dev&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;spring开发基础&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 88.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-24 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;spring&quot;,</span><br><span class="line">            &quot;java&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释</p>
<p>took：耗费了几毫秒</p>
<p>timed_out：是否超时，这里是没有</p>
<p>_shards：到几个分片搜索，成功几个，跳过几个，失败几个。 </p>
<p>hits.total：查询结果的数量，3个document</p>
<p>hits.max_score：score的含义，就是document对于一个search的相关度的匹配分数，越相关，就越匹配，分数也高</p>
<p>hits.hits：包含了匹配搜索的document的所有详细数据</p>
<h3 id="14-1-2传参"><a href="#14-1-2传参" class="headerlink" title="14.1.2传参"></a>14.1.2传参</h3><p>与http请求传参类似</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search?q=name:java&amp;sort=price:desc</span><br></pre></td></tr></table></figure>
<p>类比sql:  select * from book where name like ’ %java%’ order by price desc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 2,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : null,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : null,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;java编程思想&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 68.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;java&quot;,</span><br><span class="line">            &quot;dev&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sort&quot; : [</span><br><span class="line">          68.6</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-1-3图解timeout"><a href="#14-1-3图解timeout" class="headerlink" title="14.1.3图解timeout"></a>14.1.3图解timeout</h3><p>GET /book/_search?timeout=10ms</p>
<p>全局设置：配置文件中设置 search.default_search_timeout：100ms。默认不超时。</p>
<h2 id="14-2．multi-index-多索引搜索"><a href="#14-2．multi-index-多索引搜索" class="headerlink" title="14.2．multi-index 多索引搜索"></a>14.2．multi-index 多索引搜索</h2><h3 id="14-2-1multi-index搜索模式"><a href="#14-2-1multi-index搜索模式" class="headerlink" title="14.2.1multi-index搜索模式"></a>14.2.1multi-index搜索模式</h3><p>告诉你如何一次性搜索多个index和多个type下的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/_search：所有索引下的所有数据都搜索出来</span><br><span class="line">/index1/_search：指定一个index，搜索其下所有的数据</span><br><span class="line">/index1,index2/_search：同时搜索两个index下的数据</span><br><span class="line">/index*/_search：按照通配符去匹配多个索引</span><br></pre></td></tr></table></figure>
<p>应用场景：生产环境log索引可以按照日期分开。</p>
<p>log_to_es_20190910</p>
<p>log_to_es_20190911</p>
<p>log_to_es_20180910</p>
<h3 id="14-2-2初步图解一下简单的搜索原理"><a href="#14-2-2初步图解一下简单的搜索原理" class="headerlink" title="14.2.2初步图解一下简单的搜索原理"></a>14.2.2初步图解一下简单的搜索原理</h3><p>搜索原理初步图解</p>
<h2 id="14-3．-分页搜索"><a href="#14-3．-分页搜索" class="headerlink" title="14.3． 分页搜索"></a>14.3． 分页搜索</h2><h3 id="14-3-1分页搜索的语法"><a href="#14-3-1分页搜索的语法" class="headerlink" title="14.3.1分页搜索的语法"></a>14.3.1分页搜索的语法</h3><p>sql: select * from book limit 1,5</p>
<p>size，from</p>
<p>GET /book/_search?size=10</p>
<p>GET /book/_search?size=10&amp;from=0</p>
<p>GET /book/_search?size=10&amp;from=20</p>
<p>GET /book_search?from=0&amp;size=3</p>
<h3 id="14-3-2deep-paging"><a href="#14-3-2deep-paging" class="headerlink" title="14.3.2deep paging"></a>14.3.2deep paging</h3><h4 id="什么是deep-paging"><a href="#什么是deep-paging" class="headerlink" title="什么是deep paging"></a>什么是deep paging</h4><p>根据相关度评分倒排序，所以分页过深，协调节点会将大量数据聚合分析。</p>
<h4 id="deep-paging-性能问题"><a href="#deep-paging-性能问题" class="headerlink" title="deep paging 性能问题"></a>deep paging 性能问题</h4><p>1消耗网络带宽，因为所搜过深的话，各 shard 要把数据传递给 coordinate node，这个过程是有大量数据传递的，消耗网络。</p>
<p>2消耗内存，各 shard 要把数据传送给 coordinate node，这个传递回来的数据，是被 coordinate node 保存在内存中的，这样会大量消耗内存。</p>
<p>3消耗cup，coordinate node 要把传回来的数据进行排序，这个排序过程很消耗cpu。<br>所以：鉴于deep paging的性能问题，所有应尽量减少使用。</p>
<h2 id="14-4．-query-string基础语法"><a href="#14-4．-query-string基础语法" class="headerlink" title="14.4． query string基础语法"></a>14.4． query string基础语法</h2><h3 id="14-4-1query-string基础语法"><a href="#14-4-1query-string基础语法" class="headerlink" title="14.4.1query string基础语法"></a>14.4.1query string基础语法</h3><p>GET /book/_search?q=name:java</p>
<p>GET /book/_search?q=+name:java</p>
<p>GET /book/_search?q=-name:java</p>
<p>一个是掌握q=field:search content的语法，还有一个是掌握+和-的含义</p>
<h3 id="14-4-2、-all-metadata的原理和作用"><a href="#14-4-2、-all-metadata的原理和作用" class="headerlink" title="14.4.2、_all metadata的原理和作用"></a>14.4.2、_all metadata的原理和作用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search?q=java</span><br></pre></td></tr></table></figure>
<p>直接可以搜索所有的field，任意一个field包含指定的关键字就可以搜索出来。我们在进行中搜索的时候，难道是对document中的每一个field都进行一次搜索吗？不是的。</p>
<p>es中_all元数据。建立索引的时候，插入一条docunment，es会将所有的field值经行全量分词，把这些分词，放到_all field中。在搜索的时候，没有指定field，就在_all搜索。</p>
<p>举例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    name:jack</span><br><span class="line">    email:123@qq.com</span><br><span class="line">    address:beijing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_all : jack,123@qq.com,beijing </p>
<h2 id="14-5．-query-DSL入门"><a href="#14-5．-query-DSL入门" class="headerlink" title="14.5． query DSL入门"></a>14.5． query DSL入门</h2><h3 id="14-5-1-DSL"><a href="#14-5-1-DSL" class="headerlink" title="14.5.1 DSL"></a>14.5.1 DSL</h3><p>query string 后边的参数原来越多，搜索条件越来越复杂，不能满足需求。</p>
<p>GET /book/_search?q=name:java&amp;size=10&amp;from=0&amp;sort=price:desc</p>
<p>DSL:Domain Specified Language，特定领域的语言</p>
<p>es特有的搜索语言，可在请求体中携带搜索条件，功能强大。</p>
<p>查询全部 GET /book/_search</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>排序 GET /book/_search?sort=price:desc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search </span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;name&quot; : &quot; java&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;: [</span><br><span class="line">        &#123; &quot;price&quot;: &quot;desc&quot; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分页查询 GET /book/_search?size=10&amp;from=0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET  /book/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>指定返回字段 GET /book/ _search? _source=name,studymodel</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">  &quot;_source&quot;: [&quot;name&quot;, &quot;studymodel&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过组合以上各种类型查询，实现复杂查询。</p>
<h3 id="14-5-2．-Query-DSL语法"><a href="#14-5-2．-Query-DSL语法" class="headerlink" title="14.5.2． Query DSL语法"></a>14.5.2． Query DSL语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        ARGUMENT: VALUE,</span><br><span class="line">        ARGUMENT: VALUE,...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    QUERY_NAME: &#123;</span><br><span class="line">        FIELD_NAME: &#123;</span><br><span class="line">            ARGUMENT: VALUE,</span><br><span class="line">            ARGUMENT: VALUE,...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;test_field&quot;: &quot;test&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-5-3-组合多个搜索条件"><a href="#14-5-3-组合多个搜索条件" class="headerlink" title="14.5.3 组合多个搜索条件"></a>14.5.3 组合多个搜索条件</h3><p>搜索需求：title必须包含elasticsearch，content可以包含elasticsearch也可以不包含，author_id必须不为111</p>
<p>sql where  and or != </p>
<p>初始数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /website/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">          &quot;title&quot;: &quot;my hadoop article&quot;,</span><br><span class="line">          &quot;content&quot;: &quot;hadoop is very bad&quot;,</span><br><span class="line">          &quot;author_id&quot;: 111</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /website/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">          &quot;title&quot;: &quot;my elasticsearch  article&quot;,</span><br><span class="line">          &quot;content&quot;: &quot;es is very bad&quot;,</span><br><span class="line">          &quot;author_id&quot;: 112</span><br><span class="line">&#125;</span><br><span class="line">POST /website/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">          &quot;title&quot;: &quot;my elasticsearch article&quot;,</span><br><span class="line">          &quot;content&quot;: &quot;es is very goods&quot;,</span><br><span class="line">          &quot;author_id&quot;: 111</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /website/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;elasticsearch&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;content&quot;: &quot;elasticsearch&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;author_id&quot;: 111</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 488,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 1,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 0.47000363,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;website&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.47000363,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;title&quot; : &quot;my elasticsearch  article&quot;,</span><br><span class="line">          &quot;content&quot; : &quot;es is very bad&quot;,</span><br><span class="line">          &quot;author_id&quot; : 112</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更复杂的搜索需求：</p>
<p>select * from test_index where name=’tom’ or (hired =true and (personality =’good’ and rude != true ))</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">            &quot;bool&quot;: &#123;</span><br><span class="line">                &quot;must&quot;: &#123; &quot;match&quot;:&#123; &quot;name&quot;: &quot;tom&quot; &#125;&#125;,</span><br><span class="line">                &quot;should&quot;: [</span><br><span class="line">                    &#123; &quot;match&quot;:&#123; &quot;hired&quot;: true &#125;&#125;,</span><br><span class="line">                    &#123; &quot;bool&quot;: &#123;</span><br><span class="line">                        &quot;must&quot;:&#123; &quot;match&quot;: &#123; &quot;personality&quot;: &quot;good&quot; &#125;&#125;,</span><br><span class="line">                        &quot;must_not&quot;: &#123; &quot;match&quot;: &#123; &quot;rude&quot;: true &#125;&#125;</span><br><span class="line">                    &#125;&#125;</span><br><span class="line">                ],</span><br><span class="line">                &quot;minimum_should_match&quot;: 1</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-6．-full-text-search-全文检索"><a href="#14-6．-full-text-search-全文检索" class="headerlink" title="14.6． full-text search 全文检索"></a>14.6． full-text search 全文检索</h2><h3 id="14-6-1-全文检索"><a href="#14-6-1-全文检索" class="headerlink" title="14.6.1 全文检索"></a>14.6.1 全文检索</h3><p>重新创建book索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1,</span><br><span class="line">    &quot;number_of_replicas&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;name&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">        &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;description&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">        &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;studymodel&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;price&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;double&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;timestamp&quot;: &#123;</span><br><span class="line">         &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">         &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;pic&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">        &quot;index&quot;:false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;Bootstrap开发&quot;,</span><br><span class="line">&quot;description&quot;: &quot;Bootstrap是由Twitter推出的一个前台页面开发css框架，是一个非常流行的开发框架，此框架集成了多种页面效果。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长css页面开发的程序人员）轻松的实现一个css，不受浏览器限制的精美界面css效果。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201002&quot;,</span><br><span class="line">&quot;price&quot;:38.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">&quot;tags&quot;: [ &quot;bootstrap&quot;, &quot;dev&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /book/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;java编程思想&quot;,</span><br><span class="line">&quot;description&quot;: &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">&quot;price&quot;:68.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">&quot;tags&quot;: [ &quot;java&quot;, &quot;dev&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /book/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">&quot;name&quot;: &quot;spring开发基础&quot;,</span><br><span class="line">&quot;description&quot;: &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">&quot;studymodel&quot;: &quot;201001&quot;,</span><br><span class="line">&quot;price&quot;:88.6,</span><br><span class="line">&quot;timestamp&quot;:&quot;2019-08-24 19:11:35&quot;,</span><br><span class="line">&quot;pic&quot;:&quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">&quot;tags&quot;: [ &quot;spring&quot;, &quot;java&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET  /book/_search </span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;description&quot; : &quot;java程序员&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-6-2-score初探"><a href="#14-6-2-score初探" class="headerlink" title="14.6.2 _score初探"></a>14.6.2 _score初探</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 1,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 2,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 2.137549,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot; : 2.137549,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;spring开发基础&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 88.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-24 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;spring&quot;,</span><br><span class="line">            &quot;java&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.57961315,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;java编程思想&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 68.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;java&quot;,</span><br><span class="line">            &quot;dev&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果分析</p>
<p>1、建立索引时, description字段 term倒排索引</p>
<p>java 2,3</p>
<p>程序员 3</p>
<p>2、搜索时，直接找description中含有java的文档 2,3，并且3号文档含有两个java字段，一个程序员，所以得分高，排在前面。2号文档含有一个java，排在后面。</p>
<h2 id="14-7．-DSL-语法练习"><a href="#14-7．-DSL-语法练习" class="headerlink" title="14.7． DSL 语法练习"></a>14.7． DSL 语法练习</h2><h3 id="14-7-1-match-all"><a href="#14-7-1-match-all" class="headerlink" title="14.7.1 match_all"></a>14.7.1 match_all</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-7-2-match"><a href="#14-7-2-match" class="headerlink" title="14.7.2 match"></a>14.7.2 match</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;: &#123; </span><br><span class="line">		&quot;match&quot;: &#123; </span><br><span class="line">			&quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-7-3-multi-match"><a href="#14-7-3-multi-match" class="headerlink" title="14.7.3  multi_match"></a>14.7.3  multi_match</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;java程序员&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;name&quot;, &quot;description&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-7-4、range-query-范围查询"><a href="#14-7-4、range-query-范围查询" class="headerlink" title="14.7.4、range query 范围查询"></a>14.7.4、range query 范围查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 80,</span><br><span class="line">		&quot;lte&quot;: 90</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-7-5、term-query"><a href="#14-7-5、term-query" class="headerlink" title="14.7.5、term query"></a>14.7.5、term query</h3><p>字段为keyword时，存储和搜索都不分词<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="14-7-6、terms-query"><a href="#14-7-6、terms-query" class="headerlink" title="14.7.6、terms query"></a>14.7.6、terms query</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123; &quot;terms&quot;: &#123; &quot;tag&quot;: [ &quot;search&quot;, &quot;full_text&quot;, &quot;nosql&quot; ] &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="14-7-7、exist-query-查询有某些字段值的文档"><a href="#14-7-7、exist-query-查询有某些字段值的文档" class="headerlink" title="14.7.7、exist query 查询有某些字段值的文档"></a>14.7.7、exist query 查询有某些字段值的文档</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;exists&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;join_date&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-7-8、Fuzzy-query"><a href="#14-7-8、Fuzzy-query" class="headerlink" title="14.7. 8、Fuzzy query"></a>14.7. 8、Fuzzy query</h3><p>返回包含与搜索词类似的词的文档，该词由Levenshtein编辑距离度量。</p>
<p>包括以下几种情况：</p>
<ul>
<li><p>更改角色（box→fox）</p>
</li>
<li><p>删除字符（aple→apple）</p>
</li>
<li><p>插入字符（sick→sic）</p>
</li>
<li><p>调换两个相邻字符（ACT→CAT） </p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;fuzzy&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;jave&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-7-9、IDs"><a href="#14-7-9、IDs" class="headerlink" title="14.7.9、IDs"></a>14.7.9、IDs</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;ids&quot; : &#123;</span><br><span class="line">            &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-7-10、prefix-前缀查询"><a href="#14-7-10、prefix-前缀查询" class="headerlink" title="14.7.10、prefix 前缀查询"></a>14.7.10、prefix 前缀查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;prefix&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;spring&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-7-11、regexp-query-正则查询"><a href="#14-7-11、regexp-query-正则查询" class="headerlink" title="14.7.11、regexp query  正则查询"></a>14.7.11、regexp query  正则查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;regexp&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;j.*a&quot;,</span><br><span class="line">                &quot;flags&quot; : &quot;ALL&quot;,</span><br><span class="line">                &quot;max_determinized_states&quot;: 10000,</span><br><span class="line">                &quot;rewrite&quot;: &quot;constant_score&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-8．-Filter"><a href="#14-8．-Filter" class="headerlink" title="14.8． Filter"></a>14.8． Filter</h2><h3 id="14-8-1-filter与query示例"><a href="#14-8-1-filter与query示例" class="headerlink" title="14.8.1 filter与query示例"></a>14.8.1 filter与query示例</h3><p>需求：用户查询description中有”java程序员”，并且价格大于80小于90的数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;price&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: 80,</span><br><span class="line">		      &quot;lte&quot;: 90</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用filter:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 80,</span><br><span class="line">		     &quot;lte&quot;: 90</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-8-2-filter与query对比"><a href="#14-8-2-filter与query对比" class="headerlink" title="14.8.2 filter与query对比"></a>14.8.2 filter与query对比</h3><p>filter，仅仅只是按照搜索条件过滤出需要的数据而已，不计算任何相关度分数，对相关度没有任何影响。</p>
<p>query，会去计算每个document相对于搜索条件的相关度，并按照相关度进行排序。</p>
<p>应用场景：</p>
<p>一般来说，如果你是在进行搜索，需要将最匹配搜索条件的数据先返回，那么用query        如果你只是要根据一些条件筛选出一部分数据，不关注其排序，那么用filter</p>
<h3 id="14-8-3-filter与query性能"><a href="#14-8-3-filter与query性能" class="headerlink" title="14.8.3 filter与query性能"></a>14.8.3 filter与query性能</h3><p>filter，不需要计算相关度分数，不需要按照相关度分数进行排序，同时还有内置的自动cache最常使用filter的数据</p>
<p>query，相反，要计算相关度分数，按照分数进行排序，而且无法cache结果</p>
<h2 id="14-9．-定位错误语法"><a href="#14-9．-定位错误语法" class="headerlink" title="14.9． 定位错误语法"></a>14.9． 定位错误语法</h2><p>验证错误语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_validate/query?explain</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;mach&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;valid&quot; : false,</span><br><span class="line">  &quot;error&quot; : &quot;org.elasticsearch.common.ParsingException: no [query] registered for [mach]&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正确</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_validate/query?explain</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;valid&quot; : true,</span><br><span class="line">  &quot;explanations&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;index&quot; : &quot;book&quot;,</span><br><span class="line">      &quot;valid&quot; : true,</span><br><span class="line">      &quot;explanation&quot; : &quot;description:java description:程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般用在那种特别复杂庞大的搜索下，比如你一下子写了上百行的搜索，这个时候可以先用validate api去验证一下，搜索是否合法。</p>
<p>合法以后，explain就像mysql的执行计划，可以看到搜索的目标等信息。</p>
<h2 id="14-10．-定制排序规则"><a href="#14-10．-定制排序规则" class="headerlink" title="14.10． 定制排序规则"></a>14.10． 定制排序规则</h2><h3 id="14-10-1-默认排序规则"><a href="#14-10-1-默认排序规则" class="headerlink" title="14.10.1 默认排序规则"></a>14.10.1 默认排序规则</h3><p>默认情况下，是按照_score降序排序的</p>
<p>然而，某些情况下，可能没有有用的_score，比如说filter</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，也可以是constant_score</p>
<h3 id="14-10-2-定制排序规则"><a href="#14-10-2-定制排序规则" class="headerlink" title="14.10.2 定制排序规则"></a>14.10.2 定制排序规则</h3><p>相当于sql中order by  ?sort=sprice:desc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot; : &#123;</span><br><span class="line">            &quot;term&quot; : &#123;</span><br><span class="line">                &quot;studymodel&quot; : &quot;201001&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-11．-Text字段排序问题"><a href="#14-11．-Text字段排序问题" class="headerlink" title="14.11． Text字段排序问题"></a>14.11． Text字段排序问题</h2><p>如果对一个text field进行排序，结果往往不准确，因为分词后是多个单词，再排序就不是我们想要的结果了。</p>
<p>通常解决方案是，将一个text field建立两次索引，一个分词，用来进行搜索；一个不分词，用来进行排序。</p>
<p>fielddate:true</p>
<pre><code>PUT /website 
&#123;
  &quot;mappings&quot;: &#123;
  &quot;properties&quot;: &#123;
    &quot;title&quot;: &#123;
      &quot;type&quot;: &quot;text&quot;,
      &quot;fields&quot;: &#123;
        &quot;keyword&quot;: &#123;
          &quot;type&quot;: &quot;keyword&quot;
        &#125;        
      &#125;      
    &#125;,
    &quot;content&quot;: &#123;
      &quot;type&quot;: &quot;text&quot;
    &#125;,
    &quot;post_date&quot;: &#123;
      &quot;type&quot;: &quot;date&quot;
    &#125;,
    &quot;author_id&quot;: &#123;
      &quot;type&quot;: &quot;long&quot;
    &#125;
  &#125;
 &#125;
&#125;
</code></pre><p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;first article&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;this is my second article&quot;,</span><br><span class="line">  &quot;post_date&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">  &quot;author_id&quot;: 110</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /website/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;second article&quot;,</span><br><span class="line">    &quot;content&quot;: &quot;this is my second article&quot;,</span><br><span class="line">     &quot;post_date&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">    &quot;author_id&quot;: 110</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /website/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">     &quot;title&quot;: &quot;third article&quot;,</span><br><span class="line">     &quot;content&quot;: &quot;this is my third article&quot;,</span><br><span class="line">     &quot;post_date&quot;: &quot;2019-01-02&quot;,</span><br><span class="line">     &quot;author_id&quot;: 110</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /website/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;title.keyword&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-12．-Scroll分批查询"><a href="#14-12．-Scroll分批查询" class="headerlink" title="14.12． Scroll分批查询"></a>14.12． Scroll分批查询</h3><p>场景：下载某一个索引中1亿条数据，到文件或是数据库。</p>
<p>不能一下全查出来，系统内存溢出。所以使用scoll滚动搜索技术，一批一批查询。</p>
<p>scoll搜索会在第一次搜索的时候，保存一个当时的视图快照，之后只会基于该旧的视图快照提供数据搜索，如果这个期间数据变更，是不会让用户看到的</p>
<p>每次发送scroll请求，我们还需要指定一个scoll参数，指定一个时间窗口，每次搜索请求只要在这个时间窗口内能完成就可以了。</p>
<p>搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAMOkWTURBNDUtcjZTVUdKMFp5cXloVElOQQ==&quot;,</span><br><span class="line">  &quot;took&quot; : 3,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 3,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">     </span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获得的结果会有一个scoll_id，下一次再发送scoll请求的时候，必须带上这个scoll_id</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    &quot;scroll&quot;: &quot;1m&quot;, </span><br><span class="line">    &quot;scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAMOkWTURBNDUtcjZTVUdKMFp5cXloVElOQQ==&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与分页区别：</p>
<p>分页给用户看的  deep paging</p>
<p>scroll是用户系统内部操作，如下载批量数据，数据转移。零停机改变索引映射。</p>
<h1 id="15．-java-api实现搜索"><a href="#15．-java-api实现搜索" class="headerlink" title="15． java api实现搜索"></a>15． java api实现搜索</h1><h1 id="16．-评分机制详解"><a href="#16．-评分机制详解" class="headerlink" title="16． 评分机制详解"></a>16． 评分机制详解</h1><h2 id="16-1．-评分机制-TF-IDF"><a href="#16-1．-评分机制-TF-IDF" class="headerlink" title="16.1． 评分机制 TF\IDF"></a>16.1． 评分机制 TF\IDF</h2><h3 id="16-1-1-算法介绍"><a href="#16-1-1-算法介绍" class="headerlink" title="16.1.1 算法介绍"></a>16.1.1 算法介绍</h3><p>relevance score算法，简单来说，就是计算出，一个索引中的文本，与搜索文本，他们之间的关联匹配程度。</p>
<p>Elasticsearch使用的是 term frequency/inverse document frequency算法，简称为TF/IDF算法。TF词频(Term Frequency)，IDF逆向文件频率(Inverse Document Frequency)</p>
<p><strong>Term frequency</strong>：搜索文本中的各个词条在field文本中出现了多少次，出现次数越多，就越相关。</p>
<p><img src="/img/1571494142950.png" alt="1571494142950"></p>
<p>举例：搜索请求：hello world</p>
<p>doc1 : hello you and me,and world is very good. </p>
<p>doc2 : hello,how are you</p>
<p><strong>Inverse document frequency</strong>：搜索文本中的各个词条在整个索引的所有文档中出现了多少次，出现的次数越多，就越不相关.</p>
<p><img src="/img/1571494159465.png" alt="1571494159465"></p>
<p><img src="/img/1571494176760.png" alt="1571494176760"></p>
<p>举例：搜索请求：hello world</p>
<p>doc1 :  hello ,today is very good</p>
<p>doc2 : hi world ,how are you</p>
<p>整个index中1亿条数据。hello的document 1000个，有world的document  有100个。</p>
<p>doc2 更相关</p>
<p><strong>Field-length norm</strong>：field长度，field越长，相关度越弱</p>
<p>举例：搜索请求：hello world</p>
<p>doc1 : {“title”:”hello article”,”content “:”balabalabal 1万个”}</p>
<p>doc2 : {“title”:”my article”,”content “:”balabalabal 1万个,world”}</p>
<h3 id="16-1-2-score是如何被计算出来的"><a href="#16-1-2-score是如何被计算出来的" class="headerlink" title="16.1.2 _score是如何被计算出来的"></a>16.1.2 _score是如何被计算出来的</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search?explain=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 5,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 2,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 2.137549,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_shard&quot; : &quot;[book][0]&quot;,</span><br><span class="line">        &quot;_node&quot; : &quot;MDA45-r6SUGJ0ZyqyhTINA&quot;,</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot; : 2.137549,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;spring开发基础&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;spring 在java领域非常流行，java程序员都在用。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 88.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-24 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;spring&quot;,</span><br><span class="line">            &quot;java&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_explanation&quot; : &#123;</span><br><span class="line">          &quot;value&quot; : 2.137549,</span><br><span class="line">          &quot;description&quot; : &quot;sum of:&quot;,</span><br><span class="line">          &quot;details&quot; : [</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;value&quot; : 0.7936629,</span><br><span class="line">              &quot;description&quot; : &quot;weight(description:java in 0) [PerFieldSimilarity], result of:&quot;,</span><br><span class="line">              &quot;details&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                  &quot;value&quot; : 0.7936629,</span><br><span class="line">                  &quot;description&quot; : &quot;score(freq=2.0), product of:&quot;,</span><br><span class="line">                  &quot;details&quot; : [</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;value&quot; : 2.2,</span><br><span class="line">                      &quot;description&quot; : &quot;boost&quot;,</span><br><span class="line">                      &quot;details&quot; : [ ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;value&quot; : 0.47000363,</span><br><span class="line">                      &quot;description&quot; : &quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;,</span><br><span class="line">                      &quot;details&quot; : [</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 2,</span><br><span class="line">                          &quot;description&quot; : &quot;n, number of documents containing term&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 3,</span><br><span class="line">                          &quot;description&quot; : &quot;N, total number of documents with field&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;value&quot; : 0.7675597,</span><br><span class="line">                      &quot;description&quot; : &quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;,</span><br><span class="line">                      &quot;details&quot; : [</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 2.0,</span><br><span class="line">                          &quot;description&quot; : &quot;freq, occurrences of term within document&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 1.2,</span><br><span class="line">                          &quot;description&quot; : &quot;k1, term saturation parameter&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 0.75,</span><br><span class="line">                          &quot;description&quot; : &quot;b, length normalization parameter&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 12.0,</span><br><span class="line">                          &quot;description&quot; : &quot;dl, length of field&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 35.333332,</span><br><span class="line">                          &quot;description&quot; : &quot;avgdl, average length of field&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;value&quot; : 1.3438859,</span><br><span class="line">              &quot;description&quot; : &quot;weight(description:程序员 in 0) [PerFieldSimilarity], result of:&quot;,</span><br><span class="line">              &quot;details&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                  &quot;value&quot; : 1.3438859,</span><br><span class="line">                  &quot;description&quot; : &quot;score(freq=1.0), product of:&quot;,</span><br><span class="line">                  &quot;details&quot; : [</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;value&quot; : 2.2,</span><br><span class="line">                      &quot;description&quot; : &quot;boost&quot;,</span><br><span class="line">                      &quot;details&quot; : [ ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;value&quot; : 0.98082924,</span><br><span class="line">                      &quot;description&quot; : &quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;,</span><br><span class="line">                      &quot;details&quot; : [</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 1,</span><br><span class="line">                          &quot;description&quot; : &quot;n, number of documents containing term&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 3,</span><br><span class="line">                          &quot;description&quot; : &quot;N, total number of documents with field&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;value&quot; : 0.6227967,</span><br><span class="line">                      &quot;description&quot; : &quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;,</span><br><span class="line">                      &quot;details&quot; : [</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 1.0,</span><br><span class="line">                          &quot;description&quot; : &quot;freq, occurrences of term within document&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 1.2,</span><br><span class="line">                          &quot;description&quot; : &quot;k1, term saturation parameter&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 0.75,</span><br><span class="line">                          &quot;description&quot; : &quot;b, length normalization parameter&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 12.0,</span><br><span class="line">                          &quot;description&quot; : &quot;dl, length of field&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 35.333332,</span><br><span class="line">                          &quot;description&quot; : &quot;avgdl, average length of field&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_shard&quot; : &quot;[book][0]&quot;,</span><br><span class="line">        &quot;_node&quot; : &quot;MDA45-r6SUGJ0ZyqyhTINA&quot;,</span><br><span class="line">        &quot;_index&quot; : &quot;book&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : 0.57961315,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;java编程思想&quot;,</span><br><span class="line">          &quot;description&quot; : &quot;java语言是世界第一编程语言，在软件开发领域使用人数最多。&quot;,</span><br><span class="line">          &quot;studymodel&quot; : &quot;201001&quot;,</span><br><span class="line">          &quot;price&quot; : 68.6,</span><br><span class="line">          &quot;timestamp&quot; : &quot;2019-08-25 19:11:35&quot;,</span><br><span class="line">          &quot;pic&quot; : &quot;group1/M00/00/00/wKhlQFs6RCeAY0pHAAJx5ZjNDEM428.jpg&quot;,</span><br><span class="line">          &quot;tags&quot; : [</span><br><span class="line">            &quot;java&quot;,</span><br><span class="line">            &quot;dev&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_explanation&quot; : &#123;</span><br><span class="line">          &quot;value&quot; : 0.57961315,</span><br><span class="line">          &quot;description&quot; : &quot;sum of:&quot;,</span><br><span class="line">          &quot;details&quot; : [</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;value&quot; : 0.57961315,</span><br><span class="line">              &quot;description&quot; : &quot;weight(description:java in 0) [PerFieldSimilarity], result of:&quot;,</span><br><span class="line">              &quot;details&quot; : [</span><br><span class="line">                &#123;</span><br><span class="line">                  &quot;value&quot; : 0.57961315,</span><br><span class="line">                  &quot;description&quot; : &quot;score(freq=1.0), product of:&quot;,</span><br><span class="line">                  &quot;details&quot; : [</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;value&quot; : 2.2,</span><br><span class="line">                      &quot;description&quot; : &quot;boost&quot;,</span><br><span class="line">                      &quot;details&quot; : [ ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;value&quot; : 0.47000363,</span><br><span class="line">                      &quot;description&quot; : &quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;,</span><br><span class="line">                      &quot;details&quot; : [</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 2,</span><br><span class="line">                          &quot;description&quot; : &quot;n, number of documents containing term&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 3,</span><br><span class="line">                          &quot;description&quot; : &quot;N, total number of documents with field&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;value&quot; : 0.56055,</span><br><span class="line">                      &quot;description&quot; : &quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;,</span><br><span class="line">                      &quot;details&quot; : [</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 1.0,</span><br><span class="line">                          &quot;description&quot; : &quot;freq, occurrences of term within document&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 1.2,</span><br><span class="line">                          &quot;description&quot; : &quot;k1, term saturation parameter&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 0.75,</span><br><span class="line">                          &quot;description&quot; : &quot;b, length normalization parameter&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 19.0,</span><br><span class="line">                          &quot;description&quot; : &quot;dl, length of field&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;value&quot; : 35.333332,</span><br><span class="line">                          &quot;description&quot; : &quot;avgdl, average length of field&quot;,</span><br><span class="line">                          &quot;details&quot; : [ ]</span><br><span class="line">                        &#125;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="16-1-3-分析一个document是如何被匹配上的"><a href="#16-1-3-分析一个document是如何被匹配上的" class="headerlink" title="16.1.3 分析一个document是如何被匹配上的"></a>16.1.3 分析一个document是如何被匹配上的</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_explain/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="16-2．-Doc-value"><a href="#16-2．-Doc-value" class="headerlink" title="16.2． Doc value"></a>16.2． Doc value</h2><p>搜索的时候，要依靠倒排索引；排序的时候，需要依靠正排索引，看到每个document的每个field，然后进行排序，所谓的正排索引，其实就是doc values</p>
<p>在建立索引的时候，一方面会建立倒排索引，以供搜索用；一方面会建立正排索引，也就是doc values，以供排序，聚合，过滤等操作使用</p>
<p>doc values是被保存在磁盘上的，此时如果内存足够，os会自动将其缓存在内存中，性能还是会很高；如果内存不足够，os会将其写入磁盘上</p>
<p><strong>倒排索引</strong></p>
<p>doc1: hello world you and me</p>
<p>doc2: hi, world, how are you</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>term</th>
<th>doc1</th>
<th>doc2</th>
</tr>
</thead>
<tbody>
<tr>
<td>hello</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>world</td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>you</td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td>and</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>me</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td>hi</td>
<td></td>
<td>*</td>
</tr>
<tr>
<td>how</td>
<td></td>
<td>*</td>
</tr>
<tr>
<td>are</td>
<td></td>
<td>*</td>
</tr>
</tbody>
</table>
</div>
<p>搜索时：</p>
<p>hello you —&gt; hello, you</p>
<p>hello —&gt; doc1</p>
<p>you —&gt; doc1,doc2</p>
<p>doc1: hello world you and me</p>
<p>doc2: hi, world, how are you</p>
<p>sort by 出现问题</p>
<p> <strong>正排索引</strong></p>
<p>doc1: { “name”: “jack”, “age”: 27 }</p>
<p>doc2: { “name”: “tom”, “age”: 30 }</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>document</th>
<th>name</th>
<th>age</th>
</tr>
</thead>
<tbody>
<tr>
<td>doc1</td>
<td>jack</td>
<td>27</td>
</tr>
<tr>
<td>doc2</td>
<td>tom</td>
<td>30</td>
</tr>
</tbody>
</table>
</div>
<h2 id="16-3．-query-phase"><a href="#16-3．-query-phase" class="headerlink" title="16.3． query phase"></a>16.3． query phase</h2><h3 id="1、query-phase"><a href="#1、query-phase" class="headerlink" title="1、query phase"></a>1、query phase</h3><p>（1）搜索请求发送到某一个coordinate node，构构建一个priority queue，长度以paging操作from和size为准，默认为10</p>
<p>（2）coordinate node将请求转发到所有shard，每个shard本地搜索，并构建一个本地的priority queue</p>
<p>（3）各个shard将自己的priority queue返回给coordinate node，并构建一个全局的priority queue</p>
<h3 id="2、replica-shard如何提升搜索吞吐量"><a href="#2、replica-shard如何提升搜索吞吐量" class="headerlink" title="2、replica shard如何提升搜索吞吐量"></a>2、replica shard如何提升搜索吞吐量</h3><p>一次请求要打到所有shard的一个replica/primary上去，如果每个shard都有多个replica，那么同时并发过来的搜索请求可以同时打到其他的replica上去</p>
<h2 id="16-4．-fetch-phase"><a href="#16-4．-fetch-phase" class="headerlink" title="16.4． fetch phase"></a>16.4． fetch phase</h2><h3 id="1、fetch-phbase工作流程"><a href="#1、fetch-phbase工作流程" class="headerlink" title="1、fetch phbase工作流程"></a>1、fetch phbase工作流程</h3><p>（1）coordinate node构建完priority queue之后，就发送mget请求去所有shard上获取对应的document</p>
<p>（2）各个shard将document返回给coordinate node</p>
<p>（3）coordinate node将合并后的document结果返回给client客户端</p>
<h3 id="2、一般搜索，如果不加from和size，就默认搜索前10条，按照-score排序"><a href="#2、一般搜索，如果不加from和size，就默认搜索前10条，按照-score排序" class="headerlink" title="2、一般搜索，如果不加from和size，就默认搜索前10条，按照_score排序"></a>2、一般搜索，如果不加from和size，就默认搜索前10条，按照_score排序</h3><h2 id="16-5．-搜索参数小总结"><a href="#16-5．-搜索参数小总结" class="headerlink" title="16.5． 搜索参数小总结"></a>16.5． 搜索参数小总结</h2><h3 id="1、preference"><a href="#1、preference" class="headerlink" title="1、preference"></a>1、preference</h3><p>决定了哪些shard会被用来执行搜索操作</p>
<p>_primary, _primary_first, _local, _only_node:xyz, _prefer_node:xyz, _shards:2,3</p>
<p>bouncing results问题，两个document排序，field值相同；不同的shard上，可能排序不同；每次请求轮询打到不同的replica shard上；每次页面上看到的搜索结果的排序都不一样。这就是bouncing result，也就是跳跃的结果。</p>
<p>搜索的时候，是轮询将搜索请求发送到每一个replica shard（primary shard），但是在不同的shard上，可能document的排序不同</p>
<p>解决方案就是将preference设置为一个字符串，比如说user_id，让每个user每次搜索的时候，都使用同一个replica shard去执行，就不会看到bouncing results了</p>
<h3 id="2、timeout"><a href="#2、timeout" class="headerlink" title="2、timeout"></a>2、timeout</h3><p>已经讲解过原理了，主要就是限定在一定时间内，将部分获取到的数据直接返回，避免查询耗时过长</p>
<h3 id="3、routing"><a href="#3、routing" class="headerlink" title="3、routing"></a>3、routing</h3><p>document文档路由，_id路由，routing=user_id，这样的话可以让同一个user对应的数据到一个shard上去</p>
<h3 id="4、search-type"><a href="#4、search-type" class="headerlink" title="4、search_type"></a>4、search_type</h3><p>default：query_then_fetch</p>
<p>dfs_query_then_fetch，可以提升revelance sort精准度</p>
<h1 id="17．-聚合入门"><a href="#17．-聚合入门" class="headerlink" title="17． 聚合入门"></a>17． 聚合入门</h1><h2 id="17-1聚合示例"><a href="#17-1聚合示例" class="headerlink" title="17.1聚合示例"></a>17.1聚合示例</h2><h3 id="17-1-1需求：计算每个studymodel下的商品数量"><a href="#17-1-1需求：计算每个studymodel下的商品数量" class="headerlink" title="17.1.1需求：计算每个studymodel下的商品数量"></a>17.1.1需求：计算每个studymodel下的商品数量</h3><p>sql语句： select studymodel，count(*)  from book group by studymodel</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_model&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;studymodel&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="17-1-2-需求：计算每个tags下的商品数量"><a href="#17-1-2-需求：计算每个tags下的商品数量" class="headerlink" title="17.1.2 需求：计算每个tags下的商品数量"></a>17.1.2 需求：计算每个tags下的商品数量</h3><p>设置字段”fielddata”: true</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /book/_mapping/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;tags&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;fielddata&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_tags&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;tags&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="17-1-3-需求：加上搜索条件，计算每个tags下的商品数量"><a href="#17-1-3-需求：加上搜索条件，计算每个tags下的商品数量" class="headerlink" title="17.1.3 需求：加上搜索条件，计算每个tags下的商品数量"></a>17.1.3 需求：加上搜索条件，计算每个tags下的商品数量</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;description&quot;: &quot;java程序员&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_tags&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;tags&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="17-1-4-需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格"><a href="#17-1-4-需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格" class="headerlink" title="17.1.4 需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格"></a>17.1.4 需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;group_by_tags&quot; : &#123;</span><br><span class="line">            &quot;terms&quot; : &#123; </span><br><span class="line">              &quot;field&quot; : &quot;tags&quot; </span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aggs&quot; : &#123;</span><br><span class="line">                &quot;avg_price&quot; : &#123;</span><br><span class="line">                    &quot;avg&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="17-1-5-需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序"><a href="#17-1-5-需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序" class="headerlink" title="17.1.5 需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序"></a>17.1.5 需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot; : &#123;</span><br><span class="line">        &quot;group_by_tags&quot; : &#123;</span><br><span class="line">            &quot;terms&quot; : &#123; </span><br><span class="line">              &quot;field&quot; : &quot;tags&quot;,</span><br><span class="line">              &quot;order&quot;: &#123;</span><br><span class="line">                &quot;avg_price&quot;: &quot;desc&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aggs&quot; : &#123;</span><br><span class="line">                &quot;avg_price&quot; : &#123;</span><br><span class="line">                    &quot;avg&quot; : &#123; &quot;field&quot; : &quot;price&quot; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="17-1-6-需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格"><a href="#17-1-6-需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格" class="headerlink" title="17.1.6 需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格"></a>17.1.6 需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">GET /book/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_price&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 0,</span><br><span class="line">            &quot;to&quot;: 40</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 40,</span><br><span class="line">            &quot;to&quot;: 60</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 60,</span><br><span class="line">            &quot;to&quot;: 80</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_tags&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;tags&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;average_price&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;price&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="17-2两个核心概念：bucket和metric"><a href="#17-2两个核心概念：bucket和metric" class="headerlink" title="17.2两个核心概念：bucket和metric"></a>17.2两个核心概念：bucket和metric</h2><h3 id="17-2-1-bucket：一个数据分组"><a href="#17-2-1-bucket：一个数据分组" class="headerlink" title="17.2.1 bucket：一个数据分组"></a>17.2.1 bucket：一个数据分组</h3><p>city  name<br>        北京 张三<br>        北京 李四<br>        天津 王五<br>        天津 赵六</p>
<p>天津 王麻子</p>
<p>划分出来两个bucket，一个是北京bucket，一个是天津bucket<br>北京bucket：包含了2个人，张三，李四<br>上海bucket：包含了3个人，王五，赵六，王麻子</p>
<h3 id="17-2-2metric：对一个数据分组执行的统计"><a href="#17-2-2metric：对一个数据分组执行的统计" class="headerlink" title="17.2.2metric：对一个数据分组执行的统计"></a>17.2.2metric：对一个数据分组执行的统计</h3><p>metric，就是对一个bucket执行的某种聚合分析的操作，比如说求平均值，求最大值，求最小值</p>
<p>select count(*)<br>        from book<br>        group studymodel</p>
<p>bucket：group by studymodel —&gt; 那些studymodel相同的数据，就会被划分到一个bucket中<br>        metric：count(*)，对每个user_id bucket中所有的数据，计算一个数量。还有avg()，sum()，max()，min()</p>
<h2 id="17-3-电视案例"><a href="#17-3-电视案例" class="headerlink" title="17.3 电视案例"></a>17.3 电视案例</h2><p>创建索引及映射</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT /tvs</span><br><span class="line">PUT /tvs/_search</span><br><span class="line">&#123;			</span><br><span class="line">			&quot;properties&quot;: &#123;</span><br><span class="line">				&quot;price&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;long&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;color&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;brand&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;sold_date&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;date&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /tvs/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 1000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;长虹&quot;, &quot;sold_date&quot; : &quot;2019-10-28&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 2000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;长虹&quot;, &quot;sold_date&quot; : &quot;2019-11-05&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 3000, &quot;color&quot; : &quot;绿色&quot;, &quot;brand&quot; : &quot;小米&quot;, &quot;sold_date&quot; : &quot;2019-05-18&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 1500, &quot;color&quot; : &quot;蓝色&quot;, &quot;brand&quot; : &quot;TCL&quot;, &quot;sold_date&quot; : &quot;2019-07-02&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 1200, &quot;color&quot; : &quot;绿色&quot;, &quot;brand&quot; : &quot;TCL&quot;, &quot;sold_date&quot; : &quot;2019-08-19&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 2000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;长虹&quot;, &quot;sold_date&quot; : &quot;2019-11-05&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 8000, &quot;color&quot; : &quot;红色&quot;, &quot;brand&quot; : &quot;三星&quot;, &quot;sold_date&quot; : &quot;2020-01-01&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123;&#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 2500, &quot;color&quot; : &quot;蓝色&quot;, &quot;brand&quot; : &quot;小米&quot;, &quot;sold_date&quot; : &quot;2020-02-12&quot; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="需求1-统计哪种颜色的电视销量最高"><a href="#需求1-统计哪种颜色的电视销量最高" class="headerlink" title="需求1 统计哪种颜色的电视销量最高"></a>需求1 统计哪种颜色的电视销量最高</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot; : 0,</span><br><span class="line">    &quot;aggs&quot; : &#123; </span><br><span class="line">        &quot;popular_colors&quot; : &#123; </span><br><span class="line">            &quot;terms&quot; : &#123; </span><br><span class="line">              &quot;field&quot; : &quot;color&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查询条件解析</p>
<p>size：只获取聚合结果，而不要执行聚合的原始数据<br>        aggs：固定语法，要对一份数据执行分组聚合操作<br>        popular_colors：就是对每个aggs，都要起一个名字，<br>        terms：根据字段的值进行分组<br>        field：根据指定的字段的值进行分组</p>
<p>返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 18,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 8,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : null,</span><br><span class="line">    &quot;hits&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggregations&quot; : &#123;</span><br><span class="line">    &quot;popular_colors&quot; : &#123;</span><br><span class="line">      &quot;doc_count_error_upper_bound&quot; : 0,</span><br><span class="line">      &quot;sum_other_doc_count&quot; : 0,</span><br><span class="line">      &quot;buckets&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;红色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 4</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;绿色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;蓝色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回结果解析</p>
<p>hits.hits：我们指定了size是0，所以hits.hits就是空的<br>        aggregations：聚合结果<br>        popular_color：我们指定的某个聚合的名称<br>        buckets：根据我们指定的field划分出的buckets<br>        key：每个bucket对应的那个值<br>        doc_count：这个bucket分组内，有多少个数据<br>数量，其实就是这种颜色的销量</p>
<p>每种颜色对应的bucket中的数据的默认的排序规则：按照doc_count降序排序</p>
<h3 id="需求2-统计每种颜色电视平均价格"><a href="#需求2-统计每种颜色电视平均价格" class="headerlink" title="需求2 统计每种颜色电视平均价格"></a>需求2 统计每种颜色电视平均价格</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;size&quot; : 0,</span><br><span class="line">   &quot;aggs&quot;: &#123;</span><br><span class="line">      &quot;colors&quot;: &#123;</span><br><span class="line">         &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;color&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;aggs&quot;: &#123; </span><br><span class="line">            &quot;avg_price&quot;: &#123; </span><br><span class="line">               &quot;avg&quot;: &#123;</span><br><span class="line">                  &quot;field&quot;: &quot;price&quot; </span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在一个aggs执行的bucket操作（terms），平级的json结构下，再加一个aggs，这个第二个aggs内部，同样取个名字，执行一个metric操作，avg，对之前的每个bucket中的数据的指定的field，price field，求一个平均值</p>
<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 4,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 1,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 8,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : null,</span><br><span class="line">    &quot;hits&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggregations&quot; : &#123;</span><br><span class="line">    &quot;colors&quot; : &#123;</span><br><span class="line">      &quot;doc_count_error_upper_bound&quot; : 0,</span><br><span class="line">      &quot;sum_other_doc_count&quot; : 0,</span><br><span class="line">      &quot;buckets&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;红色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 4,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 3250.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;绿色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 2100.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot; : &quot;蓝色&quot;,</span><br><span class="line">          &quot;doc_count&quot; : 2,</span><br><span class="line">          &quot;avg_price&quot; : &#123;</span><br><span class="line">            &quot;value&quot; : 2000.0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>buckets，除了key和doc_count<br>avg_price：我们自己取的metric aggs的名字<br>value：我们的metric计算的结果，每个bucket中的数据的price字段求平均值后的结果</p>
<p>相当于sql: select avg(price) from tvs group by color</p>
<h3 id="需求3-继续下钻分析"><a href="#需求3-继续下钻分析" class="headerlink" title="需求3 继续下钻分析"></a>需求3 继续下钻分析</h3><p>每个颜色下，平均价格及每个颜色下，每个品牌的平均价格</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_color&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;color&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;color_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;group_by_brand&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;brand&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;brand_avg_price&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;price&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="需求4：更多的metric"><a href="#需求4：更多的metric" class="headerlink" title="需求4：更多的metric"></a>需求4：更多的metric</h3><p>count：bucket，terms，自动就会有一个doc_count，就相当于是count<br>avg：avg aggs，求平均值<br>max：求一个bucket内，指定field值最大的那个数据<br>min：求一个bucket内，指定field值最小的那个数据<br>sum：求一个bucket内，指定field值的总和</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;size&quot; : 0,</span><br><span class="line">   &quot;aggs&quot;: &#123;</span><br><span class="line">      &quot;colors&quot;: &#123;</span><br><span class="line">         &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;color&quot;</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;,</span><br><span class="line">            &quot;min_price&quot; : &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;, </span><br><span class="line">            &quot;max_price&quot; : &#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;,</span><br><span class="line">            &quot;sum_price&quot; : &#123; &quot;sum&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125; </span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="需求5：划分范围-histogram"><a href="#需求5：划分范围-histogram" class="headerlink" title="需求5：划分范围 histogram"></a>需求5：划分范围 histogram</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;size&quot; : 0,</span><br><span class="line">   &quot;aggs&quot;:&#123;</span><br><span class="line">      &quot;price&quot;:&#123;</span><br><span class="line">         &quot;histogram&quot;:&#123; </span><br><span class="line">            &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">            &quot;interval&quot;: 2000</span><br><span class="line">         &#125;,</span><br><span class="line">         &quot;aggs&quot;:&#123;</span><br><span class="line">            &quot;income&quot;: &#123;</span><br><span class="line">               &quot;sum&quot;: &#123; </span><br><span class="line">                 &quot;field&quot; : &quot;price&quot;</span><br><span class="line">               &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>histogram：类似于terms，也是进行bucket分组操作，接收一个field，按照这个field的值的各个范围区间，进行bucket分组操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;histogram&quot;:&#123; </span><br><span class="line">  &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">  &quot;interval&quot;: 2000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>interval：2000，划分范围，0~2000，2000~4000，4000~6000，6000~8000，8000~10000，buckets</p>
<p>bucket有了之后，一样的，去对每个bucket执行avg，count，sum，max，min，等各种metric操作，聚合分析</p>
<h3 id="需求6：按照日期分组聚合"><a href="#需求6：按照日期分组聚合" class="headerlink" title="需求6：按照日期分组聚合"></a>需求6：按照日期分组聚合</h3><p>date_histogram，按照我们指定的某个date类型的日期field，以及日期interval，按照一定的日期间隔，去划分bucket</p>
<p>min_doc_count：即使某个日期interval，2017-01-01~2017-01-31中，一条数据都没有，那么这个区间也是要返回的，不然默认是会过滤掉这个区间的<br>        extended_bounds，min，max：划分bucket的时候，会限定在这个起始日期，和截止日期内</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;size&quot; : 0,</span><br><span class="line">   &quot;aggs&quot;: &#123;</span><br><span class="line">      &quot;sales&quot;: &#123;</span><br><span class="line">         &quot;date_histogram&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;sold_date&quot;,</span><br><span class="line">            &quot;interval&quot;: &quot;month&quot;, </span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</span><br><span class="line">            &quot;min_doc_count&quot; : 0, </span><br><span class="line">            &quot;extended_bounds&quot; : &#123; </span><br><span class="line">                &quot;min&quot; : &quot;2019-01-01&quot;,</span><br><span class="line">                &quot;max&quot; : &quot;2020-12-31&quot;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="需求7-统计每季度每个品牌的销售额"><a href="#需求7-统计每季度每个品牌的销售额" class="headerlink" title="需求7 统计每季度每个品牌的销售额"></a>需求7 统计每季度每个品牌的销售额</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_sold_date&quot;: &#123;</span><br><span class="line">      &quot;date_histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;sold_date&quot;,</span><br><span class="line">        &quot;interval&quot;: &quot;quarter&quot;,</span><br><span class="line">        &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</span><br><span class="line">        &quot;min_doc_count&quot;: 0,</span><br><span class="line">        &quot;extended_bounds&quot;: &#123;</span><br><span class="line">          &quot;min&quot;: &quot;2019-01-01&quot;,</span><br><span class="line">          &quot;max&quot;: &quot;2020-12-31&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_brand&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;brand&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;sum_price&quot;: &#123;</span><br><span class="line">              &quot;sum&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;price&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;total_sum_price&quot;: &#123;</span><br><span class="line">          &quot;sum&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="需求8-：搜索与聚合结合，查询某个品牌按颜色销量"><a href="#需求8-：搜索与聚合结合，查询某个品牌按颜色销量" class="headerlink" title="需求8 ：搜索与聚合结合，查询某个品牌按颜色销量"></a>需求8 ：搜索与聚合结合，查询某个品牌按颜色销量</h3><p>搜索与聚合可以结合起来。</p>
<p>sql select count(*)</p>
<p>from tvs</p>
<p>where brand like “%小米%”</p>
<p>group by color</p>
<p>es aggregation，scope，任何的聚合，都必须在搜索出来的结果数据中之行，搜索结果，就是聚合分析操作的scope</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;brand&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;小米&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_color&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;color&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="需求9-global-bucket：单个品牌与所有品牌销量对比"><a href="#需求9-global-bucket：单个品牌与所有品牌销量对比" class="headerlink" title="需求9 global bucket：单个品牌与所有品牌销量对比"></a>需求9 global bucket：单个品牌与所有品牌销量对比</h3><p>aggregation，scope，一个聚合操作，必须在query的搜索结果范围内执行</p>
<p>出来两个结果，一个结果，是基于query搜索结果来聚合的; 一个结果，是对所有数据执行聚合的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;brand&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;小米&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;single_brand_avg_price&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;price&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;all&quot;: &#123;</span><br><span class="line">      &quot;global&quot;: &#123;&#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;all_brand_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="需求10：过滤-聚合：统计价格大于1200的电视平均价格"><a href="#需求10：过滤-聚合：统计价格大于1200的电视平均价格" class="headerlink" title="需求10：过滤+聚合：统计价格大于1200的电视平均价格"></a>需求10：过滤+聚合：统计价格大于1200的电视平均价格</h3><p>搜索+聚合</p>
<p>过滤+聚合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 1200</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;avg_price&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;price&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="需求11-bucket-filter：统计品牌最近一个月的平均价格"><a href="#需求11-bucket-filter：统计品牌最近一个月的平均价格" class="headerlink" title="需求11 bucket filter：统计品牌最近一个月的平均价格"></a>需求11 bucket filter：统计品牌最近一个月的平均价格</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;brand&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;小米&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;recent_150d&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;sold_date&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: &quot;now-150d&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;recent_150d_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;recent_140d&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;sold_date&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: &quot;now-140d&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;recent_140d_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;recent_130d&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;sold_date&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: &quot;now-130d&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;recent_130d_avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>aggs.filter，针对的是聚合去做的</p>
<p>如果放query里面的filter，是全局的，会对所有的数据都有影响</p>
<p>但是，如果，比如说，你要统计，长虹电视，最近1个月的平均值; 最近3个月的平均值; 最近6个月的平均值</p>
<p>bucket filter：对不同的bucket下的aggs，进行filter</p>
<h3 id="需求12-排序：按每种颜色的平均销售额降序排序"><a href="#需求12-排序：按每种颜色的平均销售额降序排序" class="headerlink" title="需求12 排序：按每种颜色的平均销售额降序排序"></a>需求12 排序：按每种颜色的平均销售额降序排序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_color&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;color&quot;,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;avg_price&quot;: &quot;asc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相当于sql子表数据字段可以立刻使用。</p>
<h3 id="需求13-排序：按每种颜色的每种品牌平均销售额降序排序"><a href="#需求13-排序：按每种颜色的每种品牌平均销售额降序排序" class="headerlink" title="需求13 排序：按每种颜色的每种品牌平均销售额降序排序"></a>需求13 排序：按每种颜色的每种品牌平均销售额降序排序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /tvs/_search  </span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_color&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;color&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_brand&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;brand&quot;,</span><br><span class="line">            &quot;order&quot;: &#123;</span><br><span class="line">              &quot;avg_price&quot;: &quot;desc&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;avg_price&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;price&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="18．-java-api实现聚合"><a href="#18．-java-api实现聚合" class="headerlink" title="18． java api实现聚合"></a>18． java api实现聚合</h1><p>简单聚合，多种聚合，详见代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregation;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.histogram.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.TermsAggregationBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.metrics.*;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * creste by itheima.itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestAggs</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//需求一：按照颜色分组，计算每个颜色卖出的个数</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAggs</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot;: 0,</span></span><br><span class="line">        <span class="comment">//     &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//       &quot;group_by_color&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;terms&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;field&quot;: &quot;color&quot;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">termsAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;group_by_color&quot;</span>).field(<span class="string">&quot;color&quot;</span>);</span><br><span class="line">        searchSourceBuilder.aggregation(termsAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">      <span class="comment">//   &quot;aggregations&quot; : &#123;</span></span><br><span class="line">      <span class="comment">//       &quot;group_by_color&quot; : &#123;</span></span><br><span class="line">      <span class="comment">//           &quot;doc_count_error_upper_bound&quot; : 0,</span></span><br><span class="line">      <span class="comment">//           &quot;sum_other_doc_count&quot; : 0,</span></span><br><span class="line">      <span class="comment">//            &quot;buckets&quot; : [</span></span><br><span class="line">      <span class="comment">//           &#123;</span></span><br><span class="line">      <span class="comment">//               &quot;key&quot; : &quot;红色&quot;,</span></span><br><span class="line">      <span class="comment">//               &quot;doc_count&quot; : 4</span></span><br><span class="line">      <span class="comment">//           &#125;,</span></span><br><span class="line">      <span class="comment">//           &#123;</span></span><br><span class="line">      <span class="comment">//               &quot;key&quot; : &quot;绿色&quot;,</span></span><br><span class="line">      <span class="comment">//                   &quot;doc_count&quot; : 2</span></span><br><span class="line">      <span class="comment">//           &#125;,</span></span><br><span class="line">      <span class="comment">//           &#123;</span></span><br><span class="line">      <span class="comment">//               &quot;key&quot; : &quot;蓝色&quot;,</span></span><br><span class="line">      <span class="comment">//                   &quot;doc_count&quot; : 2</span></span><br><span class="line">      <span class="comment">//           &#125;</span></span><br><span class="line">      <span class="comment">// ]</span></span><br><span class="line">      <span class="comment">//       &#125;</span></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">        <span class="type">Terms</span> <span class="variable">group_by_color</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;group_by_color&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; buckets = group_by_color.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;key:&quot;</span>+key);</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">docCount</span> <span class="operator">=</span> bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;=================================&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #需求二：按照颜色分组，计算每个颜色卖出的个数，每个颜色卖出的平均价格</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAggsAndAvg</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot;: 0,</span></span><br><span class="line">        <span class="comment">//      &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;group_by_color&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;terms&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;field&quot;: &quot;color&quot;</span></span><br><span class="line">        <span class="comment">//         &#125;,</span></span><br><span class="line">        <span class="comment">//         &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;avg_price&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                 &quot;avg&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                     &quot;field&quot;: &quot;price&quot;</span></span><br><span class="line">        <span class="comment">//                 &#125;</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">termsAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;group_by_color&quot;</span>).field(<span class="string">&quot;color&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//terms聚合下填充一个子聚合</span></span><br><span class="line">        <span class="type">AvgAggregationBuilder</span> <span class="variable">avgAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.avg(<span class="string">&quot;avg_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        termsAggregationBuilder.subAggregation(avgAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.aggregation(termsAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;key&quot; : &quot;红色&quot;,</span></span><br><span class="line">        <span class="comment">//      &quot;doc_count&quot; : 4,</span></span><br><span class="line">        <span class="comment">//      &quot;avg_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//        &quot;value&quot; : 3250.0</span></span><br><span class="line">        <span class="comment">//       &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">        <span class="type">Terms</span> <span class="variable">group_by_color</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;group_by_color&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; buckets = group_by_color.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;key:&quot;</span>+key);</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">docCount</span> <span class="operator">=</span> bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            <span class="type">Aggregations</span> <span class="variable">aggregations1</span> <span class="operator">=</span> bucket.getAggregations();</span><br><span class="line">            <span class="type">Avg</span> <span class="variable">avg_price</span> <span class="operator">=</span> aggregations1.get(<span class="string">&quot;avg_price&quot;</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">value</span> <span class="operator">=</span> avg_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;value:&quot;</span>+value);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;=================================&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #需求三：按照颜色分组，计算每个颜色卖出的个数，以及每个颜色卖出的平均值、最大值、最小值、总和。</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAggsAndMore</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot; : 0,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//      &quot;group_by_color&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;terms&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;field&quot;: &quot;color&quot;</span></span><br><span class="line">        <span class="comment">//         &#125;,</span></span><br><span class="line">        <span class="comment">//         &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;avg_price&quot;: &#123; &quot;avg&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;,</span></span><br><span class="line">        <span class="comment">//             &quot;min_price&quot; : &#123; &quot;min&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;,</span></span><br><span class="line">        <span class="comment">//             &quot;max_price&quot; : &#123; &quot;max&quot;: &#123; &quot;field&quot;: &quot;price&quot;&#125; &#125;,</span></span><br><span class="line">        <span class="comment">//             &quot;sum_price&quot; : &#123; &quot;sum&quot;: &#123; &quot;field&quot;: &quot;price&quot; &#125; &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="type">TermsAggregationBuilder</span> <span class="variable">termsAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.terms(<span class="string">&quot;group_by_color&quot;</span>).field(<span class="string">&quot;color&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//termsAggregationBuilder里放入多个子聚合</span></span><br><span class="line">        <span class="type">AvgAggregationBuilder</span> <span class="variable">avgAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.avg(<span class="string">&quot;avg_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        <span class="type">MinAggregationBuilder</span> <span class="variable">minAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.min(<span class="string">&quot;min_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        <span class="type">MaxAggregationBuilder</span> <span class="variable">maxAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.max(<span class="string">&quot;max_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        <span class="type">SumAggregationBuilder</span> <span class="variable">sumAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.sum(<span class="string">&quot;sum_price&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line"></span><br><span class="line">        termsAggregationBuilder.subAggregation(avgAggregationBuilder);</span><br><span class="line">        termsAggregationBuilder.subAggregation(minAggregationBuilder);</span><br><span class="line">        termsAggregationBuilder.subAggregation(maxAggregationBuilder);</span><br><span class="line">        termsAggregationBuilder.subAggregation(sumAggregationBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.aggregation(termsAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;key&quot; : &quot;红色&quot;,</span></span><br><span class="line">        <span class="comment">//     &quot;doc_count&quot; : 4,</span></span><br><span class="line">        <span class="comment">//     &quot;max_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//          &quot;value&quot; : 8000.0</span></span><br><span class="line">        <span class="comment">//     &#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;min_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//          &quot;value&quot; : 1000.0</span></span><br><span class="line">        <span class="comment">// &#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;avg_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;value&quot; : 3250.0</span></span><br><span class="line">        <span class="comment">// &#125;,</span></span><br><span class="line">        <span class="comment">//     &quot;sum_price&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;value&quot; : 13000.0</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">        <span class="type">Terms</span> <span class="variable">group_by_color</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;group_by_color&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; buckets = group_by_color.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;key:&quot;</span>+key);</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">docCount</span> <span class="operator">=</span> bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            <span class="type">Aggregations</span> <span class="variable">aggregations1</span> <span class="operator">=</span> bucket.getAggregations();</span><br><span class="line"></span><br><span class="line">            <span class="type">Max</span> <span class="variable">max_price</span> <span class="operator">=</span> aggregations1.get(<span class="string">&quot;max_price&quot;</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">maxPriceValue</span> <span class="operator">=</span> max_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;maxPriceValue:&quot;</span>+maxPriceValue);</span><br><span class="line"></span><br><span class="line">            <span class="type">Min</span> <span class="variable">min_price</span> <span class="operator">=</span> aggregations1.get(<span class="string">&quot;min_price&quot;</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">minPriceValue</span> <span class="operator">=</span> min_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;minPriceValue:&quot;</span>+minPriceValue);</span><br><span class="line"></span><br><span class="line">            <span class="type">Avg</span> <span class="variable">avg_price</span> <span class="operator">=</span> aggregations1.get(<span class="string">&quot;avg_price&quot;</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">avgPriceValue</span> <span class="operator">=</span> avg_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;avgPriceValue:&quot;</span>+avgPriceValue);</span><br><span class="line"></span><br><span class="line">            <span class="type">Sum</span> <span class="variable">sum_price</span> <span class="operator">=</span> aggregations1.get(<span class="string">&quot;sum_price&quot;</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">sumPriceValue</span> <span class="operator">=</span> sum_price.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;sumPriceValue:&quot;</span>+sumPriceValue);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;=================================&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #需求四：按照售价每2000价格划分范围，算出每个区间的销售总额 histogram</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAggsAndHistogram</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot; : 0,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;:&#123;</span></span><br><span class="line">        <span class="comment">//      &quot;by_histogram&quot;:&#123;</span></span><br><span class="line">        <span class="comment">//         &quot;histogram&quot;:&#123;</span></span><br><span class="line">        <span class="comment">//             &quot;field&quot;: &quot;price&quot;,</span></span><br><span class="line">        <span class="comment">//             &quot;interval&quot;: 2000</span></span><br><span class="line">        <span class="comment">//         &#125;,</span></span><br><span class="line">        <span class="comment">//         &quot;aggs&quot;:&#123;</span></span><br><span class="line">        <span class="comment">//             &quot;income&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                 &quot;sum&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                     &quot;field&quot; : &quot;price&quot;</span></span><br><span class="line">        <span class="comment">//                 &#125;</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="type">HistogramAggregationBuilder</span> <span class="variable">histogramAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.histogram(<span class="string">&quot;by_histogram&quot;</span>).field(<span class="string">&quot;price&quot;</span>).interval(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SumAggregationBuilder</span> <span class="variable">sumAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.sum(<span class="string">&quot;income&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        histogramAggregationBuilder.subAggregation(sumAggregationBuilder);</span><br><span class="line">        searchSourceBuilder.aggregation(histogramAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;key&quot; : 0.0,</span></span><br><span class="line">        <span class="comment">//     &quot;doc_count&quot; : 3,</span></span><br><span class="line">        <span class="comment">//      income&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//          &quot;value&quot; : 3700.0</span></span><br><span class="line">        <span class="comment">//       &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">        <span class="type">Histogram</span> <span class="variable">group_by_color</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;by_histogram&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Histogram</span>.Bucket&gt; buckets = group_by_color.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Histogram.Bucket bucket : buckets) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">keyAsString</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;keyAsString:&quot;</span>+keyAsString);</span><br><span class="line">            <span class="type">long</span> <span class="variable">docCount</span> <span class="operator">=</span> bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            <span class="type">Aggregations</span> <span class="variable">aggregations1</span> <span class="operator">=</span> bucket.getAggregations();</span><br><span class="line">            <span class="type">Sum</span> <span class="variable">income</span> <span class="operator">=</span> aggregations1.get(<span class="string">&quot;income&quot;</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">value</span> <span class="operator">=</span> income.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;value:&quot;</span>+value);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;=================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #需求五：计算每个季度的销售总额</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAggsAndDateHistogram</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// GET /tvs/_search</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;size&quot; : 0,</span></span><br><span class="line">        <span class="comment">//     &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;sales&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;date_histogram&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                      &quot;field&quot;: &quot;sold_date&quot;,</span></span><br><span class="line">        <span class="comment">//                     &quot;interval&quot;: &quot;quarter&quot;,</span></span><br><span class="line">        <span class="comment">//                     &quot;format&quot;: &quot;yyyy-MM-dd&quot;,</span></span><br><span class="line">        <span class="comment">//                     &quot;min_doc_count&quot; : 0,</span></span><br><span class="line">        <span class="comment">//                     &quot;extended_bounds&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//                         &quot;min&quot; : &quot;2019-01-01&quot;,</span></span><br><span class="line">        <span class="comment">//                         &quot;max&quot; : &quot;2020-12-31&quot;</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;,</span></span><br><span class="line">        <span class="comment">//         &quot;aggs&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//             &quot;income&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                 &quot;sum&quot;: &#123;</span></span><br><span class="line">        <span class="comment">//                     &quot;field&quot;: &quot;price&quot;</span></span><br><span class="line">        <span class="comment">//                 &#125;</span></span><br><span class="line">        <span class="comment">//             &#125;</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 构建请求</span></span><br><span class="line">        SearchRequest searchRequest=<span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;tvs&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//请求体</span></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder=<span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        searchSourceBuilder.size(<span class="number">0</span>);</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="type">DateHistogramAggregationBuilder</span> <span class="variable">dateHistogramAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.dateHistogram(<span class="string">&quot;date_histogram&quot;</span>).field(<span class="string">&quot;sold_date&quot;</span>).calendarInterval(DateHistogramInterval.QUARTER)</span><br><span class="line">                .format(<span class="string">&quot;yyyy-MM-dd&quot;</span>).minDocCount(<span class="number">0</span>).extendedBounds(<span class="keyword">new</span> <span class="title class_">ExtendedBounds</span>(<span class="string">&quot;2019-01-01&quot;</span>, <span class="string">&quot;2020-12-31&quot;</span>));</span><br><span class="line">        <span class="type">SumAggregationBuilder</span> <span class="variable">sumAggregationBuilder</span> <span class="operator">=</span> AggregationBuilders.sum(<span class="string">&quot;income&quot;</span>).field(<span class="string">&quot;price&quot;</span>);</span><br><span class="line">        dateHistogramAggregationBuilder.subAggregation(sumAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.aggregation(dateHistogramAggregationBuilder);</span><br><span class="line">        <span class="comment">//请求体放入请求头</span></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 执行</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获取结果</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     &quot;key_as_string&quot; : &quot;2019-01-01&quot;,</span></span><br><span class="line">        <span class="comment">//      &quot;key&quot; : 1546300800000,</span></span><br><span class="line">        <span class="comment">//      &quot;doc_count&quot; : 0,</span></span><br><span class="line">        <span class="comment">//      &quot;income&quot; : &#123;</span></span><br><span class="line">        <span class="comment">//         &quot;value&quot; : 0.0</span></span><br><span class="line">        <span class="comment">//      &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> searchResponse.getAggregations();</span><br><span class="line">        <span class="type">ParsedDateHistogram</span> <span class="variable">date_histogram</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;date_histogram&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Histogram</span>.Bucket&gt; buckets = date_histogram.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Histogram.Bucket bucket : buckets) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">keyAsString</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;keyAsString:&quot;</span>+keyAsString);</span><br><span class="line">            <span class="type">long</span> <span class="variable">docCount</span> <span class="operator">=</span> bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span>+docCount);</span><br><span class="line"></span><br><span class="line">            <span class="type">Aggregations</span> <span class="variable">aggregations1</span> <span class="operator">=</span> bucket.getAggregations();</span><br><span class="line">            <span class="type">Sum</span> <span class="variable">income</span> <span class="operator">=</span> aggregations1.get(<span class="string">&quot;income&quot;</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">value</span> <span class="operator">=</span> income.getValue();</span><br><span class="line">            System.out.println(<span class="string">&quot;value:&quot;</span>+value);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;====================&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="19．-es7-sql新特性"><a href="#19．-es7-sql新特性" class="headerlink" title="19． es7 sql新特性"></a>19． es7 sql新特性</h1><h2 id="19-1-快速入门"><a href="#19-1-快速入门" class="headerlink" title="19.1 快速入门"></a>19.1 快速入门</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql?format=txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM tvs &quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="19-2启动方式"><a href="#19-2启动方式" class="headerlink" title="19.2启动方式"></a>19.2启动方式</h2><p>1http 请求</p>
<p>2客户端：elasticsearch-sql-cli.bat</p>
<p>3代码</p>
<h2 id="19-3显示方式"><a href="#19-3显示方式" class="headerlink" title="19.3显示方式"></a>19.3显示方式</h2><p><img src="/img/1573212830146.png" alt="1573212830146"></p>
<h2 id="19-4-sql-翻译"><a href="#19-4-sql-翻译" class="headerlink" title="19.4 sql 翻译"></a>19.4 sql 翻译</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql/translate</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM tvs &quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;size&quot; : 1000,</span><br><span class="line">  &quot;_source&quot; : false,</span><br><span class="line">  &quot;stored_fields&quot; : &quot;_none_&quot;,</span><br><span class="line">  &quot;docvalue_fields&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;field&quot; : &quot;brand&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;field&quot; : &quot;color&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;field&quot; : &quot;price&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;field&quot; : &quot;sold_date&quot;,</span><br><span class="line">      &quot;format&quot; : &quot;epoch_millis&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sort&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_doc&quot; : &#123;</span><br><span class="line">        &quot;order&quot; : &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="19-5-与其他DSL结合"><a href="#19-5-与其他DSL结合" class="headerlink" title="19.5 与其他DSL结合"></a>19.5 与其他DSL结合</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql?format=txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM tvs&quot;,</span><br><span class="line">    &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">            &quot;price&quot;: &#123;</span><br><span class="line">                &quot;gte&quot; : 1200,</span><br><span class="line">                &quot;lte&quot; : 2000</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="19-6-java-代码实现sql功能"><a href="#19-6-java-代码实现sql功能" class="headerlink" title="19.6 java 代码实现sql功能"></a>19.6 java 代码实现sql功能</h2><p>1前提 es拥有白金版功能</p>
<p> kibana中管理-》许可管理 开启白金版试用</p>
<p>2导入依赖</p>
<pre><code>    &lt;dependency&gt;
        &lt;groupId&gt;org.elasticsearch.plugin&lt;/groupId&gt;
        &lt;artifactId&gt;x-pack-sql-jdbc&lt;/artifactId&gt;
        &lt;version&gt;7.3.0&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;repositories&gt;
        &lt;repository&gt;
            &lt;id&gt;elastic.co&lt;/id&gt;
            &lt;url&gt;https://artifacts.elastic.co/maven&lt;/url&gt;
        &lt;/repository&gt;
    &lt;/repositories&gt;
</code></pre><p>3代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        try  &#123;</span><br><span class="line">            Connection connection = DriverManager.getConnection(&quot;jdbc:es://http://localhost:9200&quot;);</span><br><span class="line">            Statement statement = connection.createStatement();</span><br><span class="line">            ResultSet results = statement.executeQuery(</span><br><span class="line">                    &quot;select * from tvs&quot;);</span><br><span class="line">            while(results.next())&#123;</span><br><span class="line">                System.out.println(results.getString(1));</span><br><span class="line">                System.out.println(results.getString(2));</span><br><span class="line">                System.out.println(results.getString(3));</span><br><span class="line">                System.out.println(results.getString(4));</span><br><span class="line">                System.out.println(&quot;============================&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>大型企业可以购买白金版，增加Machine Learning、高级安全性x-pack。</p>
<h1 id="20．-Logstash学习"><a href="#20．-Logstash学习" class="headerlink" title="20． Logstash学习"></a>20． Logstash学习</h1><h2 id="20-1Logstash基本语法组成"><a href="#20-1Logstash基本语法组成" class="headerlink" title="20.1Logstash基本语法组成"></a>20.1Logstash基本语法组成</h2><p><img src="/img/1573291947262.png" alt="1573291947262"></p>
<h3 id="1什么是Logstash"><a href="#1什么是Logstash" class="headerlink" title="1什么是Logstash"></a>1什么是Logstash</h3><p>logstash是一个数据抽取工具，将数据从一个地方转移到另一个地方。如hadoop生态圈的sqoop等。下载地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/logstash">https://www.elastic.co/cn/downloads/logstash</a></p>
<p>logstash之所以功能强大和流行，还与其丰富的过滤器插件是分不开的，过滤器提供的并不单单是过滤的功能，还可以对进入过滤器的原始数据进行复杂的逻辑处理，甚至添加独特的事件到后续流程中。<br>    Logstash配置文件有如下三部分组成，其中input、output部分是必须配置，filter部分是可选配置，而filter就是过滤器插件，可以在这部分实现各种日志过滤功能。</p>
<h3 id="2配置文件："><a href="#2配置文件：" class="headerlink" title="2配置文件："></a>2配置文件：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    #输入插件</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    #过滤匹配插件</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    #输出插件</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3启动操作："><a href="#3启动操作：" class="headerlink" title="3启动操作："></a>3启动操作：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logstash.bat -e &#x27;input&#123;stdin&#123;&#125;&#125; output&#123;stdout&#123;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>为了好维护，将配置写入文件，启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logstash.bat -f ../config/test1.conf</span><br></pre></td></tr></table></figure>
<h2 id="20-2-Logstash输入插件（input）"><a href="#20-2-Logstash输入插件（input）" class="headerlink" title="20.2 Logstash输入插件（input）"></a>20.2 Logstash输入插件（input）</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/input-plugins.html">https://www.elastic.co/guide/en/logstash/current/input-plugins.html</a></p>
<h3 id="1、标准输入-Stdin"><a href="#1、标准输入-Stdin" class="headerlink" title="1、标准输入(Stdin)"></a>1、标准输入(Stdin)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">input&#123;</span><br><span class="line">    stdin&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec=&gt;rubydebug    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2、读取文件-File"><a href="#2、读取文件-File" class="headerlink" title="2、读取文件(File)"></a>2、读取文件(File)</h3><p>logstash使用一个名为filewatch的ruby gem库来监听文件变化,并通过一个叫.sincedb的数据库文件来记录被监听的日志文件的读取进度（时间戳），这个sincedb数据文件的默认路径在 <path.data>/plugins/inputs/file下面，文件名类似于.sincedb_123456，而<path.data>表示logstash插件存储目录，默认是LOGSTASH_HOME/data。</path.data></path.data></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [&quot;/var/*/*&quot;]</span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec=&gt;rubydebug    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下，logstash会从文件的结束位置开始读取数据，也就是说logstash进程会以类似tail -f命令的形式逐行获取数据。</p>
<h3 id="3、读取TCP网络数据"><a href="#3、读取TCP网络数据" class="headerlink" title="3、读取TCP网络数据"></a>3、读取TCP网络数据</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; &quot;1234&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;SYSLOGLINE&#125;&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec=&gt;rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="20-3-Logstash过滤器插件-Filter"><a href="#20-3-Logstash过滤器插件-Filter" class="headerlink" title="20.3 Logstash过滤器插件(Filter)"></a>20.3 Logstash过滤器插件(Filter)</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/filter-plugins.html">https://www.elastic.co/guide/en/logstash/current/filter-plugins.html</a></p>
<h3 id="20-13-1Grok-正则捕获"><a href="#20-13-1Grok-正则捕获" class="headerlink" title="20.13.1Grok 正则捕获"></a>20.13.1Grok 正则捕获</h3><p>grok是一个十分强大的logstash filter插件，他可以通过正则解析任意文本，将非结构化日志数据弄成结构化和方便查询的结构。他是目前logstash 中解析非结构化日志数据最好的方式。</p>
<p>Grok 的语法规则是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;语法: 语义&#125;</span><br></pre></td></tr></table></figure>
<p>例如输入的内容为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.16.213.132 [07/Feb/2019:16:24:19 +0800] &quot;GET / HTTP/1.1&quot; 403 5039</span><br></pre></td></tr></table></figure>
<p>%{IP:clientip}匹配模式将获得的结果为：clientip: 172.16.213.132<br>%{HTTPDATE:timestamp}匹配模式将获得的结果为：timestamp: 07/Feb/2018:16:24:19 +0800<br>而%{QS:referrer}匹配模式将获得的结果为：referrer: “GET / HTTP/1.1”</p>
<p>下面是一个组合匹配模式，它可以获取上面输入的所有内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面这个组合匹配模式，我们将输入的内容分成了五个部分，即五个字段，将输入内容分割为不同的数据字段，这对于日后解析和查询日志数据非常有用，这正是使用grok的目的。</p>
<p>例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">input&#123;</span><br><span class="line">    stdin&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">filter&#123;</span><br><span class="line">    grok&#123;</span><br><span class="line">        match =&gt; [&quot;message&quot;,&quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output&#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        codec =&gt; &quot;rubydebug&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输入内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.16.213.132 [07/Feb/2019:16:24:19 +0800] &quot;GET / HTTP/1.1&quot; 403 5039</span><br></pre></td></tr></table></figure>
<h3 id="20-13-2时间处理-Date"><a href="#20-13-2时间处理-Date" class="headerlink" title="20.13.2时间处理(Date)"></a>20.13.2时间处理(Date)</h3><p>date插件是对于排序事件和回填旧数据尤其重要，它可以用来转换日志记录中的时间字段，变成LogStash::Timestamp对象，然后转存到@timestamp字段里，这在之前已经做过简单的介绍。<br>下面是date插件的一个配置示例（这里仅仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; [&quot;message&quot;, &quot;%&#123;HTTPDATE:timestamp&#125;&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="20-13-3、数据修改-Mutate"><a href="#20-13-3、数据修改-Mutate" class="headerlink" title="20.13.3、数据修改(Mutate)"></a>20.13.3、数据修改(Mutate)</h3><h4 id="（1）正则表达式替换匹配字段"><a href="#（1）正则表达式替换匹配字段" class="headerlink" title="（1）正则表达式替换匹配字段"></a>（1）正则表达式替换匹配字段</h4><p>gsub可以通过正则表达式替换字段中匹配到的值，只对字符串字段有效，下面是一个关于mutate插件中gsub的示例（仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        gsub =&gt; [&quot;filed_name_1&quot;, &quot;/&quot; , &quot;_&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个示例表示将filed<em>name_1字段中所有”/“字符替换为”</em>“。</p>
<h4 id="（2）分隔符分割字符串为数组"><a href="#（2）分隔符分割字符串为数组" class="headerlink" title="（2）分隔符分割字符串为数组"></a>（2）分隔符分割字符串为数组</h4><p>split可以通过指定的分隔符分割字段中的字符串为数组，下面是一个关于mutate插件中split的示例（仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        split =&gt; [&quot;filed_name_2&quot;, &quot;|&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个示例表示将filed_name_2字段以”|”为区间分隔为数组。</p>
<h4 id="（3）重命名字段"><a href="#（3）重命名字段" class="headerlink" title="（3）重命名字段"></a>（3）重命名字段</h4><p>rename可以实现重命名某个字段的功能，下面是一个关于mutate插件中rename的示例（仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; &#123; &quot;old_field&quot; =&gt; &quot;new_field&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个示例表示将字段old_field重命名为new_field。</p>
<h4 id="（4）删除字段"><a href="#（4）删除字段" class="headerlink" title="（4）删除字段"></a>（4）删除字段</h4><p>remove_field可以实现删除某个字段的功能，下面是一个关于mutate插件中remove_field的示例（仅列出filter部分）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field  =&gt;  [&quot;timestamp&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个示例表示将字段timestamp删除。</p>
<h4 id="（5）GeoIP-地址查询归类"><a href="#（5）GeoIP-地址查询归类" class="headerlink" title="（5）GeoIP 地址查询归类"></a>（5）GeoIP 地址查询归类</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    geoip &#123;</span><br><span class="line">        source =&gt; &quot;ip_field&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="综合例子："><a href="#综合例子：" class="headerlink" title="综合例子："></a>综合例子：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot; &#125;</span><br><span class="line">        remove_field =&gt; [ &quot;message&quot; ]</span><br><span class="line">   &#125;</span><br><span class="line">date &#123;</span><br><span class="line">        match =&gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">mutate &#123;</span><br><span class="line">          convert =&gt; [ &quot;response&quot;,&quot;float&quot; ]</span><br><span class="line">           rename =&gt; &#123; &quot;response&quot; =&gt; &quot;response_new&quot; &#125;   </span><br><span class="line">           gsub =&gt; [&quot;referrer&quot;,&quot;\&quot;&quot;,&quot;&quot;]          </span><br><span class="line">           split =&gt; [&quot;clientip&quot;, &quot;.&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; &quot;rubydebug&quot;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="20-4-Logstash输出插件（output）"><a href="#20-4-Logstash输出插件（output）" class="headerlink" title="20.4 Logstash输出插件（output）"></a>20.4 Logstash输出插件（output）</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/output-plugins.html">https://www.elastic.co/guide/en/logstash/current/output-plugins.html</a></p>
<p>output是Logstash的最后阶段，一个事件可以经过多个输出，而一旦所有输出处理完成，整个事件就执行完成。 一些常用的输出包括：</p>
<ul>
<li>file：  表示将日志数据写入磁盘上的文件。</li>
<li>elasticsearch：表示将日志数据发送给Elasticsearch。Elasticsearch可以高效方便和易于查询的保存数据。</li>
</ul>
<p>1、输出到标准输出(stdout)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、保存为文件（file）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; &quot;/data/log/%&#123;+yyyy-MM-dd&#125;/%&#123;host&#125;_%&#123;+HH&#125;.log&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、输出到elasticsearch</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        host =&gt; [&quot;192.168.1.1:9200&quot;,&quot;172.16.213.77:9200&quot;]</span><br><span class="line">        index =&gt; &quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>host：是一个数组类型的值，后面跟的值是elasticsearch节点的地址与端口，默认端口是9200。可添加多个地址。</li>
<li>index：写入elasticsearch的索引的名称，这里可以使用变量。Logstash提供了%{+YYYY.MM.dd}这种写法。在语法解析的时候，看到以+ 号开头的，就会自动认为后面是时间格式，尝试用时间格式来解析后续字符串。这种以天为单位分割的写法，可以很容易的删除老的数据或者搜索指定时间范围内的数据。此外，注意索引名中不能有大写字母。</li>
<li>manage_template:用来设置是否开启logstash自动管理模板功能，如果设置为false将关闭自动管理模板功能。如果我们自定义了模板，那么应该设置为false。</li>
<li>template_name:这个配置项用来设置在Elasticsearch中模板的名称。</li>
</ul>
<h2 id="20-5-综合案例"><a href="#20-5-综合案例" class="headerlink" title="20.5 综合案例"></a>20.5 综合案例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [&quot;D:/ES/logstash-7.3.0/nginx.log&quot;]        </span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot; &#125;</span><br><span class="line">        remove_field =&gt; [ &quot;message&quot; ]</span><br><span class="line">   &#125;</span><br><span class="line">	date &#123;</span><br><span class="line">        match =&gt; [&quot;timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">	mutate &#123;</span><br><span class="line">           rename =&gt; &#123; &quot;response&quot; =&gt; &quot;response_new&quot; &#125;</span><br><span class="line">           convert =&gt; [ &quot;response&quot;,&quot;float&quot; ]</span><br><span class="line">           gsub =&gt; [&quot;referrer&quot;,&quot;\&quot;&quot;,&quot;&quot;]</span><br><span class="line">           remove_field =&gt; [&quot;timestamp&quot;]</span><br><span class="line">           split =&gt; [&quot;clientip&quot;, &quot;.&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; &quot;rubydebug&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">elasticsearch &#123;</span><br><span class="line">    host =&gt; [&quot;localhost:9200&quot;]</span><br><span class="line">    index =&gt; &quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;       </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="21．-kibana学习"><a href="#21．-kibana学习" class="headerlink" title="21． kibana学习"></a>21． kibana学习</h1><h2 id="21-1基本查询"><a href="#21-1基本查询" class="headerlink" title="21.1基本查询"></a>21.1基本查询</h2><p>1是什么：elk中数据展现工具。</p>
<p>2下载：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/kibana">https://www.elastic.co/cn/downloads/kibana</a></p>
<p>3使用：建立索引模式，index partten</p>
<p>discover 中使用DSL搜索。</p>
<h2 id="21-2-可视化"><a href="#21-2-可视化" class="headerlink" title="21.2 可视化"></a>21.2 可视化</h2><p>绘制图形</p>
<h2 id="21-3-仪表盘"><a href="#21-3-仪表盘" class="headerlink" title="21.3 仪表盘"></a>21.3 仪表盘</h2><p>将各种可视化图形放入，形成大屏幕。</p>
<h2 id="21-4-使用模板数据指导绘图"><a href="#21-4-使用模板数据指导绘图" class="headerlink" title="21.4 使用模板数据指导绘图"></a>21.4 使用模板数据指导绘图</h2><p>点击主页的添加模板数据，可以看到很多模板数据以及绘图。</p>
<h2 id="21-5-其他功能"><a href="#21-5-其他功能" class="headerlink" title="21.5 其他功能"></a>21.5 其他功能</h2><p>监控，日志，APM等功能非常丰富。</p>
<h1 id="22．-集群部署"><a href="#22．-集群部署" class="headerlink" title="22． 集群部署"></a>22． 集群部署</h1><p>见部署图</p>
<h3 id="结点的三个角色"><a href="#结点的三个角色" class="headerlink" title="结点的三个角色"></a>结点的三个角色</h3><p>主结点：master节点主要用于集群的管理及索引 比如新增结点、分片分配、索引的新增和删除等。 数据结点：data 节点上保存了数据分片，它负责索引和搜索操作。 客户端结点：client 节点仅作为请求客户端存在，client的作用也作为负载均衡器，client 节点不存数据，只是将请求均衡转发到其它结点。</p>
<p>通过下边两项参数来配置结点的功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node.master: #是否允许为主结点</span><br><span class="line">node.data: #允许存储数据作为数据结点</span><br><span class="line">node.ingest: #是否允许成为协调节点</span><br></pre></td></tr></table></figure>
<p>四种组合方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">master=true，data=true：即是主结点又是数据结点</span><br><span class="line">master=false，data=true：仅是数据结点</span><br><span class="line">master=true，data=false：仅是主结点，不存储数据</span><br><span class="line">master=false，data=false：即不是主结点也不是数据结点，此时可设置ingest为true表示它是一个客户端。</span><br></pre></td></tr></table></figure>
<h1 id="23．-项目实战"><a href="#23．-项目实战" class="headerlink" title="23． 项目实战"></a>23． 项目实战</h1><h2 id="23-1项目一：ELK用于日志分析"><a href="#23-1项目一：ELK用于日志分析" class="headerlink" title="23.1项目一：ELK用于日志分析"></a>23.1项目一：ELK用于日志分析</h2><p>需求：集中收集分布式服务的日志</p>
<p>1逻辑模块程序随时输出日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * creste by itheima.itcast</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLog</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER= LoggerFactory.getLogger(TestLog.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLog</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">int</span> userid=random.nextInt(<span class="number">10</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;userId:&#123;&#125;,send:&#123;&#125;&quot;</span>,userid,<span class="string">&quot;hello world.I am &quot;</span>+userid);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2logstash收集日志到es</p>
<p><strong>grok 内置类型</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">USERNAME [a-zA-Z0-9._-]+</span><br><span class="line">USER %&#123;USERNAME&#125;</span><br><span class="line">INT (?:[+-]?(?:[0-9]+))</span><br><span class="line">BASE10NUM (?&lt;![0-9.+-])(?&gt;[+-]?(?:(?:[0-9]+(?:\.[0-9]+)?)|(?:\.[0-9]+)))</span><br><span class="line">NUMBER (?:%&#123;BASE10NUM&#125;)</span><br><span class="line">BASE16NUM (?&lt;![0-9A-Fa-f])(?:[+-]?(?:0x)?(?:[0-9A-Fa-f]+))</span><br><span class="line">BASE16FLOAT \b(?&lt;![0-9A-Fa-f.])(?:[+-]?(?:0x)?(?:(?:[0-9A-Fa-f]+(?:\.[0-9A-Fa-f]*)?)|(?:\.[0-9A-Fa-f]+)))\b</span><br><span class="line"></span><br><span class="line">POSINT \b(?:[1-9][0-9]*)\b</span><br><span class="line">NONNEGINT \b(?:[0-9]+)\b</span><br><span class="line">WORD \b\w+\b</span><br><span class="line">NOTSPACE \S+</span><br><span class="line">SPACE \s*</span><br><span class="line">DATA .*?</span><br><span class="line">GREEDYDATA .*</span><br><span class="line">QUOTEDSTRING (?&gt;(?&lt;!\\)(?&gt;&quot;(?&gt;\\.|[^\\&quot;]+)+&quot;|&quot;&quot;|(?&gt;&#x27;(?&gt;\\.|[^\\&#x27;]+)+&#x27;)|&#x27;&#x27;|(?&gt;`(?&gt;\\.|[^\\`]+)+`)|``))</span><br><span class="line">UUID [A-Fa-f0-9]&#123;8&#125;-(?:[A-Fa-f0-9]&#123;4&#125;-)&#123;3&#125;[A-Fa-f0-9]&#123;12&#125;</span><br><span class="line"></span><br><span class="line"># Networking</span><br><span class="line">MAC (?:%&#123;CISCOMAC&#125;|%&#123;WINDOWSMAC&#125;|%&#123;COMMONMAC&#125;)</span><br><span class="line">CISCOMAC (?:(?:[A-Fa-f0-9]&#123;4&#125;\.)&#123;2&#125;[A-Fa-f0-9]&#123;4&#125;)</span><br><span class="line">WINDOWSMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;-)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)</span><br><span class="line">COMMONMAC (?:(?:[A-Fa-f0-9]&#123;2&#125;:)&#123;5&#125;[A-Fa-f0-9]&#123;2&#125;)</span><br><span class="line">IPV6 ((([0-9A-Fa-f]&#123;1,4&#125;:)&#123;7&#125;([0-9A-Fa-f]&#123;1,4&#125;|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;6&#125;(:[0-9A-Fa-f]&#123;1,4&#125;|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;5&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,2&#125;)|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;)|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;4&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,3&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;3&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,4&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,2&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;2&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,5&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,3&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(([0-9A-Fa-f]&#123;1,4&#125;:)&#123;1&#125;(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,6&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,4&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:))|(:(((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;1,7&#125;)|((:[0-9A-Fa-f]&#123;1,4&#125;)&#123;0,5&#125;:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d))&#123;3&#125;))|:)))(%.+)?</span><br><span class="line">IPV4 (?&lt;![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;)[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;)[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;)[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]&#123;1,2&#125;))(?![0-9])</span><br><span class="line">IP (?:%&#123;IPV6&#125;|%&#123;IPV4&#125;)</span><br><span class="line">HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;)(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]&#123;0,62&#125;))*(\.?|\b)</span><br><span class="line">HOST %&#123;HOSTNAME&#125;</span><br><span class="line">IPORHOST (?:%&#123;HOSTNAME&#125;|%&#123;IP&#125;)</span><br><span class="line">HOSTPORT %&#123;IPORHOST&#125;:%&#123;POSINT&#125;</span><br><span class="line"></span><br><span class="line"># paths</span><br><span class="line">PATH (?:%&#123;UNIXPATH&#125;|%&#123;WINPATH&#125;)</span><br><span class="line">UNIXPATH (?&gt;/(?&gt;[\w_%!$@:.,-]+|\\.)*)+</span><br><span class="line">TTY (?:/dev/(pts|tty([pq])?)(\w+)?/?(?:[0-9]+))</span><br><span class="line">WINPATH (?&gt;[A-Za-z]+:|\\)(?:\\[^\\?*]*)+</span><br><span class="line">URIPROTO [A-Za-z]+(\+[A-Za-z+]+)?</span><br><span class="line">URIHOST %&#123;IPORHOST&#125;(?::%&#123;POSINT:port&#125;)?</span><br><span class="line"># uripath comes loosely from RFC1738, but mostly from what Firefox</span><br><span class="line"># doesn&#x27;t turn into %XX</span><br><span class="line">URIPATH (?:/[A-Za-z0-9$.+!*&#x27;()&#123;&#125;,~:;=@#%_\-]*)+</span><br><span class="line">#URIPARAM \?(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?(?:&amp;(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?)?)*)?</span><br><span class="line">URIPARAM \?[A-Za-z0-9$.+!*&#x27;|()&#123;&#125;,~@#%&amp;/=:;_?\-\[\]]*</span><br><span class="line">URIPATHPARAM %&#123;URIPATH&#125;(?:%&#123;URIPARAM&#125;)?</span><br><span class="line">URI %&#123;URIPROTO&#125;://(?:%&#123;USER&#125;(?::[^@]*)?@)?(?:%&#123;URIHOST&#125;)?(?:%&#123;URIPATHPARAM&#125;)?</span><br><span class="line"></span><br><span class="line"># Months: January, Feb, 3, 03, 12, December</span><br><span class="line">MONTH \b(?:Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:tember)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)\b</span><br><span class="line">MONTHNUM (?:0?[1-9]|1[0-2])</span><br><span class="line">MONTHNUM2 (?:0[1-9]|1[0-2])</span><br><span class="line">MONTHDAY (?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])</span><br><span class="line"></span><br><span class="line"># Days: Monday, Tue, Thu, etc...</span><br><span class="line">DAY (?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?)</span><br><span class="line"></span><br><span class="line"># Years?</span><br><span class="line">YEAR (?&gt;\d\d)&#123;1,2&#125;</span><br><span class="line">HOUR (?:2[0123]|[01]?[0-9])</span><br><span class="line">MINUTE (?:[0-5][0-9])</span><br><span class="line"># &#x27;60&#x27; is a leap second in most time standards and thus is valid.</span><br><span class="line">SECOND (?:(?:[0-5]?[0-9]|60)(?:[:.,][0-9]+)?)</span><br><span class="line">TIME (?!&lt;[0-9])%&#123;HOUR&#125;:%&#123;MINUTE&#125;(?::%&#123;SECOND&#125;)(?![0-9])</span><br><span class="line"># datestamp is YYYY/MM/DD-HH:MM:SS.UUUU (or something like it)</span><br><span class="line">DATE_US %&#123;MONTHNUM&#125;[/-]%&#123;MONTHDAY&#125;[/-]%&#123;YEAR&#125;</span><br><span class="line">DATE_EU %&#123;MONTHDAY&#125;[./-]%&#123;MONTHNUM&#125;[./-]%&#123;YEAR&#125;</span><br><span class="line">ISO8601_TIMEZONE (?:Z|[+-]%&#123;HOUR&#125;(?::?%&#123;MINUTE&#125;))</span><br><span class="line">ISO8601_SECOND (?:%&#123;SECOND&#125;|60)</span><br><span class="line">TIMESTAMP_ISO8601 %&#123;YEAR&#125;-%&#123;MONTHNUM&#125;-%&#123;MONTHDAY&#125;[T ]%&#123;HOUR&#125;:?%&#123;MINUTE&#125;(?::?%&#123;SECOND&#125;)?%&#123;ISO8601_TIMEZONE&#125;?</span><br><span class="line">DATE %&#123;DATE_US&#125;|%&#123;DATE_EU&#125;</span><br><span class="line">DATESTAMP %&#123;DATE&#125;[- ]%&#123;TIME&#125;</span><br><span class="line">TZ (?:[PMCE][SD]T|UTC)</span><br><span class="line">DATESTAMP_RFC822 %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;TZ&#125;</span><br><span class="line">DATESTAMP_RFC2822 %&#123;DAY&#125;, %&#123;MONTHDAY&#125; %&#123;MONTH&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;ISO8601_TIMEZONE&#125;</span><br><span class="line">DATESTAMP_OTHER %&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;TIME&#125; %&#123;TZ&#125; %&#123;YEAR&#125;</span><br><span class="line">DATESTAMP_EVENTLOG %&#123;YEAR&#125;%&#123;MONTHNUM2&#125;%&#123;MONTHDAY&#125;%&#123;HOUR&#125;%&#123;MINUTE&#125;%&#123;SECOND&#125;</span><br><span class="line"></span><br><span class="line"># Syslog Dates: Month Day HH:MM:SS</span><br><span class="line">SYSLOGTIMESTAMP %&#123;MONTH&#125; +%&#123;MONTHDAY&#125; %&#123;TIME&#125;</span><br><span class="line">PROG (?:[\w._/%-]+)</span><br><span class="line">SYSLOGPROG %&#123;PROG:program&#125;(?:\[%&#123;POSINT:pid&#125;\])?</span><br><span class="line">SYSLOGHOST %&#123;IPORHOST&#125;</span><br><span class="line">SYSLOGFACILITY &lt;%&#123;NONNEGINT:facility&#125;.%&#123;NONNEGINT:priority&#125;&gt;</span><br><span class="line">HTTPDATE %&#123;MONTHDAY&#125;/%&#123;MONTH&#125;/%&#123;YEAR&#125;:%&#123;TIME&#125; %&#123;INT&#125;</span><br><span class="line"></span><br><span class="line"># Shortcuts</span><br><span class="line">QS %&#123;QUOTEDSTRING&#125;</span><br><span class="line"></span><br><span class="line"># Log formats</span><br><span class="line">SYSLOGBASE %&#123;SYSLOGTIMESTAMP:timestamp&#125; (?:%&#123;SYSLOGFACILITY&#125; )?%&#123;SYSLOGHOST:logsource&#125; %&#123;SYSLOGPROG&#125;:</span><br><span class="line">COMMONAPACHELOG %&#123;IPORHOST:clientip&#125; %&#123;USER:ident&#125; %&#123;USER:auth&#125; \[%&#123;HTTPDATE:timestamp&#125;\] &quot;(?:%&#123;WORD:verb&#125; %&#123;NOTSPACE:request&#125;(?: HTTP/%&#123;NUMBER:httpversion&#125;)?|%&#123;DATA:rawrequest&#125;)&quot; %&#123;NUMBER:response&#125; (?:%&#123;NUMBER:bytes&#125;|-)</span><br><span class="line">COMBINEDAPACHELOG %&#123;COMMONAPACHELOG&#125; %&#123;QS:referrer&#125; %&#123;QS:agent&#125;</span><br><span class="line"></span><br><span class="line"># Log Levels</span><br><span class="line">LOGLEVEL ([Aa]lert|ALERT|[Tt]race|TRACE|[Dd]ebug|DEBUG|[Nn]otice|NOTICE|[Ii]nfo|INFO|[Ww]arn?(?:ing)?|WARN?(?:ING)?|[Ee]rr?(?:or)?|ERR?(?:OR)?|[Cc]rit?(?:ical)?|CRIT?(?:ICAL)?|[Ff]atal|FATAL|[Ss]evere|SEVERE|EMERG(?:ENCY)?|[Ee]merg(?:ency)?)</span><br></pre></td></tr></table></figure>
<p>写logstash配置文件。</p>
<p>3kibana展现数据</p>
<h2 id="23-2项目二：学成在线站内搜索模块"><a href="#23-2项目二：学成在线站内搜索模块" class="headerlink" title="23.2项目二：学成在线站内搜索模块"></a>23.2项目二：学成在线站内搜索模块</h2><h3 id="1mysql导入course-pub表"><a href="#1mysql导入course-pub表" class="headerlink" title="1mysql导入course_pub表"></a>1mysql导入course_pub表</h3><h3 id="2创建索引xc-course"><a href="#2创建索引xc-course" class="headerlink" title="2创建索引xc_course"></a>2创建索引xc_course</h3><h3 id="3创建映射"><a href="#3创建映射" class="headerlink" title="3创建映射"></a>3创建映射</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">PUT /xc_course</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1,</span><br><span class="line">    &quot;number_of_replicas&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;description&quot; : &#123;</span><br><span class="line">                &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">                &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;grade&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;id&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;mt&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;name&quot; : &#123;</span><br><span class="line">                &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">           &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;users&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;charge&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;valid&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;pic&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;qq&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;price&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;float&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;price_old&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;float&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;st&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;status&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;studymodel&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;teachmode&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;teachplan&quot; : &#123;</span><br><span class="line">                &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">           &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">           &quot;expires&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;pub_time&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;,</span><br><span class="line">             &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;start_time&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;,</span><br><span class="line">           &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">          &quot;end_time&quot; : &#123;</span><br><span class="line">                 &quot;type&quot; : &quot;date&quot;,</span><br><span class="line">           &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4logstash创建模板文件"><a href="#4logstash创建模板文件" class="headerlink" title="4logstash创建模板文件"></a>4logstash创建模板文件</h3><p>Logstash的工作是从MySQL中读取数据，向ES中创建索引，这里需要提前创建mapping的模板文件以便logstash使用。</p>
<p>在logstach的config目录创建xc_course_template.json，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;doc&quot; : &#123;</span><br><span class="line">         &quot;properties&quot; : &#123;</span><br><span class="line">            &quot;charge&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;description&quot; : &#123;</span><br><span class="line">               &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">               &quot;search_analyzer&quot; : &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;end_time&quot; : &#123;</span><br><span class="line">               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;expires&quot; : &#123;</span><br><span class="line">               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;grade&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;id&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;mt&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;name&quot; : &#123;</span><br><span class="line">               &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">               &quot;search_analyzer&quot; : &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;pic&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;price&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;float&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;price_old&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;float&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;pub_time&quot; : &#123;</span><br><span class="line">               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;qq&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;st&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;start_time&quot; : &#123;</span><br><span class="line">               &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;date&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;status&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;studymodel&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;teachmode&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;teachplan&quot; : &#123;</span><br><span class="line">               &quot;analyzer&quot; : &quot;ik_max_word&quot;,</span><br><span class="line">               &quot;search_analyzer&quot; : &quot;ik_smart&quot;,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;users&quot; : &#123;</span><br><span class="line">               &quot;index&quot; : false,</span><br><span class="line">               &quot;type&quot; : &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;valid&quot; : &#123;</span><br><span class="line">               &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;template&quot; : &quot;xc_course&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5logstash配置mysql-conf"><a href="#5logstash配置mysql-conf" class="headerlink" title="5logstash配置mysql.conf"></a>5logstash配置mysql.conf</h3><p>1、ES采用UTC时区问题</p>
<p>ES采用UTC 时区，比北京时间早8小时，所以ES读取数据时让最后更新时间加8小时</p>
<p>where timestamp &gt; date_add(:sql_last_value,INTERVAL 8 HOUR)</p>
<p>2、logstash每个执行完成会在/config/logstash_metadata记录执行时间下次以此时间为基准进行增量同步数据到索引库。</p>
<h3 id="6启动"><a href="#6启动" class="headerlink" title="6启动"></a>6启动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\logstash.bat -f ..\config\mysql.conf</span><br></pre></td></tr></table></figure>
<p>7后端代码</p>
<p>7.1Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/search/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsCourseController</span>  &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EsCourseService esCourseService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value=&quot;/list/&#123;page&#125;/&#123;size&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> QueryResponseResult&lt;CoursePub&gt; <span class="title function_">list</span><span class="params">(<span class="meta">@PathVariable(&quot;page&quot;)</span> <span class="type">int</span> page, <span class="meta">@PathVariable(&quot;size&quot;)</span> <span class="type">int</span> size, CourseSearchParam courseSearchParam)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> esCourseService.list(page,size,courseSearchParam);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>7.2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class EsCourseService &#123;</span><br><span class="line">    @Value(&quot;$&#123;heima.course.source_field&#125;&quot;)</span><br><span class="line">    private String source_field;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    //课程搜索</span><br><span class="line">    public QueryResponseResult&lt;CoursePub&gt; list(int page, int size, CourseSearchParam courseSearchParam) &#123;</span><br><span class="line">        if (courseSearchParam == null) &#123;</span><br><span class="line">            courseSearchParam = new CourseSearchParam();</span><br><span class="line">        &#125;</span><br><span class="line">        //1创建搜索请求对象</span><br><span class="line">        SearchRequest searchRequest = new SearchRequest(&quot;xc_course&quot;);</span><br><span class="line"></span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br><span class="line">        //过虑源字段</span><br><span class="line">        String[] source_field_array = source_field.split(&quot;,&quot;);</span><br><span class="line">        searchSourceBuilder.fetchSource(source_field_array, new String[]&#123;&#125;);</span><br><span class="line">        //创建布尔查询对象</span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        //搜索条件</span><br><span class="line">        //根据关键字搜索</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getKeyword())) &#123;</span><br><span class="line">            MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(courseSearchParam.getKeyword(), &quot;name&quot;, &quot;description&quot;, &quot;teachplan&quot;)</span><br><span class="line">                    .minimumShouldMatch(&quot;70%&quot;)</span><br><span class="line">                    .field(&quot;name&quot;, 10);</span><br><span class="line">            boolQueryBuilder.must(multiMatchQueryBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getMt())) &#123;</span><br><span class="line">            //根据一级分类</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;mt&quot;, courseSearchParam.getMt()));</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getSt())) &#123;</span><br><span class="line">            //根据二级分类</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;st&quot;, courseSearchParam.getSt()));</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.isNotEmpty(courseSearchParam.getGrade())) &#123;</span><br><span class="line">            //根据难度等级</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(&quot;grade&quot;, courseSearchParam.getGrade()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //设置boolQueryBuilder到searchSourceBuilder</span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line">        //设置分页参数</span><br><span class="line">        if (page &lt;= 0) &#123;</span><br><span class="line">            page = 1;</span><br><span class="line">        &#125;</span><br><span class="line">        if (size &lt;= 0) &#123;</span><br><span class="line">            size = 12;</span><br><span class="line">        &#125;</span><br><span class="line">        //起始记录下标</span><br><span class="line">        int from = (page - 1) * size;</span><br><span class="line">        searchSourceBuilder.from(from);</span><br><span class="line">        searchSourceBuilder.size(size);</span><br><span class="line"></span><br><span class="line">        //设置高亮</span><br><span class="line">        HighlightBuilder highlightBuilder = new HighlightBuilder();</span><br><span class="line">        highlightBuilder.preTags(&quot;&lt;font class=&#x27;eslight&#x27;&gt;&quot;);</span><br><span class="line">        highlightBuilder.postTags(&quot;&lt;/font&gt;&quot;);</span><br><span class="line">        //设置高亮字段</span><br><span class="line">//        &lt;font class=&#x27;eslight&#x27;&gt;node&lt;/font&gt;学习</span><br><span class="line">        highlightBuilder.fields().add(new HighlightBuilder.Field(&quot;name&quot;));</span><br><span class="line">        searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line"></span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">        QueryResult&lt;CoursePub&gt; queryResult = new QueryResult();</span><br><span class="line">        List&lt;CoursePub&gt; list = new ArrayList&lt;CoursePub&gt;();</span><br><span class="line">        try &#123;</span><br><span class="line">            //2执行搜索</span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">            //3获取响应结果</span><br><span class="line">            SearchHits hits = searchResponse.getHits();</span><br><span class="line">            long totalHits=hits.getTotalHits().value;</span><br><span class="line">            //匹配的总记录数</span><br><span class="line">//            long totalHits = hits.totalHits;</span><br><span class="line">            queryResult.setTotal(totalHits);</span><br><span class="line">            SearchHit[] searchHits = hits.getHits();</span><br><span class="line">            for (SearchHit hit : searchHits) &#123;</span><br><span class="line">                CoursePub coursePub = new CoursePub();</span><br><span class="line">                //源文档</span><br><span class="line">                Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">                //取出id</span><br><span class="line">                String id = (String) sourceAsMap.get(&quot;id&quot;);</span><br><span class="line">                coursePub.setId(id);</span><br><span class="line">                //取出name</span><br><span class="line">                String name = (String) sourceAsMap.get(&quot;name&quot;);</span><br><span class="line">                //取出高亮字段name</span><br><span class="line">                Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">                if (highlightFields != null) &#123;</span><br><span class="line">                    HighlightField highlightFieldName = highlightFields.get(&quot;name&quot;);</span><br><span class="line">                    if (highlightFieldName != null) &#123;</span><br><span class="line">                        Text[] fragments = highlightFieldName.fragments();</span><br><span class="line">                        StringBuffer stringBuffer = new StringBuffer();</span><br><span class="line">                        for (Text text : fragments) &#123;</span><br><span class="line">                            stringBuffer.append(text);</span><br><span class="line">                        &#125;</span><br><span class="line">                        name = stringBuffer.toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setName(name);</span><br><span class="line">                //图片</span><br><span class="line">                String pic = (String) sourceAsMap.get(&quot;pic&quot;);</span><br><span class="line">                coursePub.setPic(pic);</span><br><span class="line">                //价格</span><br><span class="line">                Double price = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (sourceAsMap.get(&quot;price&quot;) != null) &#123;</span><br><span class="line">                        price = (Double) sourceAsMap.get(&quot;price&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setPrice(price);</span><br><span class="line">                //旧价格</span><br><span class="line">                Double price_old = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (sourceAsMap.get(&quot;price_old&quot;) != null) &#123;</span><br><span class="line">                        price_old = (Double) sourceAsMap.get(&quot;price_old&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                coursePub.setPrice_old(price_old);</span><br><span class="line">                //将coursePub对象放入list</span><br><span class="line">                list.add(coursePub);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        queryResult.setList(list);</span><br><span class="line">        QueryResponseResult&lt;CoursePub&gt; queryResponseResult = new QueryResponseResult&lt;CoursePub&gt;(CommonCode.SUCCESS, queryResult);</span><br><span class="line"></span><br><span class="line">        return queryResponseResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        <div class="reward-container">
  <div>有帮助的话可以来打赏一些或者经常来看看我哦，我在这里等你！</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="白都 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="白都 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/10/03/MySQL%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E6%95%85%E9%9A%9C%EF%BC%9ASlave-SQL-Running-NO/" rel="prev" title="MySQL主从同步故障：Slave_SQL_Running:NO">
      <i class="fa fa-chevron-left"></i> MySQL主从同步故障：Slave_SQL_Running:NO
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/22/Docker%E5%AE%9E%E7%94%A8%E7%AF%87/" rel="next" title="Docker实用篇">
      Docker实用篇 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
  

  <aside class="sidebar">
    <div class="sidebar-inner">
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=52 src="//music.163.com/outchain/player?type=0&id=6660459076&auto=1&height=32"></iframe>
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ELK%E6%90%9C%E7%B4%A2%E9%AB%98%E7%BA%A7%E8%AF%BE%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">ELK搜索高级课程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1%EF%BC%8E-%E8%AF%BE%E7%A8%8B%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text">1． 课程简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E8%AF%BE%E7%A8%8B%E5%86%85%E5%AE%B9"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 课程内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E9%9D%A2%E5%90%91%E4%BA%BA%E5%91%98"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 面向人员</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E8%AF%BE%E7%A8%8B%E4%BC%98%E5%8A%BF"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 课程优势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E5%AD%A6%E4%B9%A0%E8%B7%AF%E5%BE%84"><span class="nav-number">2.4.</span> <span class="nav-text">1.4 学习路径</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2%EF%BC%8E-Elastic-Stack%E7%AE%80%E4%BB%8B"><span class="nav-number">3.</span> <span class="nav-text">2． Elastic Stack简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1%E7%AE%80%E4%BB%8B"><span class="nav-number">3.1.</span> <span class="nav-text">2.1简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2%E7%89%B9%E8%89%B2"><span class="nav-number">3.2.</span> <span class="nav-text">2.2特色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.3.</span> <span class="nav-text">2.3组件介绍</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3%EF%BC%8E-Elasticsearch%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">4.</span> <span class="nav-text">3． Elasticsearch是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1%E6%90%9C%E7%B4%A2%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">4.1.</span> <span class="nav-text">3.1搜索是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%81%9A%E6%90%9C%E7%B4%A2%E5%BC%8A%E7%AB%AF"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 数据库做搜索弊端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1%E7%AB%99%E5%86%85%E6%90%9C%E7%B4%A2%EF%BC%88%E5%9E%82%E7%9B%B4%E6%90%9C%E7%B4%A2%EF%BC%89%EF%BC%9A%E6%95%B0%E6%8D%AE%E9%87%8F%E5%B0%8F%EF%BC%8C%E7%AE%80%E5%8D%95%E6%90%9C%E7%B4%A2%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82"><span class="nav-number">4.2.1.</span> <span class="nav-text">3.2.1站内搜索（垂直搜索）：数据量小，简单搜索，可以使用数据库。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2%E4%BA%92%E8%81%94%E7%BD%91%E6%90%9C%E7%B4%A2%EF%BC%8C%E8%82%AF%E5%AE%9A%E4%B8%8D%E4%BC%9A%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E6%90%9C%E7%B4%A2%E3%80%82%E6%95%B0%E6%8D%AE%E9%87%8F%E5%A4%AA%E5%A4%A7%E3%80%82PB%E7%BA%A7%E3%80%82"><span class="nav-number">4.2.2.</span> <span class="nav-text">3.2.2互联网搜索，肯定不会使用数据库搜索。数据量太大。PB级。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E3%80%81%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%92%8CLucene"><span class="nav-number">4.3.</span> <span class="nav-text">3.3全文检索、倒排索引和Lucene</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="nav-number">4.3.0.1.</span> <span class="nav-text">全文检索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Lucene"><span class="nav-number">4.3.0.2.</span> <span class="nav-text">Lucene</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E4%BB%80%E4%B9%88%E6%98%AFElasticsearch"><span class="nav-number">4.4.</span> <span class="nav-text">3.4 什么是Elasticsearch</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">4.4.0.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Elasticsearch%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-number">4.4.0.2.</span> <span class="nav-text">Elasticsearch的功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Elasticsearch%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">4.4.0.3.</span> <span class="nav-text">Elasticsearch的使用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Elasticsearch%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">4.4.0.4.</span> <span class="nav-text">Elasticsearch的特点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-elasticsearch%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">4.5.</span> <span class="nav-text">3.5 elasticsearch核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-1-lucene%E5%92%8Celasticsearch%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-number">4.5.1.</span> <span class="nav-text">3.5.1 lucene和elasticsearch的关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-2-elasticsearch%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">4.5.2.</span> <span class="nav-text">3.5.2 elasticsearch的核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-NRT%EF%BC%88Near-Realtime%EF%BC%89%EF%BC%9A%E8%BF%91%E5%AE%9E%E6%97%B6"><span class="nav-number">4.5.2.1.</span> <span class="nav-text">1 NRT（Near Realtime）：近实时</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-Cluster%EF%BC%9A%E9%9B%86%E7%BE%A4"><span class="nav-number">4.5.2.2.</span> <span class="nav-text">2 Cluster：集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-Node%EF%BC%9A%E8%8A%82%E7%82%B9"><span class="nav-number">4.5.2.3.</span> <span class="nav-text">3 Node：节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-Index%EF%BC%9A%E7%B4%A2%E5%BC%95"><span class="nav-number">4.5.2.4.</span> <span class="nav-text">4 Index：索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-Document%EF%BC%9A%E6%96%87%E6%A1%A3"><span class="nav-number">4.5.2.5.</span> <span class="nav-text">5  Document：文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-Field-%E5%AD%97%E6%AE%B5"><span class="nav-number">4.5.2.6.</span> <span class="nav-text">6 Field:字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-Type%EF%BC%9A%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.5.2.7.</span> <span class="nav-text">7 Type：类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-shard%EF%BC%9A%E5%88%86%E7%89%87"><span class="nav-number">4.5.2.8.</span> <span class="nav-text">8 shard：分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-replica%EF%BC%9A%E5%89%AF%E6%9C%AC"><span class="nav-number">4.5.2.9.</span> <span class="nav-text">9 replica：副本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-3-elasticsearch%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5-vs-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">4.5.3.</span> <span class="nav-text">3.5.3 elasticsearch核心概念 vs. 数据库核心概念</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4%EF%BC%8E-Elasticsearch%E7%9B%B8%E5%85%B3%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="nav-number">5.</span> <span class="nav-text">4． Elasticsearch相关软件安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-Windows%E5%AE%89%E8%A3%85elasticsearch"><span class="nav-number">5.1.</span> <span class="nav-text">4.1.  Windows安装elasticsearch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85JDK%EF%BC%8C%E8%87%B3%E5%B0%911-8-0-73%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%EF%BC%8C%E9%AA%8C%E8%AF%81%EF%BC%9Ajava-version%E3%80%82"><span class="nav-number">5.1.1.</span> <span class="nav-text">1、安装JDK，至少1.8.0_73以上版本，验证：java -version。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E4%B8%8B%E8%BD%BD%E5%92%8C%E8%A7%A3%E5%8E%8B%E7%BC%A9Elasticsearch%E5%AE%89%E8%A3%85%E5%8C%85%EF%BC%8C%E6%9F%A5%E7%9C%8B%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E3%80%82"><span class="nav-number">5.1.2.</span> <span class="nav-text">2、下载和解压缩Elasticsearch安装包，查看目录结构。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="nav-number">5.1.3.</span> <span class="nav-text">3、配置文件：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81%E5%90%AF%E5%8A%A8Elasticsearch%EF%BC%9Abin-elasticsearch-bat%EF%BC%8Ces%E7%9A%84%E7%89%B9%E7%82%B9%E5%B0%B1%E6%98%AF%E5%BC%80%E7%AE%B1%E5%8D%B3%EF%BC%8C%E6%97%A0%E9%9C%80%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%90%AF%E5%8A%A8%E5%8D%B3%E5%8F%AF%E3%80%82"><span class="nav-number">5.1.4.</span> <span class="nav-text">4、启动Elasticsearch：bin\elasticsearch.bat，es的特点就是开箱即，无需配置，启动即可。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81%E6%A3%80%E6%9F%A5ES%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F%EF%BC%9A%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AEhttp-localhost-9200-Pretty"><span class="nav-number">5.1.5.</span> <span class="nav-text">5、检查ES是否启动成功：浏览器访问http:&#x2F;&#x2F;localhost:9200&#x2F;?Pretty</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%E3%80%81%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE-http-localhost-9200-cluster-health-%E6%9F%A5%E8%AF%A2%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="nav-number">5.1.6.</span> <span class="nav-text">6、浏览器访问 http:&#x2F;&#x2F;localhost:9200&#x2F;_cluster&#x2F;health 查询集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Windows%E5%AE%89%E8%A3%85Kibana"><span class="nav-number">5.2.</span> <span class="nav-text">4.2.  Windows安装Kibana</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-Windows%E5%AE%89%E8%A3%85postman"><span class="nav-number">5.3.</span> <span class="nav-text">4.3  Windows安装postman</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-Windows%E5%AE%89%E8%A3%85head%E6%8F%92%E4%BB%B6"><span class="nav-number">5.4.</span> <span class="nav-text">4.4 Windows安装head插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E5%AE%89%E8%A3%85node-js"><span class="nav-number">5.4.1.</span> <span class="nav-text">1安装node.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E4%B8%8B%E8%BD%BDhead%E5%B9%B6%E8%BF%90%E8%A1%8C"><span class="nav-number">5.4.2.</span> <span class="nav-text">2下载head并运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E8%BF%90%E8%A1%8C"><span class="nav-number">5.4.3.</span> <span class="nav-text">3运行</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5%EF%BC%8E-es%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number">6.</span> <span class="nav-text">5． es快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1%EF%BC%8E-%E6%96%87%E6%A1%A3%EF%BC%88document%EF%BC%89%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="nav-number">6.1.</span> <span class="nav-text">5.1． 文档（document）的数据格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2%E5%9B%BE%E4%B9%A6%E7%BD%91%E7%AB%99%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86%E6%A1%88%E4%BE%8B%EF%BC%9A%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.2.</span> <span class="nav-text">5.2图书网站商品管理案例：背景介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3%EF%BC%8E-%E7%AE%80%E5%8D%95%E7%9A%84%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="nav-number">6.3.</span> <span class="nav-text">5.3． 简单的集群管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1%E5%BF%AB%E9%80%9F%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4%E7%9A%84%E5%81%A5%E5%BA%B7%E7%8A%B6%E5%86%B5"><span class="nav-number">6.3.1.</span> <span class="nav-text">5.3.1快速检查集群的健康状况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-%E5%BF%AB%E9%80%9F%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%9C%89%E5%93%AA%E4%BA%9B%E7%B4%A2%E5%BC%95"><span class="nav-number">6.3.2.</span> <span class="nav-text">5.3.2 快速查看集群中有哪些索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-3-%E7%AE%80%E5%8D%95%E7%9A%84%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C"><span class="nav-number">6.3.3.</span> <span class="nav-text">5.3.3 简单的索引操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4%E5%95%86%E5%93%81%E7%9A%84CRUD%E6%93%8D%E4%BD%9C%EF%BC%88document-CRUD%E6%93%8D%E4%BD%9C%EF%BC%89"><span class="nav-number">6.4.</span> <span class="nav-text">5.4商品的CRUD操作（document CRUD操作）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-1-%E6%96%B0%E5%BB%BA%E5%9B%BE%E4%B9%A6%E7%B4%A2%E5%BC%95"><span class="nav-number">6.4.1.</span> <span class="nav-text">5.4.1 新建图书索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-2-%E6%96%B0%E5%A2%9E%E5%9B%BE%E4%B9%A6-%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3"><span class="nav-number">6.4.2.</span> <span class="nav-text">5.4.2 新增图书 :新增文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-3-%E6%9F%A5%E8%AF%A2%E5%9B%BE%E4%B9%A6%EF%BC%9A%E6%A3%80%E7%B4%A2%E6%96%87%E6%A1%A3"><span class="nav-number">6.4.3.</span> <span class="nav-text">5.4.3 查询图书：检索文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-4-%E4%BF%AE%E6%94%B9%E5%9B%BE%E4%B9%A6%EF%BC%9A%E6%9B%BF%E6%8D%A2%E6%93%8D%E4%BD%9C"><span class="nav-number">6.4.4.</span> <span class="nav-text">5.4.4 修改图书：替换操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-5-%E4%BF%AE%E6%94%B9%E5%9B%BE%E4%B9%A6%EF%BC%9A%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="nav-number">6.4.5.</span> <span class="nav-text">5.4.5 修改图书：更新文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-6-%E5%88%A0%E9%99%A4%E5%9B%BE%E4%B9%A6%EF%BC%9A%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="nav-number">6.4.6.</span> <span class="nav-text">5.4.6 删除图书：删除文档</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6%EF%BC%8E-%E6%96%87%E6%A1%A3document%E5%85%A5%E9%97%A8"><span class="nav-number">7.</span> <span class="nav-text">6． 文档document入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1%EF%BC%8E-%E9%BB%98%E8%AE%A4%E8%87%AA%E5%B8%A6%E5%AD%97%E6%AE%B5%E8%A7%A3%E6%9E%90"><span class="nav-number">7.1.</span> <span class="nav-text">6.1． 默认自带字段解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-1-index"><span class="nav-number">7.1.1.</span> <span class="nav-text">6.1.1 _index</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-2-type"><span class="nav-number">7.1.2.</span> <span class="nav-text">6.1.2 _type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-3-id"><span class="nav-number">7.1.3.</span> <span class="nav-text">6.1.3 _id</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-4-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%97%B6%EF%BC%8C%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E6%94%BE%E5%88%B0%E4%B8%8D%E5%90%8C%E7%B4%A2%E5%BC%95%E4%B8%AD"><span class="nav-number">7.1.4.</span> <span class="nav-text">6.1.4 创建索引时，不同数据放到不同索引中</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2%EF%BC%8E-%E7%94%9F%E6%88%90%E6%96%87%E6%A1%A3id"><span class="nav-number">7.2.</span> <span class="nav-text">6.2． 生成文档id</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-1-%E6%89%8B%E5%8A%A8%E7%94%9F%E6%88%90id"><span class="nav-number">7.2.1.</span> <span class="nav-text">6.2.1 手动生成id</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-2-%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90id"><span class="nav-number">7.2.2.</span> <span class="nav-text">6.2.2 自动生成id</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3%EF%BC%8E-source-%E5%AD%97%E6%AE%B5"><span class="nav-number">7.3.</span> <span class="nav-text">6.3． _source 字段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-1-source"><span class="nav-number">7.3.1.</span> <span class="nav-text">6.3.1 _source</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-2-%E5%AE%9A%E5%88%B6%E8%BF%94%E5%9B%9E%E5%AD%97%E6%AE%B5"><span class="nav-number">7.3.2.</span> <span class="nav-text">6.3.2 定制返回字段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4%EF%BC%8E-%E6%96%87%E6%A1%A3%E7%9A%84%E6%9B%BF%E6%8D%A2%E4%B8%8E%E5%88%A0%E9%99%A4"><span class="nav-number">7.4.</span> <span class="nav-text">6.4． 文档的替换与删除</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-1%E5%85%A8%E9%87%8F%E6%9B%BF%E6%8D%A2"><span class="nav-number">7.4.1.</span> <span class="nav-text">6.4.1全量替换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-2-%E5%BC%BA%E5%88%B6%E5%88%9B%E5%BB%BA"><span class="nav-number">7.4.2.</span> <span class="nav-text">6.4.2 强制创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-3-%E5%88%A0%E9%99%A4"><span class="nav-number">7.4.3.</span> <span class="nav-text">6.4.3 删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5%EF%BC%8E-%E5%B1%80%E9%83%A8%E6%9B%BF%E6%8D%A2-partial-update"><span class="nav-number">7.5.</span> <span class="nav-text">6.5． 局部替换 partial update</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%BE%E8%A7%A3%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86"><span class="nav-number">7.5.0.1.</span> <span class="nav-text">图解内部原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%94%E7%A4%BA"><span class="nav-number">7.5.0.2.</span> <span class="nav-text">演示</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-6%EF%BC%8E-%E4%BD%BF%E7%94%A8%E8%84%9A%E6%9C%AC%E6%9B%B4%E6%96%B0"><span class="nav-number">7.6.</span> <span class="nav-text">6.6． 使用脚本更新</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-1%E5%86%85%E7%BD%AE%E8%84%9A%E6%9C%AC"><span class="nav-number">7.6.1.</span> <span class="nav-text">6.6.1内置脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-2-%E5%A4%96%E9%83%A8%E8%84%9A%E6%9C%AC"><span class="nav-number">7.6.2.</span> <span class="nav-text">6.6.2 外部脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-7%EF%BC%8E-%E5%9B%BE%E8%A7%A3es%E7%9A%84%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="nav-number">7.7.</span> <span class="nav-text">6.7． 图解es的并发问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-8%EF%BC%8E-%E5%9B%BE%E8%A7%A3%E6%82%B2%E8%A7%82%E9%94%81%E4%B8%8E%E4%B9%90%E8%A7%82%E9%94%81%E6%9C%BA%E5%88%B6"><span class="nav-number">7.8.</span> <span class="nav-text">6.8． 图解悲观锁与乐观锁机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-9%EF%BC%8E-%E5%9B%BE%E8%A7%A3es%E5%86%85%E9%83%A8%E5%9F%BA%E4%BA%8E-version%E4%B9%90%E8%A7%82%E9%94%81%E6%8E%A7%E5%88%B6"><span class="nav-number">7.9.</span> <span class="nav-text">6.9． 图解es内部基于_version乐观锁控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E5%9F%BA%E4%BA%8E-version%E7%9A%84%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="nav-number">7.9.0.1.</span> <span class="nav-text">实验基于_version的版本控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%BE%E8%A7%A3es%E5%86%85%E9%83%A8%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="nav-number">7.9.0.2.</span> <span class="nav-text">图解es内部并发控制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-10%EF%BC%8E-%E6%BC%94%E7%A4%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%A8%8B%E5%BA%8F%E5%9F%BA%E4%BA%8E-version%E5%B9%B6%E5%8F%91%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">7.10.</span> <span class="nav-text">6.10． 演示客户端程序基于_version并发操作流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%96%87%E6%A1%A3"><span class="nav-number">7.10.0.1.</span> <span class="nav-text">新建文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF1%E4%BF%AE%E6%94%B9%E3%80%82%E5%B8%A6%E7%89%88%E6%9C%AC%E5%8F%B71%E3%80%82"><span class="nav-number">7.10.0.2.</span> <span class="nav-text">客户端1修改。带版本号1。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF2%E5%B9%B6%E5%8F%91%E4%BF%AE%E6%94%B9%E3%80%82%E5%B8%A6%E7%89%88%E6%9C%AC%E5%8F%B71%E3%80%82"><span class="nav-number">7.10.0.3.</span> <span class="nav-text">客户端2并发修改。带版本号1。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF2%E9%87%8D%E6%96%B0%E6%9F%A5%E8%AF%A2%E3%80%82%E5%BE%97%E5%88%B0%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%E4%B8%BA2%E3%80%82seq-no-22"><span class="nav-number">7.10.0.4.</span> <span class="nav-text">客户端2重新查询。得到最新版本为2。seq_no&#x3D;22</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF2%E5%B9%B6%E5%8F%91%E4%BF%AE%E6%94%B9%E3%80%82%E5%B8%A6%E7%89%88%E6%9C%AC%E5%8F%B72%E3%80%82"><span class="nav-number">7.10.0.5.</span> <span class="nav-text">客户端2并发修改。带版本号2。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-11%EF%BC%8E-%E6%BC%94%E7%A4%BA%E8%87%AA%E5%B7%B1%E6%89%8B%E5%8A%A8%E6%8E%A7%E5%88%B6%E7%89%88%E6%9C%AC%E5%8F%B7-external-version"><span class="nav-number">7.11.</span> <span class="nav-text">6.11． 演示自己手动控制版本号 external version</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%96%87%E6%A1%A3-1"><span class="nav-number">7.11.0.1.</span> <span class="nav-text">新建文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF1%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="nav-number">7.11.0.2.</span> <span class="nav-text">客户端1修改文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF2%E5%90%8C%E6%97%B6%E4%BF%AE%E6%94%B9"><span class="nav-number">7.11.0.3.</span> <span class="nav-text">客户端2同时修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF2%E9%87%8D%E6%96%B0%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="nav-number">7.11.0.4.</span> <span class="nav-text">客户端2重新查询数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF2%E9%87%8D%E6%96%B0%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="nav-number">7.11.0.5.</span> <span class="nav-text">客户端2重新修改数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-12%EF%BC%8E%E6%9B%B4%E6%96%B0%E6%97%B6-retry-on-conflict-%E5%8F%82%E6%95%B0"><span class="nav-number">7.12.</span> <span class="nav-text">6.12．更新时 retry_on_conflict 参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#retry-on-conflict"><span class="nav-number">7.12.0.1.</span> <span class="nav-text">retry_on_conflict</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8E-version%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8"><span class="nav-number">7.12.0.2.</span> <span class="nav-text">与 _version结合使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-13%EF%BC%8E-%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2-mget"><span class="nav-number">7.13.</span> <span class="nav-text">6.13． 批量查询 mget</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mget-%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2%EF%BC%9A"><span class="nav-number">7.13.0.1.</span> <span class="nav-text">mget 批量查询：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8C%E4%B8%80%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2%EF%BC%9A"><span class="nav-number">7.13.0.2.</span> <span class="nav-text">同一索引下批量查询：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E7%A7%8D%E5%86%99%E6%B3%95%EF%BC%9A%E6%90%9C%E7%B4%A2%E5%86%99%E6%B3%95"><span class="nav-number">7.13.0.3.</span> <span class="nav-text">第三种写法：搜索写法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-14%EF%BC%8E-%E6%89%B9%E9%87%8F%E5%A2%9E%E5%88%A0%E6%94%B9-bulk"><span class="nav-number">7.14.</span> <span class="nav-text">6.14． 批量增删改 bulk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-15%EF%BC%8E-%E6%96%87%E6%A1%A3%E6%A6%82%E5%BF%B5%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93"><span class="nav-number">7.15.</span> <span class="nav-text">6.15． 文档概念学习总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7%EF%BC%8E-Java-api-%E5%AE%9E%E7%8E%B0%E6%96%87%E6%A1%A3%E7%AE%A1%E7%90%86"><span class="nav-number">8.</span> <span class="nav-text">7． Java api 实现文档管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-es%E6%8A%80%E6%9C%AF%E7%89%B9%E7%82%B9"><span class="nav-number">8.1.</span> <span class="nav-text">7.1 es技术特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-java-%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-number">8.2.</span> <span class="nav-text">7.2 java 客户端简单获取数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-%E7%BB%93%E5%90%88spring-boot-test%E6%B5%8B%E8%AF%95%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2"><span class="nav-number">8.3.</span> <span class="nav-text">7.3 结合spring-boot-test测试文档查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-%E7%BB%93%E5%90%88spring-boot-test%E6%B5%8B%E8%AF%95%E6%96%87%E6%A1%A3%E6%96%B0%E5%A2%9E"><span class="nav-number">8.4.</span> <span class="nav-text">7.4 结合spring-boot-test测试文档新增</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-5%E7%BB%93%E5%90%88spring-boot-test%E6%B5%8B%E8%AF%95%E6%96%87%E6%A1%A3%E4%BF%AE%E6%94%B9"><span class="nav-number">8.5.</span> <span class="nav-text">7.5结合spring-boot-test测试文档修改</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-6%E7%BB%93%E5%90%88spring-boot-test%E6%B5%8B%E8%AF%95%E6%96%87%E6%A1%A3%E5%88%A0%E9%99%A4"><span class="nav-number">8.6.</span> <span class="nav-text">7.6结合spring-boot-test测试文档删除</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-7%E7%BB%93%E5%90%88spring-boot-test%E6%B5%8B%E8%AF%95%E6%96%87%E6%A1%A3bulk"><span class="nav-number">8.7.</span> <span class="nav-text">7.7结合spring-boot-test测试文档bulk</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8%EF%BC%8E-%E5%9B%BE%E8%A7%A3es%E5%86%85%E9%83%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">9.</span> <span class="nav-text">8． 图解es内部机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1%EF%BC%8E-%E5%9B%BE%E8%A7%A3es%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80"><span class="nav-number">9.1.</span> <span class="nav-text">8.1． 图解es分布式基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-1es%E5%AF%B9%E5%A4%8D%E6%9D%82%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%BA%E5%88%B6%E7%9A%84%E9%80%8F%E6%98%8E%E9%9A%90%E8%97%8F%E7%89%B9%E6%80%A7"><span class="nav-number">9.1.1.</span> <span class="nav-text">8.1.1es对复杂分布式机制的透明隐藏特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-2Elasticsearch%E7%9A%84%E5%9E%82%E7%9B%B4%E6%89%A9%E5%AE%B9%E4%B8%8E%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%AE%B9"><span class="nav-number">9.1.2.</span> <span class="nav-text">8.1.2Elasticsearch的垂直扩容与水平扩容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-3%E5%A2%9E%E5%87%8F%E6%88%96%E5%87%8F%E5%B0%91%E8%8A%82%E7%82%B9%E6%97%B6%E7%9A%84%E6%95%B0%E6%8D%AErebalance"><span class="nav-number">9.1.3.</span> <span class="nav-text">8.1.3增减或减少节点时的数据rebalance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-4master%E8%8A%82%E7%82%B9"><span class="nav-number">9.1.4.</span> <span class="nav-text">8.1.4master节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-5%E8%8A%82%E7%82%B9%E5%AF%B9%E7%AD%89%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="nav-number">9.1.5.</span> <span class="nav-text">8.1.5节点对等的分布式架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2%EF%BC%8E-%E5%9B%BE%E8%A7%A3%E5%88%86%E7%89%87shard%E3%80%81%E5%89%AF%E6%9C%ACreplica%E6%9C%BA%E5%88%B6"><span class="nav-number">9.2.</span> <span class="nav-text">8.2． 图解分片shard、副本replica机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-1shard-amp-replica%E6%9C%BA%E5%88%B6"><span class="nav-number">9.2.1.</span> <span class="nav-text">8.2.1shard&amp;replica机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3%E5%9B%BE%E8%A7%A3%E5%8D%95node%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%9B%E5%BB%BAindex%E6%98%AF%E4%BB%80%E4%B9%88%E6%A0%B7%E5%AD%90%E7%9A%84"><span class="nav-number">9.3.</span> <span class="nav-text">8.3图解单node环境下创建index是什么样子的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4%E5%9B%BE%E8%A7%A32%E4%B8%AAnode%E7%8E%AF%E5%A2%83%E4%B8%8Breplica-shard%E6%98%AF%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8D%E7%9A%84"><span class="nav-number">9.4.</span> <span class="nav-text">8.4图解2个node环境下replica shard是如何分配的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-5%E5%9B%BE%E8%A7%A3%E6%A8%AA%E5%90%91%E6%89%A9%E5%AE%B9"><span class="nav-number">9.5.</span> <span class="nav-text">8.5图解横向扩容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-6-%E5%9B%BE%E8%A7%A3es%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6-master%E9%80%89%E4%B8%BE%EF%BC%8Creplica%E5%AE%B9%E9%94%99%EF%BC%8C%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="nav-number">9.6.</span> <span class="nav-text">8.6 图解es容错机制 master选举，replica容错，数据恢复</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9%EF%BC%8E-%E5%9B%BE%E8%A7%A3%E6%96%87%E6%A1%A3%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">10.</span> <span class="nav-text">9． 图解文档存储机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1%EF%BC%8E-%E6%95%B0%E6%8D%AE%E8%B7%AF%E7%94%B1"><span class="nav-number">10.1.</span> <span class="nav-text">9.1． 数据路由</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-1%E6%96%87%E6%A1%A3%E5%AD%98%E5%82%A8%E5%A6%82%E4%BD%95%E8%B7%AF%E7%94%B1%E5%88%B0%E7%9B%B8%E5%BA%94%E5%88%86%E7%89%87"><span class="nav-number">10.1.1.</span> <span class="nav-text">9.1.1文档存储如何路由到相应分片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-2%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95"><span class="nav-number">10.1.2.</span> <span class="nav-text">9.1.2路由算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-3%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9A-routing-number"><span class="nav-number">10.1.3.</span> <span class="nav-text">9.1.3手动指定 routing number</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-4%E4%B8%BB%E5%88%86%E7%89%87%E6%95%B0%E9%87%8F%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="nav-number">10.1.4.</span> <span class="nav-text">9.1.4主分片数量不可变</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2%EF%BC%8E-%E5%9B%BE%E8%A7%A3%E6%96%87%E6%A1%A3%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9%E5%86%85%E9%83%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">10.2.</span> <span class="nav-text">9.2． 图解文档的增删改内部机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3%EF%BC%8E%E5%9B%BE%E8%A7%A3%E6%96%87%E6%A1%A3%E7%9A%84%E6%9F%A5%E8%AF%A2%E5%86%85%E9%83%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">10.3.</span> <span class="nav-text">9.3．图解文档的查询内部机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-4%EF%BC%8Ebulk-api%E5%A5%87%E7%89%B9%E7%9A%84json%E6%A0%BC%E5%BC%8F"><span class="nav-number">10.4.</span> <span class="nav-text">9.4．bulk api奇特的json格式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10%EF%BC%8E-Mapping%E6%98%A0%E5%B0%84%E5%85%A5%E9%97%A8"><span class="nav-number">11.</span> <span class="nav-text">10． Mapping映射入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1%EF%BC%8E-%E4%BB%80%E4%B9%88%E6%98%AFmapping%E6%98%A0%E5%B0%84"><span class="nav-number">11.1.</span> <span class="nav-text">10.1． 什么是mapping映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2%EF%BC%8E-%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D%E4%B8%8E%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E7%9A%84%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90"><span class="nav-number">11.2.</span> <span class="nav-text">10.2． 精确匹配与全文搜索的对比分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-1-exact-value-%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D"><span class="nav-number">11.2.1.</span> <span class="nav-text">10.2.1 exact value 精确匹配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-2-full-text-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="nav-number">11.2.2.</span> <span class="nav-text">10.2.2 full text 全文检索</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3%EF%BC%8E-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E4%B8%8B%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%BF%AB%E9%80%9F%E6%8F%AD%E7%A7%98"><span class="nav-number">11.3.</span> <span class="nav-text">10.3． 全文检索下倒排索引核心原理快速揭秘</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E8%AF%8D%EF%BC%8C%E5%88%9D%E6%AD%A5%E7%9A%84%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E7%9A%84%E5%BB%BA%E7%AB%8B"><span class="nav-number">11.3.0.1.</span> <span class="nav-text">分词，初步的倒排索引的建立</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%9C%E7%B4%A2"><span class="nav-number">11.3.0.2.</span> <span class="nav-text">搜索</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E5%BB%BA%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="nav-number">11.3.0.3.</span> <span class="nav-text">重建倒排索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E6%96%B0%E6%90%9C%E7%B4%A2"><span class="nav-number">11.3.0.4.</span> <span class="nav-text">重新搜索</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-4-%E5%88%86%E8%AF%8D%E5%99%A8-analyzer"><span class="nav-number">11.4.</span> <span class="nav-text">10.4. 分词器 analyzer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-1%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E8%AF%8D%E5%99%A8-analyzer"><span class="nav-number">11.4.1.</span> <span class="nav-text">10.4.1什么是分词器 analyzer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-2%E5%86%85%E7%BD%AE%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="nav-number">11.4.2.</span> <span class="nav-text">10.4.2内置分词器的介绍</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-5-query-string%E6%A0%B9%E6%8D%AE%E5%AD%97%E6%AE%B5%E5%88%86%E8%AF%8D%E7%AD%96%E7%95%A5"><span class="nav-number">11.5.</span> <span class="nav-text">10.5. query string根据字段分词策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-1query-string%E5%88%86%E8%AF%8D"><span class="nav-number">11.5.1.</span> <span class="nav-text">10.5.1query string分词</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-2%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">11.5.2.</span> <span class="nav-text">10.5.2测试分词器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-6%EF%BC%8E-mapping%E5%9B%9E%E9%A1%BE%E6%80%BB%E7%BB%93"><span class="nav-number">11.6.</span> <span class="nav-text">10.6． mapping回顾总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-7%EF%BC%8E-mapping%E7%9A%84%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8Adynamic-mapping"><span class="nav-number">11.7.</span> <span class="nav-text">10.7． mapping的核心数据类型以及dynamic mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-7-1-%E6%A0%B8%E5%BF%83%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">11.7.1.</span> <span class="nav-text">10.7.1 核心的数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-7-2-dynamic-mapping-%E6%8E%A8%E6%B5%8B%E8%A7%84%E5%88%99"><span class="nav-number">11.7.2.</span> <span class="nav-text">10.7.2 dynamic mapping 推测规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-7-3-%E6%9F%A5%E7%9C%8Bmapping"><span class="nav-number">11.7.3.</span> <span class="nav-text">10.7.3 查看mapping</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-8-%E6%89%8B%E5%8A%A8%E7%AE%A1%E7%90%86mapping"><span class="nav-number">11.8.</span> <span class="nav-text">10.8 手动管理mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-8-1%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95%E7%9A%84%E6%98%A0%E5%B0%84"><span class="nav-number">11.8.1.</span> <span class="nav-text">10.8.1查询所有索引的映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-8-2-%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84-%EF%BC%81%EF%BC%81"><span class="nav-number">11.8.2.</span> <span class="nav-text">10.8.2 创建映射 ！！</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Text-%E6%96%87%E6%9C%AC%E7%B1%BB%E5%9E%8B"><span class="nav-number">11.8.2.1.</span> <span class="nav-text">Text 文本类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#keyword%E5%85%B3%E9%94%AE%E5%AD%97%E5%AD%97%E6%AE%B5"><span class="nav-number">11.8.2.2.</span> <span class="nav-text">keyword关键字字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#date%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B"><span class="nav-number">11.8.2.3.</span> <span class="nav-text">date日期类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E5%80%BC%E7%B1%BB%E5%9E%8B"><span class="nav-number">11.8.2.4.</span> <span class="nav-text">数值类型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-8-3%E4%BF%AE%E6%94%B9%E6%98%A0%E5%B0%84"><span class="nav-number">11.8.3.</span> <span class="nav-text">10.8.3修改映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-8-4%E5%88%A0%E9%99%A4%E6%98%A0%E5%B0%84"><span class="nav-number">11.8.4.</span> <span class="nav-text">10.8.4删除映射</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-9-%E5%A4%8D%E6%9D%82%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">11.9.</span> <span class="nav-text">10.9 复杂数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-9-1-multivalue-field"><span class="nav-number">11.9.1.</span> <span class="nav-text">10.9 .1 multivalue field</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-9-2-empty-field"><span class="nav-number">11.9.2.</span> <span class="nav-text">10.9 .2. empty field</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-9-3-object-field"><span class="nav-number">11.9.3.</span> <span class="nav-text">10.9 .3. object field</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11%EF%BC%8E-%E7%B4%A2%E5%BC%95Index%E5%85%A5%E9%97%A8"><span class="nav-number">12.</span> <span class="nav-text">11． 索引Index入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1%EF%BC%8E-%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="nav-number">12.1.</span> <span class="nav-text">11.1． 索引管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E8%A6%81%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">12.1.1.</span> <span class="nav-text">11.1.1. 为什么我们要手动创建索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-2-%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="nav-number">12.1.2.</span> <span class="nav-text">11.1.2. 索引管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1-2-1-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">12.1.2.1.</span> <span class="nav-text">11.1.2.1 创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1-2-2%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95"><span class="nav-number">12.1.2.2.</span> <span class="nav-text">11.1.2.2查询索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1-2-3%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95"><span class="nav-number">12.1.2.3.</span> <span class="nav-text">11.1.2.3修改索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-1-2-4%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-number">12.1.2.4.</span> <span class="nav-text">11.1.2.4删除索引</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-2%EF%BC%8E-%E5%AE%9A%E5%88%B6%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">12.2.</span> <span class="nav-text">11.2． 定制分词器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-1-%E9%BB%98%E8%AE%A4%E7%9A%84%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">12.2.1.</span> <span class="nav-text">11.2.1 默认的分词器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-2-%E4%BF%AE%E6%94%B9%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="nav-number">12.2.2.</span> <span class="nav-text">11.2.2 修改分词器的设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-3-%E5%AE%9A%E5%88%B6%E5%8C%96%E8%87%AA%E5%B7%B1%E7%9A%84%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">12.2.3.</span> <span class="nav-text">11.2.3 定制化自己的分词器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-3-type%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84%E5%8F%8A%E5%BC%83%E7%94%A8%E5%8E%9F%E5%9B%A0"><span class="nav-number">12.3.</span> <span class="nav-text">11.3 type底层结构及弃用原因</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-1type%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">12.3.1.</span> <span class="nav-text">11.3.1type是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-2es%E4%B8%AD%E4%B8%8D%E5%90%8Ctype%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">12.3.2.</span> <span class="nav-text">11.3.2es中不同type存储机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-3-type%E5%BC%83%E7%94%A8"><span class="nav-number">12.3.3.</span> <span class="nav-text">11.3.3 type弃用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-4-%E5%AE%9A%E5%88%B6dynamic-mapping"><span class="nav-number">12.4.</span> <span class="nav-text">11.4.定制dynamic mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-1%E5%AE%9A%E5%88%B6dynamic%E7%AD%96%E7%95%A5"><span class="nav-number">12.4.1.</span> <span class="nav-text">11.4.1定制dynamic策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-2%E8%87%AA%E5%AE%9A%E4%B9%89-dynamic-mapping%E7%AD%96%E7%95%A5"><span class="nav-number">12.4.2.</span> <span class="nav-text">11.4.2自定义 dynamic mapping策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#date-detection-%E6%97%A5%E6%9C%9F%E6%8E%A2%E6%B5%8B"><span class="nav-number">12.4.2.1.</span> <span class="nav-text">date_detection 日期探测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F"><span class="nav-number">12.4.2.2.</span> <span class="nav-text">自定义日期格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#numeric-detection-%E6%95%B0%E5%AD%97%E6%8E%A2%E6%B5%8B"><span class="nav-number">12.4.2.3.</span> <span class="nav-text">numeric_detection 数字探测</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-3%E5%AE%9A%E5%88%B6%E8%87%AA%E5%B7%B1%E7%9A%84dynamic-mapping-template"><span class="nav-number">12.4.3.</span> <span class="nav-text">11.4.3定制自己的dynamic mapping template</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E5%86%99%E6%B3%95"><span class="nav-number">12.4.3.1.</span> <span class="nav-text">模板写法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF"><span class="nav-number">12.4.3.2.</span> <span class="nav-text">场景</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-5%EF%BC%8E-%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%87%8D%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">12.5.</span> <span class="nav-text">11.5． 零停机重建索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-1%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%87%8D%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-number">12.5.1.</span> <span class="nav-text">11.5.1零停机重建索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-2-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%EF%BC%9A%E5%9F%BA%E4%BA%8Ealias%E5%AF%B9client%E9%80%8F%E6%98%8E%E5%88%87%E6%8D%A2index"><span class="nav-number">12.5.2.</span> <span class="nav-text">11.5.2 生产实践：基于alias对client透明切换index</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#12%EF%BC%8E-%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8-IK%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">13.</span> <span class="nav-text">12． 中文分词器 IK分词器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#12-1%EF%BC%8E-Ik%E5%88%86%E8%AF%8D%E5%99%A8%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8"><span class="nav-number">13.1.</span> <span class="nav-text">12.1． Ik分词器安装使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-1-%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8"><span class="nav-number">13.1.1.</span> <span class="nav-text">12.1.1 中文分词器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-2-%E5%AE%89%E8%A3%85"><span class="nav-number">13.1.2.</span> <span class="nav-text">12.1.2 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-3-ik%E5%88%86%E8%AF%8D%E5%99%A8%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">13.1.3.</span> <span class="nav-text">12.1.3 ik分词器基础知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-4-ik%E5%88%86%E8%AF%8D%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">13.1.4.</span> <span class="nav-text">12.1.4 ik分词器的使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-2-ik%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">13.2.</span> <span class="nav-text">12.2. ik配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-1-ik%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">13.2.1.</span> <span class="nav-text">12.2.1 ik配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-1-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93"><span class="nav-number">13.2.2.</span> <span class="nav-text">12.2.1 自定义词库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-3%EF%BC%8E-%E4%BD%BF%E7%94%A8mysql%E7%83%AD%E6%9B%B4%E6%96%B0-%E8%AF%8D%E5%BA%93"><span class="nav-number">13.3.</span> <span class="nav-text">12.3． 使用mysql热更新 词库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-3-1%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="nav-number">13.3.1.</span> <span class="nav-text">12.3.1热更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-3-2%E6%AD%A5%E9%AA%A4"><span class="nav-number">13.3.2.</span> <span class="nav-text">12.3.2步骤</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#13%EF%BC%8E-java-api-%E5%AE%9E%E7%8E%B0%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="nav-number">14.</span> <span class="nav-text">13． java api 实现索引管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#14%EF%BC%8E-search%E6%90%9C%E7%B4%A2%E5%85%A5%E9%97%A8"><span class="nav-number">15.</span> <span class="nav-text">14． search搜索入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#14-1%EF%BC%8E-%E6%90%9C%E7%B4%A2%E8%AF%AD%E6%B3%95%E5%85%A5%E9%97%A8"><span class="nav-number">15.1.</span> <span class="nav-text">14.1． 搜索语法入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-1-1query-string-search"><span class="nav-number">15.1.1.</span> <span class="nav-text">14.1.1query string search</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-1-2%E4%BC%A0%E5%8F%82"><span class="nav-number">15.1.2.</span> <span class="nav-text">14.1.2传参</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-1-3%E5%9B%BE%E8%A7%A3timeout"><span class="nav-number">15.1.3.</span> <span class="nav-text">14.1.3图解timeout</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-2%EF%BC%8Emulti-index-%E5%A4%9A%E7%B4%A2%E5%BC%95%E6%90%9C%E7%B4%A2"><span class="nav-number">15.2.</span> <span class="nav-text">14.2．multi-index 多索引搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-1multi-index%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%BC%8F"><span class="nav-number">15.2.1.</span> <span class="nav-text">14.2.1multi-index搜索模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-2%E5%88%9D%E6%AD%A5%E5%9B%BE%E8%A7%A3%E4%B8%80%E4%B8%8B%E7%AE%80%E5%8D%95%E7%9A%84%E6%90%9C%E7%B4%A2%E5%8E%9F%E7%90%86"><span class="nav-number">15.2.2.</span> <span class="nav-text">14.2.2初步图解一下简单的搜索原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-3%EF%BC%8E-%E5%88%86%E9%A1%B5%E6%90%9C%E7%B4%A2"><span class="nav-number">15.3.</span> <span class="nav-text">14.3． 分页搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-3-1%E5%88%86%E9%A1%B5%E6%90%9C%E7%B4%A2%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="nav-number">15.3.1.</span> <span class="nav-text">14.3.1分页搜索的语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-3-2deep-paging"><span class="nav-number">15.3.2.</span> <span class="nav-text">14.3.2deep paging</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFdeep-paging"><span class="nav-number">15.3.2.1.</span> <span class="nav-text">什么是deep paging</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#deep-paging-%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="nav-number">15.3.2.2.</span> <span class="nav-text">deep paging 性能问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-4%EF%BC%8E-query-string%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="nav-number">15.4.</span> <span class="nav-text">14.4． query string基础语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-4-1query-string%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="nav-number">15.4.1.</span> <span class="nav-text">14.4.1query string基础语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-4-2%E3%80%81-all-metadata%E7%9A%84%E5%8E%9F%E7%90%86%E5%92%8C%E4%BD%9C%E7%94%A8"><span class="nav-number">15.4.2.</span> <span class="nav-text">14.4.2、_all metadata的原理和作用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-5%EF%BC%8E-query-DSL%E5%85%A5%E9%97%A8"><span class="nav-number">15.5.</span> <span class="nav-text">14.5． query DSL入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-5-1-DSL"><span class="nav-number">15.5.1.</span> <span class="nav-text">14.5.1 DSL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-5-2%EF%BC%8E-Query-DSL%E8%AF%AD%E6%B3%95"><span class="nav-number">15.5.2.</span> <span class="nav-text">14.5.2． Query DSL语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-5-3-%E7%BB%84%E5%90%88%E5%A4%9A%E4%B8%AA%E6%90%9C%E7%B4%A2%E6%9D%A1%E4%BB%B6"><span class="nav-number">15.5.3.</span> <span class="nav-text">14.5.3 组合多个搜索条件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-6%EF%BC%8E-full-text-search-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="nav-number">15.6.</span> <span class="nav-text">14.6． full-text search 全文检索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-6-1-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="nav-number">15.6.1.</span> <span class="nav-text">14.6.1 全文检索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-6-2-score%E5%88%9D%E6%8E%A2"><span class="nav-number">15.6.2.</span> <span class="nav-text">14.6.2 _score初探</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-7%EF%BC%8E-DSL-%E8%AF%AD%E6%B3%95%E7%BB%83%E4%B9%A0"><span class="nav-number">15.7.</span> <span class="nav-text">14.7． DSL 语法练习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-1-match-all"><span class="nav-number">15.7.1.</span> <span class="nav-text">14.7.1 match_all</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-2-match"><span class="nav-number">15.7.2.</span> <span class="nav-text">14.7.2 match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-3-multi-match"><span class="nav-number">15.7.3.</span> <span class="nav-text">14.7.3  multi_match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-4%E3%80%81range-query-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="nav-number">15.7.4.</span> <span class="nav-text">14.7.4、range query 范围查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-5%E3%80%81term-query"><span class="nav-number">15.7.5.</span> <span class="nav-text">14.7.5、term query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-6%E3%80%81terms-query"><span class="nav-number">15.7.6.</span> <span class="nav-text">14.7.6、terms query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-7%E3%80%81exist-query-%E6%9F%A5%E8%AF%A2%E6%9C%89%E6%9F%90%E4%BA%9B%E5%AD%97%E6%AE%B5%E5%80%BC%E7%9A%84%E6%96%87%E6%A1%A3"><span class="nav-number">15.7.7.</span> <span class="nav-text">14.7.7、exist query 查询有某些字段值的文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-8%E3%80%81Fuzzy-query"><span class="nav-number">15.7.8.</span> <span class="nav-text">14.7. 8、Fuzzy query</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-9%E3%80%81IDs"><span class="nav-number">15.7.9.</span> <span class="nav-text">14.7.9、IDs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-10%E3%80%81prefix-%E5%89%8D%E7%BC%80%E6%9F%A5%E8%AF%A2"><span class="nav-number">15.7.10.</span> <span class="nav-text">14.7.10、prefix 前缀查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-7-11%E3%80%81regexp-query-%E6%AD%A3%E5%88%99%E6%9F%A5%E8%AF%A2"><span class="nav-number">15.7.11.</span> <span class="nav-text">14.7.11、regexp query  正则查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-8%EF%BC%8E-Filter"><span class="nav-number">15.8.</span> <span class="nav-text">14.8． Filter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-8-1-filter%E4%B8%8Equery%E7%A4%BA%E4%BE%8B"><span class="nav-number">15.8.1.</span> <span class="nav-text">14.8.1 filter与query示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-8-2-filter%E4%B8%8Equery%E5%AF%B9%E6%AF%94"><span class="nav-number">15.8.2.</span> <span class="nav-text">14.8.2 filter与query对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-8-3-filter%E4%B8%8Equery%E6%80%A7%E8%83%BD"><span class="nav-number">15.8.3.</span> <span class="nav-text">14.8.3 filter与query性能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-9%EF%BC%8E-%E5%AE%9A%E4%BD%8D%E9%94%99%E8%AF%AF%E8%AF%AD%E6%B3%95"><span class="nav-number">15.9.</span> <span class="nav-text">14.9． 定位错误语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-10%EF%BC%8E-%E5%AE%9A%E5%88%B6%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99"><span class="nav-number">15.10.</span> <span class="nav-text">14.10． 定制排序规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-10-1-%E9%BB%98%E8%AE%A4%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99"><span class="nav-number">15.10.1.</span> <span class="nav-text">14.10.1 默认排序规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-10-2-%E5%AE%9A%E5%88%B6%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99"><span class="nav-number">15.10.2.</span> <span class="nav-text">14.10.2 定制排序规则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-11%EF%BC%8E-Text%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="nav-number">15.11.</span> <span class="nav-text">14.11． Text字段排序问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-12%EF%BC%8E-Scroll%E5%88%86%E6%89%B9%E6%9F%A5%E8%AF%A2"><span class="nav-number">15.11.1.</span> <span class="nav-text">14.12． Scroll分批查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#15%EF%BC%8E-java-api%E5%AE%9E%E7%8E%B0%E6%90%9C%E7%B4%A2"><span class="nav-number">16.</span> <span class="nav-text">15． java api实现搜索</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#16%EF%BC%8E-%E8%AF%84%E5%88%86%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3"><span class="nav-number">17.</span> <span class="nav-text">16． 评分机制详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#16-1%EF%BC%8E-%E8%AF%84%E5%88%86%E6%9C%BA%E5%88%B6-TF-IDF"><span class="nav-number">17.1.</span> <span class="nav-text">16.1． 评分机制 TF\IDF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#16-1-1-%E7%AE%97%E6%B3%95%E4%BB%8B%E7%BB%8D"><span class="nav-number">17.1.1.</span> <span class="nav-text">16.1.1 算法介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-1-2-score%E6%98%AF%E5%A6%82%E4%BD%95%E8%A2%AB%E8%AE%A1%E7%AE%97%E5%87%BA%E6%9D%A5%E7%9A%84"><span class="nav-number">17.1.2.</span> <span class="nav-text">16.1.2 _score是如何被计算出来的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-1-3-%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%AAdocument%E6%98%AF%E5%A6%82%E4%BD%95%E8%A2%AB%E5%8C%B9%E9%85%8D%E4%B8%8A%E7%9A%84"><span class="nav-number">17.1.3.</span> <span class="nav-text">16.1.3 分析一个document是如何被匹配上的</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-2%EF%BC%8E-Doc-value"><span class="nav-number">17.2.</span> <span class="nav-text">16.2． Doc value</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-3%EF%BC%8E-query-phase"><span class="nav-number">17.3.</span> <span class="nav-text">16.3． query phase</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81query-phase"><span class="nav-number">17.3.1.</span> <span class="nav-text">1、query phase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81replica-shard%E5%A6%82%E4%BD%95%E6%8F%90%E5%8D%87%E6%90%9C%E7%B4%A2%E5%90%9E%E5%90%90%E9%87%8F"><span class="nav-number">17.3.2.</span> <span class="nav-text">2、replica shard如何提升搜索吞吐量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-4%EF%BC%8E-fetch-phase"><span class="nav-number">17.4.</span> <span class="nav-text">16.4． fetch phase</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81fetch-phbase%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">17.4.1.</span> <span class="nav-text">1、fetch phbase工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E4%B8%80%E8%88%AC%E6%90%9C%E7%B4%A2%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%8A%A0from%E5%92%8Csize%EF%BC%8C%E5%B0%B1%E9%BB%98%E8%AE%A4%E6%90%9C%E7%B4%A2%E5%89%8D10%E6%9D%A1%EF%BC%8C%E6%8C%89%E7%85%A7-score%E6%8E%92%E5%BA%8F"><span class="nav-number">17.4.2.</span> <span class="nav-text">2、一般搜索，如果不加from和size，就默认搜索前10条，按照_score排序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-5%EF%BC%8E-%E6%90%9C%E7%B4%A2%E5%8F%82%E6%95%B0%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="nav-number">17.5.</span> <span class="nav-text">16.5． 搜索参数小总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81preference"><span class="nav-number">17.5.1.</span> <span class="nav-text">1、preference</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81timeout"><span class="nav-number">17.5.2.</span> <span class="nav-text">2、timeout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81routing"><span class="nav-number">17.5.3.</span> <span class="nav-text">3、routing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81search-type"><span class="nav-number">17.5.4.</span> <span class="nav-text">4、search_type</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#17%EF%BC%8E-%E8%81%9A%E5%90%88%E5%85%A5%E9%97%A8"><span class="nav-number">18.</span> <span class="nav-text">17． 聚合入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#17-1%E8%81%9A%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="nav-number">18.1.</span> <span class="nav-text">17.1聚合示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#17-1-1%E9%9C%80%E6%B1%82%EF%BC%9A%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAstudymodel%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E6%95%B0%E9%87%8F"><span class="nav-number">18.1.1.</span> <span class="nav-text">17.1.1需求：计算每个studymodel下的商品数量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-1-2-%E9%9C%80%E6%B1%82%EF%BC%9A%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAtags%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E6%95%B0%E9%87%8F"><span class="nav-number">18.1.2.</span> <span class="nav-text">17.1.2 需求：计算每个tags下的商品数量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-1-3-%E9%9C%80%E6%B1%82%EF%BC%9A%E5%8A%A0%E4%B8%8A%E6%90%9C%E7%B4%A2%E6%9D%A1%E4%BB%B6%EF%BC%8C%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAtags%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E6%95%B0%E9%87%8F"><span class="nav-number">18.1.3.</span> <span class="nav-text">17.1.3 需求：加上搜索条件，计算每个tags下的商品数量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-1-4-%E9%9C%80%E6%B1%82%EF%BC%9A%E5%85%88%E5%88%86%E7%BB%84%EF%BC%8C%E5%86%8D%E7%AE%97%E6%AF%8F%E7%BB%84%E7%9A%84%E5%B9%B3%E5%9D%87%E5%80%BC%EF%BC%8C%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAtag%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E7%9A%84%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="nav-number">18.1.4.</span> <span class="nav-text">17.1.4 需求：先分组，再算每组的平均值，计算每个tag下的商品的平均价格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-1-5-%E9%9C%80%E6%B1%82%EF%BC%9A%E8%AE%A1%E7%AE%97%E6%AF%8F%E4%B8%AAtag%E4%B8%8B%E7%9A%84%E5%95%86%E5%93%81%E7%9A%84%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC%EF%BC%8C%E5%B9%B6%E4%B8%94%E6%8C%89%E7%85%A7%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC%E9%99%8D%E5%BA%8F%E6%8E%92%E5%BA%8F"><span class="nav-number">18.1.5.</span> <span class="nav-text">17.1.5 需求：计算每个tag下的商品的平均价格，并且按照平均价格降序排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-1-6-%E9%9C%80%E6%B1%82%EF%BC%9A%E6%8C%89%E7%85%A7%E6%8C%87%E5%AE%9A%E7%9A%84%E4%BB%B7%E6%A0%BC%E8%8C%83%E5%9B%B4%E5%8C%BA%E9%97%B4%E8%BF%9B%E8%A1%8C%E5%88%86%E7%BB%84%EF%BC%8C%E7%84%B6%E5%90%8E%E5%9C%A8%E6%AF%8F%E7%BB%84%E5%86%85%E5%86%8D%E6%8C%89%E7%85%A7tag%E8%BF%9B%E8%A1%8C%E5%88%86%E7%BB%84%EF%BC%8C%E6%9C%80%E5%90%8E%E5%86%8D%E8%AE%A1%E7%AE%97%E6%AF%8F%E7%BB%84%E7%9A%84%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="nav-number">18.1.6.</span> <span class="nav-text">17.1.6 需求：按照指定的价格范围区间进行分组，然后在每组内再按照tag进行分组，最后再计算每组的平均价格</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-2%E4%B8%A4%E4%B8%AA%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%EF%BC%9Abucket%E5%92%8Cmetric"><span class="nav-number">18.2.</span> <span class="nav-text">17.2两个核心概念：bucket和metric</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#17-2-1-bucket%EF%BC%9A%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%88%86%E7%BB%84"><span class="nav-number">18.2.1.</span> <span class="nav-text">17.2.1 bucket：一个数据分组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-2-2metric%EF%BC%9A%E5%AF%B9%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%88%86%E7%BB%84%E6%89%A7%E8%A1%8C%E7%9A%84%E7%BB%9F%E8%AE%A1"><span class="nav-number">18.2.2.</span> <span class="nav-text">17.2.2metric：对一个数据分组执行的统计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-3-%E7%94%B5%E8%A7%86%E6%A1%88%E4%BE%8B"><span class="nav-number">18.3.</span> <span class="nav-text">17.3 电视案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%821-%E7%BB%9F%E8%AE%A1%E5%93%AA%E7%A7%8D%E9%A2%9C%E8%89%B2%E7%9A%84%E7%94%B5%E8%A7%86%E9%94%80%E9%87%8F%E6%9C%80%E9%AB%98"><span class="nav-number">18.3.1.</span> <span class="nav-text">需求1 统计哪种颜色的电视销量最高</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%822-%E7%BB%9F%E8%AE%A1%E6%AF%8F%E7%A7%8D%E9%A2%9C%E8%89%B2%E7%94%B5%E8%A7%86%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="nav-number">18.3.2.</span> <span class="nav-text">需求2 统计每种颜色电视平均价格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%823-%E7%BB%A7%E7%BB%AD%E4%B8%8B%E9%92%BB%E5%88%86%E6%9E%90"><span class="nav-number">18.3.3.</span> <span class="nav-text">需求3 继续下钻分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%824%EF%BC%9A%E6%9B%B4%E5%A4%9A%E7%9A%84metric"><span class="nav-number">18.3.4.</span> <span class="nav-text">需求4：更多的metric</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%825%EF%BC%9A%E5%88%92%E5%88%86%E8%8C%83%E5%9B%B4-histogram"><span class="nav-number">18.3.5.</span> <span class="nav-text">需求5：划分范围 histogram</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%826%EF%BC%9A%E6%8C%89%E7%85%A7%E6%97%A5%E6%9C%9F%E5%88%86%E7%BB%84%E8%81%9A%E5%90%88"><span class="nav-number">18.3.6.</span> <span class="nav-text">需求6：按照日期分组聚合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%827-%E7%BB%9F%E8%AE%A1%E6%AF%8F%E5%AD%A3%E5%BA%A6%E6%AF%8F%E4%B8%AA%E5%93%81%E7%89%8C%E7%9A%84%E9%94%80%E5%94%AE%E9%A2%9D"><span class="nav-number">18.3.7.</span> <span class="nav-text">需求7 统计每季度每个品牌的销售额</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%828-%EF%BC%9A%E6%90%9C%E7%B4%A2%E4%B8%8E%E8%81%9A%E5%90%88%E7%BB%93%E5%90%88%EF%BC%8C%E6%9F%A5%E8%AF%A2%E6%9F%90%E4%B8%AA%E5%93%81%E7%89%8C%E6%8C%89%E9%A2%9C%E8%89%B2%E9%94%80%E9%87%8F"><span class="nav-number">18.3.8.</span> <span class="nav-text">需求8 ：搜索与聚合结合，查询某个品牌按颜色销量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%829-global-bucket%EF%BC%9A%E5%8D%95%E4%B8%AA%E5%93%81%E7%89%8C%E4%B8%8E%E6%89%80%E6%9C%89%E5%93%81%E7%89%8C%E9%94%80%E9%87%8F%E5%AF%B9%E6%AF%94"><span class="nav-number">18.3.9.</span> <span class="nav-text">需求9 global bucket：单个品牌与所有品牌销量对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%8210%EF%BC%9A%E8%BF%87%E6%BB%A4-%E8%81%9A%E5%90%88%EF%BC%9A%E7%BB%9F%E8%AE%A1%E4%BB%B7%E6%A0%BC%E5%A4%A7%E4%BA%8E1200%E7%9A%84%E7%94%B5%E8%A7%86%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="nav-number">18.3.10.</span> <span class="nav-text">需求10：过滤+聚合：统计价格大于1200的电视平均价格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%8211-bucket-filter%EF%BC%9A%E7%BB%9F%E8%AE%A1%E5%93%81%E7%89%8C%E6%9C%80%E8%BF%91%E4%B8%80%E4%B8%AA%E6%9C%88%E7%9A%84%E5%B9%B3%E5%9D%87%E4%BB%B7%E6%A0%BC"><span class="nav-number">18.3.11.</span> <span class="nav-text">需求11 bucket filter：统计品牌最近一个月的平均价格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%8212-%E6%8E%92%E5%BA%8F%EF%BC%9A%E6%8C%89%E6%AF%8F%E7%A7%8D%E9%A2%9C%E8%89%B2%E7%9A%84%E5%B9%B3%E5%9D%87%E9%94%80%E5%94%AE%E9%A2%9D%E9%99%8D%E5%BA%8F%E6%8E%92%E5%BA%8F"><span class="nav-number">18.3.12.</span> <span class="nav-text">需求12 排序：按每种颜色的平均销售额降序排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%8213-%E6%8E%92%E5%BA%8F%EF%BC%9A%E6%8C%89%E6%AF%8F%E7%A7%8D%E9%A2%9C%E8%89%B2%E7%9A%84%E6%AF%8F%E7%A7%8D%E5%93%81%E7%89%8C%E5%B9%B3%E5%9D%87%E9%94%80%E5%94%AE%E9%A2%9D%E9%99%8D%E5%BA%8F%E6%8E%92%E5%BA%8F"><span class="nav-number">18.3.13.</span> <span class="nav-text">需求13 排序：按每种颜色的每种品牌平均销售额降序排序</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#18%EF%BC%8E-java-api%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="nav-number">19.</span> <span class="nav-text">18． java api实现聚合</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#19%EF%BC%8E-es7-sql%E6%96%B0%E7%89%B9%E6%80%A7"><span class="nav-number">20.</span> <span class="nav-text">19． es7 sql新特性</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#19-1-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number">20.1.</span> <span class="nav-text">19.1 快速入门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-2%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">20.2.</span> <span class="nav-text">19.2启动方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-3%E6%98%BE%E7%A4%BA%E6%96%B9%E5%BC%8F"><span class="nav-number">20.3.</span> <span class="nav-text">19.3显示方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-4-sql-%E7%BF%BB%E8%AF%91"><span class="nav-number">20.4.</span> <span class="nav-text">19.4 sql 翻译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-5-%E4%B8%8E%E5%85%B6%E4%BB%96DSL%E7%BB%93%E5%90%88"><span class="nav-number">20.5.</span> <span class="nav-text">19.5 与其他DSL结合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-6-java-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0sql%E5%8A%9F%E8%83%BD"><span class="nav-number">20.6.</span> <span class="nav-text">19.6 java 代码实现sql功能</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#20%EF%BC%8E-Logstash%E5%AD%A6%E4%B9%A0"><span class="nav-number">21.</span> <span class="nav-text">20． Logstash学习</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#20-1Logstash%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95%E7%BB%84%E6%88%90"><span class="nav-number">21.1.</span> <span class="nav-text">20.1Logstash基本语法组成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E4%BB%80%E4%B9%88%E6%98%AFLogstash"><span class="nav-number">21.1.1.</span> <span class="nav-text">1什么是Logstash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="nav-number">21.1.2.</span> <span class="nav-text">2配置文件：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E5%90%AF%E5%8A%A8%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="nav-number">21.1.3.</span> <span class="nav-text">3启动操作：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20-2-Logstash%E8%BE%93%E5%85%A5%E6%8F%92%E4%BB%B6%EF%BC%88input%EF%BC%89"><span class="nav-number">21.2.</span> <span class="nav-text">20.2 Logstash输入插件（input）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E6%A0%87%E5%87%86%E8%BE%93%E5%85%A5-Stdin"><span class="nav-number">21.2.1.</span> <span class="nav-text">1、标准输入(Stdin)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6-File"><span class="nav-number">21.2.2.</span> <span class="nav-text">2、读取文件(File)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E8%AF%BB%E5%8F%96TCP%E7%BD%91%E7%BB%9C%E6%95%B0%E6%8D%AE"><span class="nav-number">21.2.3.</span> <span class="nav-text">3、读取TCP网络数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20-3-Logstash%E8%BF%87%E6%BB%A4%E5%99%A8%E6%8F%92%E4%BB%B6-Filter"><span class="nav-number">21.3.</span> <span class="nav-text">20.3 Logstash过滤器插件(Filter)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#20-13-1Grok-%E6%AD%A3%E5%88%99%E6%8D%95%E8%8E%B7"><span class="nav-number">21.3.1.</span> <span class="nav-text">20.13.1Grok 正则捕获</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-13-2%E6%97%B6%E9%97%B4%E5%A4%84%E7%90%86-Date"><span class="nav-number">21.3.2.</span> <span class="nav-text">20.13.2时间处理(Date)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-13-3%E3%80%81%E6%95%B0%E6%8D%AE%E4%BF%AE%E6%94%B9-Mutate"><span class="nav-number">21.3.3.</span> <span class="nav-text">20.13.3、数据修改(Mutate)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%9B%BF%E6%8D%A2%E5%8C%B9%E9%85%8D%E5%AD%97%E6%AE%B5"><span class="nav-number">21.3.3.1.</span> <span class="nav-text">（1）正则表达式替换匹配字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%88%86%E9%9A%94%E7%AC%A6%E5%88%86%E5%89%B2%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%BA%E6%95%B0%E7%BB%84"><span class="nav-number">21.3.3.2.</span> <span class="nav-text">（2）分隔符分割字符串为数组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E9%87%8D%E5%91%BD%E5%90%8D%E5%AD%97%E6%AE%B5"><span class="nav-number">21.3.3.3.</span> <span class="nav-text">（3）重命名字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E5%88%A0%E9%99%A4%E5%AD%97%E6%AE%B5"><span class="nav-number">21.3.3.4.</span> <span class="nav-text">（4）删除字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%885%EF%BC%89GeoIP-%E5%9C%B0%E5%9D%80%E6%9F%A5%E8%AF%A2%E5%BD%92%E7%B1%BB"><span class="nav-number">21.3.3.5.</span> <span class="nav-text">（5）GeoIP 地址查询归类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%BC%E5%90%88%E4%BE%8B%E5%AD%90%EF%BC%9A"><span class="nav-number">21.3.3.6.</span> <span class="nav-text">综合例子：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20-4-Logstash%E8%BE%93%E5%87%BA%E6%8F%92%E4%BB%B6%EF%BC%88output%EF%BC%89"><span class="nav-number">21.4.</span> <span class="nav-text">20.4 Logstash输出插件（output）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20-5-%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B"><span class="nav-number">21.5.</span> <span class="nav-text">20.5 综合案例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#21%EF%BC%8E-kibana%E5%AD%A6%E4%B9%A0"><span class="nav-number">22.</span> <span class="nav-text">21． kibana学习</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#21-1%E5%9F%BA%E6%9C%AC%E6%9F%A5%E8%AF%A2"><span class="nav-number">22.1.</span> <span class="nav-text">21.1基本查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#21-2-%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">22.2.</span> <span class="nav-text">21.2 可视化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#21-3-%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="nav-number">22.3.</span> <span class="nav-text">21.3 仪表盘</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#21-4-%E4%BD%BF%E7%94%A8%E6%A8%A1%E6%9D%BF%E6%95%B0%E6%8D%AE%E6%8C%87%E5%AF%BC%E7%BB%98%E5%9B%BE"><span class="nav-number">22.4.</span> <span class="nav-text">21.4 使用模板数据指导绘图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#21-5-%E5%85%B6%E4%BB%96%E5%8A%9F%E8%83%BD"><span class="nav-number">22.5.</span> <span class="nav-text">21.5 其他功能</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#22%EF%BC%8E-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">23.</span> <span class="nav-text">22． 集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E7%82%B9%E7%9A%84%E4%B8%89%E4%B8%AA%E8%A7%92%E8%89%B2"><span class="nav-number">23.0.1.</span> <span class="nav-text">结点的三个角色</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#23%EF%BC%8E-%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="nav-number">24.</span> <span class="nav-text">23． 项目实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#23-1%E9%A1%B9%E7%9B%AE%E4%B8%80%EF%BC%9AELK%E7%94%A8%E4%BA%8E%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-number">24.1.</span> <span class="nav-text">23.1项目一：ELK用于日志分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#23-2%E9%A1%B9%E7%9B%AE%E4%BA%8C%EF%BC%9A%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E7%AB%99%E5%86%85%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%9D%97"><span class="nav-number">24.2.</span> <span class="nav-text">23.2项目二：学成在线站内搜索模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1mysql%E5%AF%BC%E5%85%A5course-pub%E8%A1%A8"><span class="nav-number">24.2.1.</span> <span class="nav-text">1mysql导入course_pub表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95xc-course"><span class="nav-number">24.2.2.</span> <span class="nav-text">2创建索引xc_course</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="nav-number">24.2.3.</span> <span class="nav-text">3创建映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4logstash%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6"><span class="nav-number">24.2.4.</span> <span class="nav-text">4logstash创建模板文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5logstash%E9%85%8D%E7%BD%AEmysql-conf"><span class="nav-number">24.2.5.</span> <span class="nav-text">5logstash配置mysql.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%E5%90%AF%E5%8A%A8"><span class="nav-number">24.2.6.</span> <span class="nav-text">6启动</span></a></li></ol></li></ol></li></ol></div>
      </div>
      
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="白都"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">白都</p>
  <div class="site-description" itemprop="description">这是我的个人知识技术总结博客，欢迎大家的到来，博客会慢慢更新。 ------------有问题请通过邮箱2653751429@qq.com联系，评论功能是不会开启的。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
          
  <div id="sidebar-dimmer"></div>
  


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">白都</span>
</div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="true"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  

    </div>
</body>
</html>
